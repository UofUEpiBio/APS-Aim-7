---
title: "APS Aim 7 Derived Variables Summary"
output:
  github_document:
    toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Libraries
library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')

## Get support functions
source('support_functions.R')

## Load data from N=500 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load(file = '../aps-data/20250731_data.RData')
```

```{r, echo = FALSE}
# Source variable derivation code
source("R/queried-vars.R")
```

## Missing Record Data

There should be records for 500 patients in the dataset. However, for certain events appear to be missing data for one patient. When I filter the data for `event_label == "Daily In-Hospital Forms"`, which has values for the variables we are using, the result has 499 rows, not 500. Other events, such as `event_label == "Day 0"` have 500 rows, so the patient is included in some events but not this one. There may be other events that are missing as well that I didn't check.

Here is the patient record missing the "Daily In-Hospital Forms" event:

```{r}
ihf_data <- filter(data, event_label == 'Daily In-Hospital Forms')
d0_data <- filter(data, event_label == 'Day 0')
anti_join(d0_data, ihf_data, by="record_id") |>
  select(record_id) |>
  gt()
```

Given that this patient is missing, the totals for the derived variables below come to 499 instead of 500.

### Query Response
> When there is no record for a record id-event pair, it means that no data had been entered for that pair (and no such record exists). However, all participants should have the "Daily In-Hospital Forms" event. I believe this participant was the one we identified as being erroneously included in the N=500 data set and will be omitted in the final N=500 data set. Of course, this participant will appear in subsequent data sets assuming they do not withdraw by the withdrawal cut-off.


## Neuromuscular Blockade -- Systematic DAG

**Variable Definition:**

- 0 = No neuromuscular blockade on Day 0 or not applicable
- 1 = Neuromuscular blockade given on Day 0

**Summary:**

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(sys_nmblockade_0 = calc_sys_nmblockade_0(
    daily_paralysis_0 = daily_paralysis_0,
    trx_0 = trx_0
  )) |>
  count(sys_nmblockade_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Missingness Report

The branching logic for `daily_paralysis_0` states that if the variable `trx_0 == "Available"`, then `daily_paralysis_0` should be present. If `trx_0 == "Not Available"`, then `daily_paralysis_0` will be missing (NA). `trx_0` has no associated branching logic and thus should always have one of those two values.

Thus, according to the branching logic, these records were incorrectly missing `daily_paralysis_0`:
```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_paralysis_0) & (trx_0 %in% c('Available', NA))) |>
  mutate(missingness = case_when(
    trx_0 == 'Available' ~ 'By branching logic, "daily_paralysis_0" should have a value',
    is.na(trx_0) ~ '"trx_0" is also missing'
  )) |>
  select(record_id, daily_paralysis_0, trx_0, missingness) |>
  gt()
```

#### Query Response
> This is likely missing because data were not entered for daily paralysis even though it should have been entered. Although we have many data quality rules and coordinators fix many problems, we are not at 100% (and likely will never be, meaning that this kind of missingness should be considered in the analysis).

Matt then asked two people to look at these (and the other missing values below) to see if there should be additional data quality rules.

#### Valid NA Values

These records were missing `daily_paralysis_0`, but this was considered valid (e.g., "Not Applicable") by the branching logic of `trx_0 == 'Not Available'`. Thus, they were set to `sys_nmblockade_0 = 0` according to the variable definition. However, as we are unsure what `trx_0` represents and why it would be marked "Not Available", we've included those records for completeness.

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_paralysis_0) & (trx_0 == 'Not Available')) |>
  select(record_id, daily_paralysis_0, trx_0) |>
  gt()
```

##### Query Response
> Agree it seems suspicious that no in-hospital treatments would be available on day 0, even if the participant died shortly after enrollment.


## Neuromuscular Blockade -- Streamlined DAG

Currently calculated the same as the Systematic DAG Neuromuscular Blockade (see above).


## Inflammatory Profile -- Streamlined DAG

**Variable Definition:**

- 0 = Day 0 CRP not checked
- 1 = Day 0 CRP checked and < 15
- 2 = Day 0 CRP checked and ≥ 15

**Summary:**

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(str_inflamprofile_0 = calc_str_inflamprofile_0(
    daily_crp_8a_0 = daily_crp_8a_0,
    daily_crp_nc_0 = daily_crp_nc_0
  )) |>
  count(str_inflamprofile_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Missingness Report

This variable is computed from the paired variables `daily_crp_8a_0` and `daily_crp_nc_0`. The `*_nc_*` suffix indicates "not collected", while the `*_8a_*` suffix contains the value of the measurement. The branching logic for this pair makes them mutually exclusive. Thus, if one variable is present, the other should be missing (NA).

According to the branching logic, these records were incorrectly missing both `daily_crp_8a_0` and `daily_crp_nc_0`:

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_crp_8a_0) & is.na(daily_crp_nc_0)) |>
  select(record_id, daily_crp_8a_0, daily_crp_nc_0) |>
  gt()
```

#### Query Response
> Again, this is likely missing because data were not entered even though they should have been entered.

## Inflammatory Profile -- Systematic DAG

**Variable Definition:**

Four variables, one for each element:

1. `crp_0`
  - 0 = Day 0 CRP not checked
  - 1 = Day 0 CRP checked and < 15
  - 2 = Day 0 CRP checked and ≥ 15
2. `ferritin_0`
  - 0 = Day 0 Ferritin not checked
  - 1 = Day 0 Ferritin checked and < 700
  - 2 = Day 0 Ferritin checked and ≥ 700
3. `fibrinogen_0`
  - 0 = Day 0 Fibrinogen not checked
  - 1 = Day 0 Fibrinogen checked and < 150
  - 2 = Day 0 Fibrinogen checked and ≥ 150
4. `ddimer_0`
  - 0 = Day 0 D-dimer not checked
  - 1 = Day 0 D-dimer checked and < 1500
  - 2 = Day 0 D-dimer checked and ≥ 1500

**Summary:**

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(crp_0 = calc_crp_0(daily_crp_8a_0, daily_crp_nc_0)) |>
  mutate(ferritin_0 = calc_ferritin_0(daily_ferritin_8a_0, daily_ferritin_nc_0)) |>
  mutate(fibrinogen_0 = calc_fibrinogen_0(daily_fibrinogen_8a_0, daily_fibrinogen_nc_0)) |>
  mutate(ddimer_0 = calc_ddimer_0(daily_ddimer_8a_0, daily_ddimer_nc_0)) |>
  pivot_longer(
    cols = c(crp_0, ferritin_0, fibrinogen_0, ddimer_0),
    names_to = "variable",
    values_to = "level"
  ) |>
  count(variable, level) |>
  pivot_wider(
    names_from = level,
    values_from = n
  ) |>
  mutate(Total = rowSums(across(where(is.numeric)))) |>
  gt() |>
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = list(
      cells_body(columns = Total),
      cells_column_labels(columns = Total)
    )
  )
```

### Missingness Report

Each variable is computed from a pair of variables `daily_<element_name>_8a_0` and `daily_<element_name>_nc_0` (e.g., `daily_crp_8a_0` and `daily_crp_nc_0`). The `*_nc_*` suffix indicates "not collected", while the `*_8a_*` suffix contains the value of the measurement. The branching logic makes each pair mutually exclusive. Thus, if one variable in the pair is present, the other should be missing (NA).

According to the branching logic, these records were incorrectly missing both `daily_crp_8a_0` and `daily_crp_nc_0` (same list as for the streamlined DAG inflammatory profile variable above):

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_crp_8a_0) & is.na(daily_crp_nc_0)) |>
  select(record_id, daily_crp_8a_0, daily_crp_nc_0) |>
  gt()
```

These records were incorrectly missing both `daily_ferritin_8a_0` and `daily_ferritin_nc_0`:

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_ferritin_8a_0) & is.na(daily_ferritin_nc_0)) |>
  select(record_id, daily_ferritin_8a_0, daily_ferritin_nc_0) |>
  gt()
```

These records were incorrectly missing both `daily_fibrinogen_8a_0` and `daily_fibrinogen_nc_0`:

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_fibrinogen_8a_0) & is.na(daily_fibrinogen_nc_0)) |>
  select(record_id, daily_fibrinogen_8a_0, daily_fibrinogen_nc_0) |>
  gt()
```

These records were incorrectly missing both `daily_ddimer_8a_0` and `daily_ddimer_nc_0`:

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_ddimer_8a_0) & is.na(daily_ddimer_nc_0)) |>
  select(record_id, daily_ddimer_8a_0, daily_ddimer_nc_0) |>
  gt()
```

#### Query Response
> Again, this is likely missing because data were not entered even though they should have been entered.




## Respiratory Failure Severity -- Systematic DAG

### Variable 1: Type of support

**Variable Definition:**

- 1 = No Oxygen
- 2 = Standard Flow
- 3 = HFNC
- 4 = NIV
- 5 = (IMV AND PEEP < 12) but NOT ECMO
- 6 = (IMV AND PEEP ≥ 12) OR ECMO
- 99 = Unknown

**Summary:**

```{r}
data_with_sysrespfail_var1 <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  left_join(
    get_code_label_map('daily_resp_8a_0', dictionary),
    by ='daily_resp_8a_0'
    ) |>
  mutate(resp_support_type_0 = calc_resp_support_type_0(
    daily_resp_8a_0_code = daily_resp_8a_0_code,
    dailysofa_perf_0 = dailysofa_perf_0,
    daily_standard_flow_8a_0 = daily_standard_flow_8a_0,
    daily_hfnc_fi02_8a_0 = daily_hfnc_fi02_8a_0,
    daily_niv_fi02_8a_0 = daily_niv_fi02_8a_0,
    daily_imv_fio2_8a_0 = daily_imv_fio2_8a_0,
    daily_epap_8a_0 = daily_epap_8a_0
  ))

data_with_sysrespfail_var1 |>
  count(resp_support_type_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### Unknown Values

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" - "6" and having "Unknown" for either `daily_resp_8a_0`:

```{r}
data_with_sysrespfail_var1 |>
  filter(resp_support_type_0 == 99) |>
  select(
    record_id,
    daily_resp_8a_0_code,
    daily_resp_8a_0
    ) |>
  gt()
```


#### Missing Values

These records couldn't be defined due to invalid branching logic.

When respiratory support type is "Invasive mechanical ventilation without ECMO" (`daily_resp_8a_0_code == 3`), the branching logic expects values for `daily_imv_mode_8a_0` and `daily_epap_8a_0`.

When support type is "Non-invasive ventilation" (`daily_resp_8a_0_code == 4`), the branching logic expects a value for `daily_niv_fi02_8a_0`.

These records are missing one or both of those expected values:

```{r}
data_with_sysrespfail_var1 |>
  filter(is.na(resp_support_type_0)) |>
  select(
    record_id,
    daily_resp_8a_0_code,
    daily_resp_8a_0,
    daily_imv_mode_8a_0,
    daily_epap_8a_0,
    daily_niv_fi02_8a_0
    ) |>
  gt() |>
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "red")
    ),
    locations = cells_body(
      columns = daily_niv_fi02_8a_0,
      rows = daily_resp_8a_0_code == 4
    )
  ) |>
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "red")
    ),
    locations = cells_body(
      columns = c(daily_imv_mode_8a_0, daily_epap_8a_0),
      rows = daily_resp_8a_0_code == 3
    )
  )
```


#### "Valid" Missing Values

One record was missing `daily_resp_8a_0`, but this was satisfied by the branching logic with `dailysofa_perf_0 == 'Not Available'`. Thus, `resp_support_type_0` was set to "1" (no oxygen/not applicable) according to the variable definition, but due to missing measurements couldn't be defined under Variable 2 (below).

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  left_join(
    get_code_label_map('daily_resp_8a_0', dictionary),
    by ='daily_resp_8a_0'
    ) |>
  filter(is.na(daily_resp_8a_0)) |>
  select(record_id, dailysofa_perf_0, daily_resp_8a_0) |>
  gt()
```

### Variable 2: S/F Ratio Closest to 8am

**Variable Definition:**

Calculated using one of 3 options dependent on Variable #1 (type of support):

- If Variable 1 = 3, 4, 5, 6 -> [8a SpO2]/[8a FiO2]
- If Variable 1 = 2 -> [8a SpO2]/[0.21 + (0.03 * 8a O2 flow)]
- If Variable 1 = 1 -> [8a SpO2]/[0.21]

Note, if the patient is on ECMO but NOT on IMV, the S/F ratio cannot be calculated due to no Fi02 measurement and is set to missing (NA). No records in this dataset have this condition, but it may arise in future datasets. If it does, the variable definition will need to account for it.

**Summary:**

```{r}
data_with_sysrespfail_var2 <- data_with_sysrespfail_var1 |>
  mutate(sfratio_8a_0 = calc_sfratio_8a_0(
    resp_support_type_0 = resp_support_type_0,
    daily_spo2_8a_0 = daily_spo2_8a_0,
    daily_standard_flow_8a_0 = daily_standard_flow_8a_0,
    daily_hfnc_fi02_8a_0 = daily_hfnc_fi02_8a_0,
    daily_niv_fi02_8a_0 = daily_niv_fi02_8a_0,
    daily_imv_fio2_8a_0 = daily_imv_fio2_8a_0
  ))

data_with_sysrespfail_var2 |>
  filter(!is.na(sfratio_8a_0)) |>
  select(resp_support_type_0, sfratio_8a_0) |>
  ggplot(aes(sfratio_8a_0)) +
    geom_histogram(bins = 10) +
    facet_wrap(~ resp_support_type_0,
               labeller = as_labeller(c(
                 '1' = '1 (No Support)',
                 '2' = '2 (Standard Flow)',
                 '3' = '3 (HFNC)',
                 '4' = '4 (NIV)',
                 '5' = '5 (IMV, PEEP < 12, no ECMO)',
                 '6' = '6 ([IMV, PEEP ≥ 12] OR ECMO)'
               ))) +
    ggtitle("S/F Ratio Closest to 8am by Respiratory Support Type")
```

The histograms above show the distribution of S/F ratios for each support type.

#### Missingness Report

The records missing under Variable 1 (`resp_support_type_0`) are also missing for Variable 2 (`sfratio_8a_0`):

```{r}
data_with_sysrespfail_var2 |>
  filter(is.na(sfratio_8a_0) & is.na(resp_support_type_0)) |>
  select(record_id, sfratio_8a_0, resp_support_type_0) |>
  gt()
```

Details for why these records are missing are given above.

##### Valid NA Values

One record was missing `sfratio_8a_0` (Variable 2), but not missing `resp_support_type_0` (Variable 1). This is explained by the branching logic: if `dailysofa_perf_0 == 'Not Available'`, then `daily_spo2_8a_0` will be missing and the S/F ratio cannot be calculated according to the definition of Variable 2.

```{r}
data_with_sysrespfail_var2 |>
  filter(is.na(sfratio_8a_0) & !is.na(resp_support_type_0)) |>
  select(record_id, sfratio_8a_0, resp_support_type_0, daily_spo2_8a_0, dailysofa_perf_0) |>
  gt()
```

## Respiratory Failure Severity -- Streamlined DAG

Currently calculated the same as Variable 2 from the Systematic DAG Respiratory Failure Severity (see above).



## Chronic Moderate-Dose Steroid Use -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(mhccster == 0)` OR `(m_endo_conditions___2 == 1)` OR `(m_immunosup_conditions___1 == 1)`
- 1 (Yes) = `(mhccster == 1)` AND `(m_endo_conditions___2 == 0)` AND `(m_immunosup_conditions___1 == 0)`
- 99 (Unknown) = `mhccster == "Unknown"` OR `m_endocrine == "Unknown"` OR `m_immunosuppression == "Unknown"` (and doesn't meet either of the first two conditions)

**Summary:**

```{r}
data_with_sys_chron_steroid_moddose_0 <- data|>
  filter(event_label == 'Day 0') |>
  mutate(sys_chron_steroid_moddose_0 = calc_sys_chron_steroid_moddose_0(
    mhccster = mhccster,
    m_endo_conditions___2 = m_endo_conditions___2,
    m_immunosup_conditions___1 = m_immunosup_conditions___1,
    m_endocrine = m_endocrine,
    m_immunosuppression = m_immunosuppression
  ))

data_with_sys_chron_steroid_moddose_0 |>
  count(sys_chron_steroid_moddose_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were marked "Unknown" for one of the fields required to assess this variable:

```{r}
data_with_sys_chron_steroid_moddose_0 |>
  filter(sys_chron_steroid_moddose_0 == 99) |>
  select(record_id, mhccster, m_endocrine, m_endo_conditions___2, m_immunosuppression, m_immunosup_conditions___1) |>
  gt() |>
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "blue")
    ),
    locations = list(
      cells_body(
        columns = mhccster,
        rows = mhccster == "Unknown"
      ),
      cells_body(
        columns = m_endocrine,
        rows = m_endocrine == "Unknown"
      ),
      cells_body(
        columns = m_immunosuppression,
        rows = m_immunosuppression == "Unknown"
      )
    )
  )
```

### Missing Values

According to the branching logic, `m_endo_conditions___*` will only have a value if `m_endocrine == "Yes"` and `m_immunosup_conditions___*` will only have a value if `m_immunosuppression == "Yes"`. One record was missing (NA) `mhccster`, `m_endocrine`, and `m_immunosuppression`, but this is the same record missing from the N=500 dataset and does not need to be queried further.

## Chronic Moderate-Dose Steroid Use -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(mhccster == 0)` OR `(m_endo_conditions___2 == 1)`
- 1 (Yes) = `(mhccster == 1)` AND `(m_endo_conditions___2 == 0)`
- 99 (Unknown) = `mhccster == "Unknown"` OR `m_endocrine == "Unknown"` (and doesn't meet either of the first two conditions)

**Summary:**

```{r}
data_with_str_chron_steroid_moddose_0 <- data |>
  filter(event_label == 'Day 0') |>
  mutate(str_chron_steroid_moddose_0 = calc_str_chron_steroid_moddose_0(
    mhccster = mhccster,
    m_endo_conditions___2 = m_endo_conditions___2,
    m_endocrine = m_endocrine
  ))

data_with_str_chron_steroid_moddose_0 |>
  count(str_chron_steroid_moddose_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were marked "Unknown" for one of the fields required to assess this variable:

```{r}
data_with_str_chron_steroid_moddose_0 |>
  filter(str_chron_steroid_moddose_0 == 99) |>
  select(record_id, mhccster, m_endocrine, m_endo_conditions___2) |>
  gt() |>
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "blue")
    ),
    locations = list(
      cells_body(
        columns = mhccster,
        rows = mhccster == "Unknown"
      ),
      cells_body(
        columns = m_endocrine,
        rows = m_endocrine == "Unknown"
      )
    )
  )
```

### Missing Values

According to the branching logic, `m_endo_conditions___*` will only have a value if `m_endocrine == "Yes"`. One record was missing (NA) `mhccster` and `m_endocrine`, but this is the same record missing from the N=500 dataset and does not need to be queried further.






## Definite Adrenal Insufficiency -- Systematic DAG

**Variable Definition:**

Binary indicator variable (used to exclude patients if yes)

- 0 (No) = `(m_endo_conditions___2 == 0)` AND `(m_immunosup_conditions___1 == 0)`
- 1 (Yes) = `(m_endo_conditions___2 == 1)` OR `(m_immunosup_conditions___1 == 1)`
- 99 (Unknown) = `m_endocrine == "Unknown"` OR `m_immunosuppression == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_def_adrenal_insufficiency_0 = calc_sys_def_adrenal_insufficiency_0(
    m_endocrine = m_endocrine,
    m_endo_conditions___2 = m_endo_conditions___2,
    m_immunosuppression = m_immunosuppression,
    m_immunosup_conditions___1 = m_immunosup_conditions___1
  )) |>
  count(sys_def_adrenal_insufficiency_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" or "0" and having "Unknown" for either `m_endocrine` or `m_immunosuppression`:

```{r}
data |>
  filter(event_label == 'Day 0') |>
  filter(is_unknown(m_endocrine) | is_unknown(m_immunosuppression)) |>
  select(
    record_id,
    m_endocrine,
    m_immunosuppression
  ) |>
  gt()
```

### Missing Values

According to the branching logic, `m_endo_conditions___*` will only have a value if `m_endocrine == "Yes"` and `m_immunosup_conditions___*` will only have a value if `m_immunosuppression == "Yes"`. One record was missing (NA) both `m_endocrine` and `m_immunosuppression`, but this is the same record missing from the N=500 dataset and does not need to be queried further.

## Definite Adrenal Insufficiency -- Streamlined DAG

**Variable Definition:**

Binary indicator variable (used to exclude patients if yes)

- 0 (No) = `(m_endo_conditions___2 == 0)`
- 1 (Yes) = `(m_endo_conditions___2 == 1)`
- 99 (Unknown) = `m_endocrine == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(str_def_adrenal_insufficiency_0 = calc_str_adrenal_insufficiency_0(
    m_endocrine,
    m_endo_conditions___2 = m_endo_conditions___2
  )) |>
  count(str_def_adrenal_insufficiency_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_endocrine` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.

## Chronic Steroids High Dose -- Streamlined DAG

**Variable Definition:**

Binary indicator variable (used to exclude patients if yes):

- 0 (No) = `m_immunosup_conditions___1 == 0`
- 1 (Yes) = `m_immunosup_conditions___1 == 1`
- 99 (Unknown) = `m_immunosuppression == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(str_chron_steroid_highdose_0 = calc_str_chron_steroid_highdose_0(
    m_immunosuppression = m_immunosuppression,
    m_immunosup_conditions___1 = m_immunosup_conditions___1
  )) |>
  count(str_chron_steroid_highdose_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_immunosuppression` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.


## Steroid Responsive Comorbidity -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = All `(m_rheum_conditions___* == 0)` AND `(m_pulm_conditions___6 == 0)`
- 1 (Yes) = Any `(m_rheum_conditions___* == 1)` OR `(m_pulm_conditions___6 == 1)`
- 99 (Unknown) = `mhrheumd == "Unknown"` OR `m_pulmonary == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data_with_sys_steroid_comorb_0 <- data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_steroid_comorb_0 = calc_sys_steroid_comorb_0(
    mhrheumd = mhrheumd,
    m_rheum_conditions___1 = m_rheum_conditions___1,
    m_rheum_conditions___2 = m_rheum_conditions___2,
    m_rheum_conditions___3 = m_rheum_conditions___3,
    m_rheum_conditions___4 = m_rheum_conditions___4,
    m_rheum_conditions___5 = m_rheum_conditions___5,
    m_rheum_conditions___6 = m_rheum_conditions___6,
    m_rheum_conditions___7 = m_rheum_conditions___7,
    m_rheum_conditions___8 = m_rheum_conditions___8,
    m_rheum_conditions___88 = m_rheum_conditions___88,
    m_pulmonary = m_pulmonary,
    m_pulm_conditions___6 = m_pulm_conditions___6
  ))

data_with_sys_steroid_comorb_0 |>
  count(sys_steroid_comorb_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" or "0" and having "Unknown" for `mhrheumd` or `m_pulmonary`:

```{r}
data_with_sys_steroid_comorb_0 |>
  filter(sys_steroid_comorb_0 == 99) |>
  select(
    record_id,
    mhrheumd,
    m_pulmonary
  ) |>
  gt()
```

### Missing Values

According to the branching logic, `m_rheum_conditions___*` will only have a value if `mhrheumd == "Yes"` and `m_pulm_conditions___*` will only have a value if `m_pulmonary == "Yes"`. One record was missing (NA) `mhrheumd` and `m_pulmonary`, but this is the same record missing from the N=500 dataset and does not need to be queried further.

## Steroid Responsive Comorbidity -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = All `(m_rheum_conditions___* == 0)` (ignoring `m_rheum_conditions___8`) OR (`m_immunosup_conditions___4 == 0` AND `mhccster == 0`)
- 1 (Yes) = Any `(m_rheum_conditions___* == 1)` (ignoring `m_rheum_conditions___8`) AND (`m_immunosup_conditions___4 == 1` OR `mhccster == 1`)
- 99 (Unknown) = `mhrheumd == "Unknown"` OR `m_immunosuppression == "Unknown"` OR `mhccster == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data_with_str_steroid_comorb_0 <- data |>
  filter(event_label == 'Day 0') |>
  mutate(str_steroid_comorb_0 = calc_str_steroid_comorb_0(
    mhrheumd = mhrheumd,
    m_rheum_conditions___1 = m_rheum_conditions___1,
    m_rheum_conditions___2 = m_rheum_conditions___2,
    m_rheum_conditions___3 = m_rheum_conditions___3,
    m_rheum_conditions___4 = m_rheum_conditions___4,
    m_rheum_conditions___5 = m_rheum_conditions___5,
    m_rheum_conditions___6 = m_rheum_conditions___6,
    m_rheum_conditions___7 = m_rheum_conditions___7,
    m_rheum_conditions___88 = m_rheum_conditions___88,
    m_immunosuppression = m_immunosuppression,
    m_immunosup_conditions___4 = m_immunosup_conditions___4,
    mhccster = mhccster
  ))

data_with_str_steroid_comorb_0 |>
  count(str_steroid_comorb_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" or "0" and having "Unknown" for `mhrheumd` or `m_immunosuppression` or `mhccster`:

```{r}
data_with_str_steroid_comorb_0 |>
  filter(str_steroid_comorb_0 == 99) |>
  select(
    record_id,
    mhrheumd,
    m_immunosuppression,
    mhccster
  ) |>
  gt()
```

### Missing Values

The record missing (NA) for the variable "Steroid Responsive Comorbidity" (Systematic DAG) above is also missing for this variable.


## Obstructive Lung Disease -- Systematic DAG

**Variable Definition:**

Binary indicator variable

- 0 (No) = `(m_pulm_conditions___1 == 0)` AND `(m_pulm_conditions___3 == 0)`
- 1 (Yes) = `(m_pulm_conditions___1 == 1)` OR `(m_pulm_conditions___3 == 1)`
- 99 (Unknown) = `m_pulmonary == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_obstruct_lung_0 = calc_sys_obstruct_lung_0(
    m_pulmonary = m_pulmonary,
    m_pulm_conditions___1 = m_pulm_conditions___1,
    m_pulm_conditions___3 = m_pulm_conditions___3
  )) |>
  count(sys_obstruct_lung_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_pulmonary` listed under the variable "Steroid Responsive Comorbidity" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Steroid Responsive Comorbidity" (Systematic DAG) above is also missing for this variable.


## Obstructive Lung Disease -- Streamlined DAG

Currently calculated the same as Systematic DAG: Obstructive Lung Disease (see above).


## Chronic Immunocompromise -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = All `(m_immunosup_conditions___* == 0)` (excluding `m_immunosup_conditions___1`)
- 1 (Yes) = Any `(m_immunosup_conditions___* == 1)` (excluding `m_immunosup_conditions___1`)
- 99 (Unknown) = `m_immunosuppression == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_chron_immunocomp_0 = calc_sys_chron_immunocomp_0(
    m_immunosuppression = m_immunosuppression,
    m_immunosup_conditions___2 = m_immunosup_conditions___2,
    m_immunosup_conditions___3 = m_immunosup_conditions___3,
    m_immunosup_conditions___4 = m_immunosup_conditions___4,
    m_immunosup_conditions___5 = m_immunosup_conditions___5,
    m_immunosup_conditions___6 = m_immunosup_conditions___6,
    m_immunosup_conditions___7 = m_immunosup_conditions___7,
    m_immunosup_conditions___88 = m_immunosup_conditions___88
  )) |>
  count(sys_chron_immunocomp_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_immunosuppression` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.

## Hyperglycemia -- Systematic DAG

### Variable 1: Diabetes Medical History

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(m_endo_conditions___1 == 0)`
- 1 (Yes) = `(m_endo_conditions___1 == 1)`
- 99 (Unknown) = `m_endocrine == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_hyperglyc_hist_0 = calc_sys_hyperglyc_hist_0(
    m_endocrine = m_endocrine,
    m_endo_conditions___1 = m_endo_conditions___1
  )) |>
  count(sys_hyperglyc_hist_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### Unknown and Missing Values

Those with "Unknown" for `m_endocrine` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.

### Variable 2: Glucose Level

**Variable Definition:**

Continuous variable: Day 0 glucose measurement (`daily_gluc_8a_0`)

**Summary:**

```{r}
data_with_sys_hyperglyc_gluc_0 <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(sys_hyperglyc_gluc_0 = calc_sys_hyperglyc_gluc_0(
    daily_gluc_8a_0 = daily_gluc_8a_0,
    daily_gluc_nc_0 = daily_gluc_nc_0
  ))

data_with_sys_hyperglyc_gluc_0 |>
  select(sys_hyperglyc_gluc_0) |>
  filter(!is.na(sys_hyperglyc_gluc_0) & sys_hyperglyc_gluc_0 > -1) |>
  ggplot(aes(sys_hyperglyc_gluc_0)) +
    geom_histogram(bins = 40)
```

#### Missingness Report

The branching logic for `daily_gluc_nc_0` and `daily_gluc_8a_0` states that if `daily_gluc_8a_0` is missing (NA), then `daily_gluc_nc_0 == "Not Collected`.

Thus, according to the branching logic, these records were incorrectly missing `daily_gluc_8a_0` or `daily_gluc_nc_0`:

```{r}
data_with_sys_hyperglyc_gluc_0 |>
  filter(is.na(sys_hyperglyc_gluc_0)) |>
  select(
    record_id,
    daily_gluc_nc_0,
    daily_gluc_8a_0,
    sys_hyperglyc_gluc_0
  ) |>
  gt()
```

##### Valid NA

These records are missing a daily glucose measurement, but this is satisfied by the branching logic of `daily_gluc_nc_0 == "Not Collected"`. For these cases, the value of the variable `sys_hyperglyc_gluc_0` is set to `-1`.

```{r}
data_with_sys_hyperglyc_gluc_0 |>
  filter(sys_hyperglyc_gluc_0 == -1) |>
  select(
    record_id,
    sys_hyperglyc_gluc_0,
    daily_gluc_nc_0,
    daily_gluc_8a_0
  ) |>
  gt()
```

## Hyperglycemia -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(daily_gluc_8a_0 <= 250)` OR missing (NA)
- 1 (Yes) = `(daily_gluc_8a_0 > 250)`

**Summary:**

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(str_hyperglyc_hist_0 = calc_str_hyperglyc_hist_0(
    daily_gluc_8a_0 = daily_gluc_8a_0,
    daily_gluc_nc_0 = daily_gluc_nc_0
  )) |>
  count(str_hyperglyc_hist_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Missingness Report

According to the variable definition, all records can be assigned a value for this variable. However, as mentioned under Systematic DAG: Hyperglycemia Variable 2, these records missing `daily_gluc_8a_0` have invalid branching logic:

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_gluc_8a_0) & is.na(daily_gluc_nc_0)) |>
  select(
    record_id,
    daily_gluc_nc_0,
    daily_gluc_8a_0
  ) |>
  gt()
```

According to the variable definition, they were assigned `0` for `str_hyperglyc_hist_0`, but they should be looked at more closely.


## Active Fungal Infection -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(mhantifungals == "No")` AND `(daily_antifungal_0 == "Not administered")`
- 1 (Yes) = `(mhantifungals == "Yes")` OR `(daily_antifungal_0 == "Administered")`
- 99 (Unknown) = `(mhantifungals == "Unknown")` OR `(daily_antifungal_0 == "UNK")` (and first two conditions not met)

**Summary:**

```{r}
data_with_daily_fungal_0 <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  select(record_id, daily_antifungal_0, trx_0)

data_with_mhantifungals <- data |>
  filter(event_label == 'Day 0') |>
  select(record_id, mhantifungals)

data_fungal_joined <- data_with_daily_fungal_0 |>
  left_join(
    data_with_mhantifungals,
    by ='record_id'
    )

data_with_active_fungal_0 <- data_fungal_joined |>
  mutate(sys_active_fungal_0 = calc_sys_active_fungal_0(
    mhantifungals = mhantifungals,
    daily_antifungal_0 = daily_antifungal_0,
    trx_0 = trx_0
  ))

data_with_active_fungal_0 |>
  count(sys_active_fungal_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" or "0" and having "Unknown" for `mhantifungals` or `daily_antifungal_0`:

```{r}
data_with_active_fungal_0 |>
  filter(sys_active_fungal_0 == 99) |>
  select(
    record_id,
    mhantifungals,
    daily_antifungal_0
  ) |>
  gt()
```

### Missing Values

According to the branching logic, `daily_antifungal_0` will only have a value if `trx_0 == "Available"` and `trx_0` should have a value of either "Available" or "Not Available". These records were incorrectly missing (NA) `daily_antifungal_0` and/or `trx_0`:

```{r}
data_with_active_fungal_0 |>
  filter(is.na(sys_active_fungal_0)) |>
  select(
    record_id,
    mhantifungals,
    daily_antifungal_0,
    trx_0
  ) |>
  gt()
```

## Active Fungal Infection -- Streamlined DAG

Currently calculated the same as Systematic DAG: Active Fungal Infection (see above).

## Age -- Streamlined DAG

**Variable Definition:**

Age at enrollment (continuous variable)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(str_age_0 = calc_str_age_0(
    age = age
  )) |>
  ggplot(aes(str_age_0)) +
    geom_histogram(bins = 10) +
    ggtitle("Age at Enrollment")
```

There are no records missing `age_0`.


## END
