---
title: "Final Aim 6 Report"
output:
  github_document:
    toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Libraries
library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')

## Get support functions
source('support_functions.R')

## Load data from N=500 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load(file = '../aps-data/20250731_data.RData')
## Filter the excluded record to not muddy the variable summaries
data <- data |> filter(record_id != '52-0023')
```

```{r, echo = FALSE}
# Source variable derivation code
source("R/steroid-dag-variables.R")
```

Steroid DAG Variables are defined as follows:

```{r}
steroid_dag_data <- data |>
  # Get unique record IDs
  distinct(record_id) |>
  # DAG Variables
  left_join(wrapper_calc_sys_nmblockade_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_chron_steroid_moddose_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_chron_steroid_moddose_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_def_adrenal_insufficiency_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_adrenal_insufficiency_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_hyperglycemia_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_hyperglyc_hist_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_resp_failure_sev_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_sys_steroid_comorb_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_steroid_comorb_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_acute_allergic_reaction_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_str_age_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_chron_steroid_highdose_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_cop_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_str_dah_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_str_dementia_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_drug_toxicity_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_str_gi_bleeding_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_inflamprofile_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_inflamprofile_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_major_surgery_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_neuromuscular_disease_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_psi_score_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_scap_acidosis_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_scap_bilateral_opacities_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_str_scap_bun_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_scap_hypothermia_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_scap_leukopenia_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_scap_rr_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_str_scap_thrombocytopenia_0(data), by = "record_id") |>
  left_join(wrapper_calc_str_septic_shock_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_str_vasculitis_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_active_covid19_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_sys_active_fungal_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_active_influenza_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_sys_ards_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_baseline_performance_status_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_sys_chron_immunocomp_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_delirium_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_global_phys_sev_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_sys_hypotension_sev_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_obstruct_lung_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_organ_failure_trajectory(data), by = "record_id") |>
  left_join(wrapper_calc_sys_pneumonia_0(data), by = "record_id") |>
  left_join(wrapper_calc_sys_sepsis_0(data, dictionary), by = "record_id") |>
  left_join(wrapper_calc_sys_septic_shock_0(data, dictionary), by = "record_id")
```

## Missing Records

```{r}
get_records_with_missing_values <- function(data) {
  # For each row, find columns with NA values
  missing_list <- lapply(1:nrow(data), function(i) {
    row <- data[i, ]
    missing_cols <- names(row)[sapply(row, is.na)]

    if (length(missing_cols) > 0) {
      tibble(
        record_id = data$record_id[i],
        missing_cols = list(missing_cols)
      )
    } else {
      NULL
    }
  })

  # Combine all non-NULL results
  bind_rows(missing_list) |>
    arrange(record_id)
}

# Get records with missing values
records_with_missing <- get_records_with_missing_values(steroid_dag_data)

# Display summary
if (nrow(records_with_missing) > 0) {
  cat("Found", nrow(records_with_missing), "records with missing values\n\n")

  # Show first few records
  head(records_with_missing, 10)

  # Write to CSV (one row per record_id with missing columns concatenated)
  records_with_missing |>
    mutate(missing_cols = sapply(missing_cols, paste, collapse = "; ")) |>
    write.csv("generated-csvs/missing_values_report.csv", row.names = FALSE)

  cat("\nMissing values report written to missing_values_report.csv\n")

} else {
  cat("No records with missing values found\n")
}

# To view missing columns for a specific row:
# - For first row: records_with_missing$missing_cols[[1]]
# - For specific record_id: records_with_missing |> filter(record_id == "your_id") |> pull(missing_cols) |> unlist()
# - To expand all into long format: records_with_missing |> unnest(missing_cols)
```

## Unknown Records

```{r}
get_records_with_unknown_values <- function(data) {
  # For each row, find columns with unknown values (99 or -1)
  unknown_list <- lapply(1:nrow(data), function(i) {
    row <- data[i, ]
    unknown_cols <- names(row)[sapply(row, function(val) {
      !is.na(val) && (val == 99 || val == -1)
    })]

    if (length(unknown_cols) > 0) {
      tibble(
        record_id = data$record_id[i],
        unknown_cols = list(unknown_cols)
      )
    } else {
      NULL
    }
  })

  # Combine all non-NULL results
  bind_rows(unknown_list) |>
    arrange(record_id)
}

# Get records with unknown values
records_with_unknown <- get_records_with_unknown_values(steroid_dag_data)

# Display summary
if (nrow(records_with_unknown) > 0) {
  cat("Found", nrow(records_with_unknown), "records with unknown values (99 or -1)\n\n")

  # Show first few records
  head(records_with_unknown, 10)

  # Write to CSV (one row per record_id with unknown columns concatenated)
  records_with_unknown |>
    mutate(unknown_cols = sapply(unknown_cols, paste, collapse = "; ")) |>
    write.csv("generated-csvs/unknown_values_report.csv", row.names = FALSE)

  cat("\nUnknown values report written to unknown_values_report.csv\n")

} else {
  cat("No records with unknown values found\n")
}

# To view unknown columns for a specific row:
# - For first row: records_with_unknown$unknown_cols[[1]]
# - For specific record_id: records_with_unknown |> filter(record_id == "your_id") |> pull(unknown_cols) |> unlist()
# - To expand all into long format: records_with_unknown |> unnest(unknown_cols)
```
