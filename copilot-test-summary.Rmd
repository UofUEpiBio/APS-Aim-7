---
title: "APS Aim 7 Derived Variables Summary"
output:
  github_document:
    toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Libraries
library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')

## Get support functions
source('support_functions.R')

## Load data from N=500 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load(file = '../aps-data/20250731_data.RData')
```

```{r, echo = FALSE}
# Source variable derivation code
source("R/copilot-test-vars.R")
```

## (WIP) Organ Failure Trajectory -- Systematic DAG

**Variable Definition:**

"Two variables:
Total Day 0 SOFA score: sofa_total_day_0
Total Day -1 SOFA score: sofa_total_day_m1

Use NA if value is missing
Use 99 if value is not applicable (i.e. not in hospital on day -1)"

**COPILOT INSTRUCTIONS:**

For calculation the SOFA score, look in the "support_functions.R" file for any existing functions that may help with the calculation.

**END COPILOT INSTRUCTIONS:**

**Summary:**



## (WIP) Delirium -- Systematic DAG

**Variable Definition:**

Three-level variable

0 = done and not present
1 = done and present
2 = not done

**COPILOT INSTRUCTIONS:**

Likely Variables to use:
- cam_m2
- cam_m1
- cam_0

Each of the above can have one of four values:
- "Positive for delirium at least once on this day"
- "Negative for delirium on all assessments on this day"
- "Not done"
- NA

**END COPILOT INSTRUCTIONS:**

**Summary:**

## Delirium -- Streamlined DAG

Currently calculated the same as Systematic DAG: Delirium (see above).


## (WIP) Presence of Sepsis Syndrome -- Systematic DAG

**Variable Definition:**

"Binary indicator variables,

0 = Syndrome not present OR syndrome not present on or before day 0

1 = Syndrome present AND syndrome present on or before day 0"

**COPILOT INSTRUCTIONS:**

Likely Variables to use:
- sepsis_present (No  Yes NA)
- sepsis_clinical_judgement (Yes      No Unknown    NA)

**END COPILOT INSTRUCTIONS:**

**Summary:**


## (WIP) Presence of ARDS Syndrome -- Systematic DAG

**Variable Definition:**

"Binary indicator variables,

0 = Syndrome not present OR syndrome not present on or before day 0

1 = Syndrome present AND syndrome present on or before day 0"

**COPILOT INSTRUCTIONS:**

Likely Variables to use:
- ards_clinical_judgement (Yes      No Unknown    NA)
- ards_present (No  Yes NA)

**END COPILOT INSTRUCTIONS:**

**Summary:**


## Presence of ARDS Syndrome -- Streamlined DAG

Currently calculated the same as Systematic DAG: Presence of ARDS Syndrome (see above).

## (WIP) Presence of Pneumonia Syndrome -- Systematic DAG

**Variable Definition:**

"Binary indicator variables,

0 = Syndrome not present OR syndrome not present on or before day 0

1 = Syndrome present AND syndrome present on or before day 0"

**COPILOT INSTRUCTIONS:**

Likely Variables to use:
- pna_clinical_judgement (Yes      No Unknown    NA)
- pna_date (time stamp or NA)

**END COPILOT INSTRUCTIONS:**

**Summary:**


## Presence of Pneumonia Syndrome -- Streamlined DAG

Currently calculated the same as Systematic DAG: Presence of Pneumonia Syndrome (see above).

## (WIP) Septic Shock -- Systematic DAG

**Variable Definition:**

"Create indicator if (1) sepsis syndrome present on or before study day 0 AND (2) vasopressor at 8 am on study day 0 AND (3) vasopressor dose >0.5 norepinephrine equivalents.  (See comments column)

0 = Severe septic shock not present
1 = Severe septic shock present"

**COPILOT INSTRUCTIONS:**

Likely Variables to use:
- sepsis_present
- sepsis_clinical_judgement
- daily_vasopressors_0
- daily_sbp_8a_0
- daily_dbp_8a_0
- daily_ne_dose_8a_0_mcg
- daily_ne_dose_8a_0_mcgkg
- daily_epi_dose_8a_0_mcg
- daily_epi_dose_8a_0_mcgkg
- daily_phen_dos_8a_0_mcg
- daily_phen_dos_8a_0_mcgkg
- daily_vaso_dose_8a_0
- daily_dopa_dos_8a_0_mcg
- daily_dopa_dos_8a_0_mcgkg
- daily_dobuta_8a_0_mcg
- daily_dobuta_8a_0_mcgkg
- daily_ang2_8a_0_mcg
- daily_ang2_8a_0_mcgkg
- daily_milr_8a_0_mcg
- daily_milr_8a_0_mcgkg
- m_weight_kg

**END COPILOT INSTRUCTIONS:**

**Summary:**


## (WIP) Septic Shock -- Streamlined DAG

**Variable Definition:**

"DIFFERENT: Create indicator if (1) sepsis syndrome present on or before study day 0 AND (2) vasopressor at 8 am on study day 0

0 = Septic shock not present
1 = Septic shock present"

**COPILOT INSTRUCTIONS:**

Likely Variables to use:
- sepsis_present
- sepsis_clinical_judgement
- daily_vasopressors_0
- daily_sbp_8a_0
- daily_dbp_8a_0
- daily_ne_dose_8a_0_mcg
- daily_ne_dose_8a_0_mcgkg
- daily_epi_dose_8a_0_mcg
- daily_epi_dose_8a_0_mcgkg
- daily_phen_dos_8a_0_mcg
- daily_phen_dos_8a_0_mcgkg
- daily_vaso_dose_8a_0
- daily_dopa_dos_8a_0_mcg
- daily_dopa_dos_8a_0_mcgkg
- daily_dobuta_8a_0_mcg
- daily_dobuta_8a_0_mcgkg
- daily_ang2_8a_0_mcg
- daily_ang2_8a_0_mcgkg
- daily_milr_8a_0_mcg
- daily_milr_8a_0_mcgkg
- m_weight_kg

**END COPILOT INSTRUCTIONS:**

**Summary:**




## (WIP) Gastrointestinal Bleeding -- Streamlined DAG

**Variable Definition:**

Continuous variable with range 0 to ??? summing total number of packed red blood cell units tranfused on study days -2 to 0

**COPILOT INSTRUCTIONS:**

Likely Variables to use:
- blood_prbc_units_m2
- blood_prbc_units_m1
- blood_prbc_units_0
- daily_blood_product_m2
- daily_blood_product_m1
- daily_blood_product_0

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) Major Recent Surgery -- Streamlined DAG

**Variable Definition:**

"Binary indicator variable

0=if no surgery in OR on days -2 to 0
1=if surgery in OR on -2, -1, and/or day 0"

**COPILOT INSTRUCTIONS:**

Likely Variables to use:
- daily_surgery_m2
- daily_surgery_m1
- daily_surgery_m0
- daily_surgery_description_m2
- daily_surgery_description_m1
- daily_surgery_description_0

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) Dementia -- Streamlined DAG

**Variable Definition:**

"Binary variable
0=No dementia historry
1=Dementia history"

**COPILOT INSTRUCTIONS:**

Likely Variables to use:
- m_neurologic_conditions___1 (Unchecked   Checked      NA)
- m_neurologic (for branching logic, must == '1' to have m_neurologic_conditions___1 checked)

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) Acute Allergic Reaction -- Streamlined DAG

**Variable Definition:**

"Create binary variable -- DO use this IN PRIMARY ANALYSIS

0=No suspected anaphylaxis if organ_dysnfx_cause = 1, 3 OR 99 OR organ_dysnfx_inflam is not related to allergic reaction or anaphylaxis

1=Suspected anaphylaxis if organ_dysnfx_cause = 2 AND organ_dysnfx_inflam is related to allergic reaction or anaphylaxis"

**COPILOT INSTRUCTIONS:**

organ_dysfnx_cause
organ_dysfnx_inflam_descr

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) Diffuse Alveolar Hemorrhage -- Streamlined DAG

**Variable Definition:**

"Create binary variable BUT LIKELY DON'T USE IN PRIMARY ANALYSIS

0=No DAH if organ_dysnfx_cause = 1, 3 OR 99 OR organ_dysnfx_inflam is not related to DAH

1=Suspected DAH if organ_dysnfx_cause = 2 AND organ_dysnfx_inflam is related to DAH"

**COPILOT INSTRUCTIONS:**

organ_dysfnx_cause
organ_dysfnx_inflam_descr


**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) Acute Inflammatory Drug Toxicity -- Streamlined DAG

**Variable Definition:**

"Binary variable BUT LIKELY DON'T USE IN PRIMARY ANALYSIS

0=No acute inflmatory drug reaction if organ_dysnfx_cause = 1, 3 OR 99 OR organ_dysnfx_inflam is not related to acute inflammatory drug reaction

1=Suspected DAH if organ_dysnfx_cause = 2 AND organ_dysnfx_inflam is related to acute inflammatory drug reaction"

**COPILOT INSTRUCTIONS:**

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) Acute Cryptogenic Organizing Pneumonia -- Streamlined DAG

**Variable Definition:**

"Binary variable BUT LIKELY DON'T USE IN PRIMARY ANALYSIS

0=No acute inflmatory drug reaction if organ_dysnfx_cause = 1, 3 OR 99 OR organ_dysnfx_inflam is not related to acuteCOP

1=Suspected DAH if organ_dysnfx_cause = 2 AND organ_dysnfx_inflam is related to acute COP"

**COPILOT INSTRUCTIONS:**

Likely Variables to use:
- organ_dysfnx_cause
- organ_dysfnx_inflam_descr

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) SCAP Criterion Respiratory Rate -- Streamlined DAG

**Variable Definition:**

"Binary variable using day 0 daily value. If that's not available, use last value carried forward from day -1 or -2
0 = respiratory rate ≤ 30
1 = respiratory rate > 30"

**COPILOT INSTRUCTIONS:**

"daily_resp_rate_8a_0 (daily variable)
daily_resp_rate_8a_m1 (daily variable)
daily_resp_rate_8a_m2 (daily variable)"

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) SCAP Criterion BUN Value -- Streamlined DAG

**Variable Definition:**

"Binary variable using daily value. If that's not available, use last value carried forward from day -1 or -2
0 = BUN ≤ 30 mg/dl
1 = BUN > 30 mg/dl"

**COPILOT INSTRUCTIONS:**

"daily_bun_8a_0 (daily variable)
daily_bun_8a_m1 (daily variable)
daily_bun_8a_m2 (daily variable)"

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) SCAP Criterion Acidosis -- Streamlined DAG

**Variable Definition:**

"Binary variable using daily lowest. If that's not available, use last value carried forward from day -1 or -2
0 = ≥ 7.30
1 = < 7.30"

**COPILOT INSTRUCTIONS:**

"daily_ph_lowest_0  (daily varialble)
daily_ph_lowest_m1 (daily varialble)
daily_ph_lowest_m2  (daily varialble)"

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) SCAP Criterion Bilateral Opacities -- Streamlined DAG

**Variable Definition:**

"Binary variable using from the syndrome adjudication form.

0=No bilateral opacities if all *_opacity values are not ""2""

1=Yes bilateral opacities if any one of listed ""*_opacity"" values are ""2"""

**COPILOT INSTRUCTIONS:**

"cxr_dm2_available
cxr_dm2_opacity
ct_dm2_available
ct_dm2_opacity
cxr_dm1_available
cxr_dm1_opacity
ct_dm1_available
ct_dm1_opacity
cxr_d0_available
cxr_d0_opacity
ct_d0_available
ct_d0_opacity"

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) SCAP Criterion Leukopenia -- Streamlined DAG

**Variable Definition:**

"Binary variable using day 0 value from daily assessment data. If that's not available, use last value carried forward from day -1 or -2
0=WBC <4
1=WBC >=4"

**COPILOT INSTRUCTIONS:**

"daily_wbc_8a_0  (daily varialble)
daily_wbc_8a_m1 (daily varialble)
daily_wbc_8a_m2 (daily varialble)"

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) SCAP Criterion Thrombocytopenia -- Streamlined DAG

**Variable Definition:**

"Binary variable using day 0 value from daily assessment data. If that's not available, use last value carried forward from day -1 or -2
0=Platelets <100
1=Platelets >=100"

**COPILOT INSTRUCTIONS:**

"daily_platelet_8a_0  (daily varialble)
daily_platelet_8a_m1  (daily varialble)
daily_platelet_8a_m2  (daily varialble)"

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) SCAP Criterion Hypothermia -- Streamlined DAG

**Variable Definition:**

"Binary Variable from the ""Vital signs day 0"" form. If that's not available, use last value carried forward from day -1 or -2
0 = ≥ 35.0
1 =  35.0"

**COPILOT INSTRUCTIONS:**

lowtemp_vsorres

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) Chronic Neuromuscular Disease -- Streamlined DAG

**Variable Definition:**

"Binary variable
0=No chronic neuromuscular disease history
1=Chronic neuromuscular disease history"

**COPILOT INSTRUCTIONS:**

"m_neurologic
m_neurologic_conditions___6"

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) PSI Score -- Streamlined DAG

**Variable Definition:**

"PSI score calculated per formula in the original reference (https://pubmed.ncbi.nl.nih.gov/8995086/) and per instructions in the comments column

Inputs to PSI score:
Age (age in years = points)
Female sex (–10 points)
Nursing home resident ( +10 points)

Congestive heart failure (+10 points)
Cerebrovascular disease (+10 points)
Neoplastic disease (+30 points)
Renal disease (+10 points)
Liver disease (+20 points)

Altered mental status (+20 points)

Pulse ≥ 125/min (+10 points)
Respiratory rate ≥ 30/min (+20 points)
Systolic blood pressure < 90 mm Hg (+20 points)
Temperature < 35°C or ≥ 40°C (+15 points)

Blood urea nitrogen ≥ 30 mg/dl (+20 points)
Glucose ≥ 250 mg/dl (+10 points)
Hematocrit < 30% (+10 points)
Sodium < 130 mmol/liter (+20 points)
PaO2 < 60 mm Hg (+10 points)
Arterial pH < 7.35 (+30 points)
Pleural effusion (+10 points)"

**COPILOT INSTRUCTIONS:**

"age
sex
prssrc
m_cv_conditions
m_neurologic_conditions
m_cancer (Active cancer)
m_kid_liver_conditions
su_ivdu
sualcdosfrq, sualcdstxt, sualcdosfrqsix
cam_0 (daily variable, see above)
highhr_vsorres
daily_resp_rate_8a_0 (daily variable, see above)
lowsysbp_vsorres (daily variable)
lowtemp_vsorres, hightemp_vsorres
daily_bun_8a_0 (daily variable)
daily_gluc_8a_0 (daily variable)
daily_hct_8a_0 (daily variable)
daily_na_8a_0 (daily variable)
daily_pa02_lowest_0 (daily variable)
daily_ph_lowest_0 (daily variable)
pna_effusion"

**END COPILOT INSTRUCTIONS:**

**Summary:**

## (WIP) Active Vasculitis -- Streamlined DAG

**Variable Definition:**

"Binary variable

0=No vasculitis history if has no history of vasculitis OR (has no current immunosuppression for nontransplant/non-cancer condition AND has no current chronic steroids)

1=Vasculitis history  if has history of vasculitis AND (has current immunosuppression for nontransplant/non-cancer condition OR has current chronic steroids)"

**COPILOT INSTRUCTIONS:**

"m_rheum_conditions___8
m_immunosup_conditions___4
mhccster"

**END COPILOT INSTRUCTIONS:**

**Summary:**
