---
title: "APS Data Examples"
author: "M. Shotwell"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
---

```{r 'setup and load data', message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')
library('scales')

## get support functions
source('support_functions.R')

## load data from N=1000 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load('20251213_data.RData')
```

# Working with the codebook and dictionary

The codebook shows which forms are collected at which events. For example, the Clinical Frailty Scale is collected at the "Patient/Surrogate Interview" and at each of the 3, 6, and 12 month survey events. The form is not repeating, meaning it can only be completed once per event. Repeating instruments/forms have one row per instance in the data set.

```{r}
codebook %>%
  filter(form_label == 'Clinical Frailty Scale') %>%
  gt()
```

The dictionary gives detailed information about each field. Consider the "frailty_base", which is a radio button field that is part of the Clinical Frailty Scale form. The dictionary gives each possible value for this field. Note that other kinds of fields, notably text fields, may have values that are less structured.

```{r}
dictionary %>%
  filter(field_name == 'frailty_base') %>%
  select('field_name', 'field_type', 'form_label', 'field_label',
    'select_choices_or_calculations', 'branching_logic') %>%
  unclass()
```

Note the branching logic "[frailty_perf] = '1'", which specifies that the "fraily_base" field is only presented in the REDCap user interface when the value of another field [fraily_perf] takes a value '1' for the corresponding record and event. The "frailty_perf" field is used to indicate whether the Clinical Frailty Scale assessment was performed. Thus, "frailty_base" should be missing if "frailty_perf" is "No".

```{r}
dictionary %>%
  filter(field_name == 'frailty_perf') %>%
  select('field_name', 'field_type', 'form_label', 'field_label',
    'select_choices_or_calculations', 'branching_logic') %>%
  unclass()
```

We can examine whether this is true in the data by cross-tabulating the two fields at the 'Patient/Surrogate Interview' event.

```{r}
data %>%
  ## start with list of record IDs
  filter(!duplicated(record_id)) %>%
  select(record_id) %>%
  ## merge fields from clinical frailty form at the patient/surrogate interview
  left_join(data %>%
    filter(event_label == 'Patient/Surrogate Interview') %>%
    filter(is.na(repeat_instrument)) %>%
    select(record_id, all_of(dictionary %>%
      filter(form_name == 'clinical_frailty_scale') %>%
      pull(field_name))),
    by='record_id') %>%
  xtabs(~ frailty_perf + is.na(frailty_base), data=., addNA=TRUE)
```

Consider the day 0 Confusion Assessment Method (CAM) assessment variable "cam_0". Here the branching logic is more complex involving two other fields. In plain English, the branching logic specifies that the CAM assessment field is only presented in the REDCap interface if the Richmond Agitation-Sedation Scale (RASS) scale was assessed on day 0 (i.e., not missing) and its value was > -4 (values -4 or -5 are non-responsive states).

```{r}
dictionary %>%
  filter(field_name == 'cam_0') %>%
  select('field_name', 'field_type', 'form_label', 'field_label',
    'select_choices_or_calculations', 'branching_logic') %>%
  unclass()
```

This branching logic can be reproduced to verify that missing values for "cam_0" are due to unsatisfied branching logic:

```{r}
data %>%
  ## start with list of record IDs
  filter(!duplicated(record_id)) %>%
  select(record_id) %>%
  ## merge fields from clinical frailty form at the patient/surrogate interview
  left_join(data %>%
    filter(event_label == 'Daily In-Hospital Forms') %>%
    filter(is.na(repeat_instrument)) %>%
    select(record_id, all_of(dictionary %>%
      filter(form_name == 'sedation_and_delirium_day_2_to_7') %>%
      pull(field_name))),
    by='record_id') %>%
  ## reproduct cam_0 branching logic
  mutate(cam_0_branching_logic =
    ## lowest and highest RASS are documented
    !is.na(highestrass_orres_0) &
    !is.na(lowrass_orres_0) &
    ## at least one is > -4
    (!(lowrass_orres_0 %in% c('-5','-4')) |
     !(highestrass_orres_0 %in% c('-5','-4')))) %>%
  xtabs(~cam_0_branching_logic + is.na(cam_0), data=.)
```

It may be convenient to use numeric codes for multiple choice fields instead of the value labels. The code below creates a data frame that maps the label to numeric code for a multiple choice field:

```{r}
## show label-to-code map for 'elig_vent_support'
## get_code_label_map defined in support_functions.R
get_code_label_map('elig_vent_support', dictionary) %>%
  select(elig_vent_support, elig_vent_support_code) %>%
  gt()
```

The numeric codes that then be easily merged with the data:

```{r}
## join codes for 'elig_vent_support' variable
data %>%
  ## merge codes for 'elig_vent_support'
  left_join(
    get_code_label_map('elig_vent_support', dictionary),
    by='elig_vent_support') %>%
  ## show first few rows at the relevant event
  filter(event_label == 'Pre-Enrollment') %>%
  filter(is.na(repeat_instrument)) %>%
  select(record_id, elig_vent_support, elig_vent_support_code) %>%
  head() %>%
  gt()
```

# Table of syndrome adjudications

The code below creates a data frame with one record per participant with the consensus syndrome adjudication data for that participant.

```{r}
## get the field names from the syndrome adjudication form
syndrome_fields <- dictionary %>%
  filter(form_label == 'Syndrome Adjudication (Investigators Form) [day -2 to 7]') %>%
  pull(field_name)

syndrome_data <- data %>%
  ## filter to the relevant event
  filter(event_label == 'Syndrome Adjudication') %>%
  ## make sure you dont get repeating instrument rows
  filter(is.na(repeat_instrument)) %>%
  ## get ID fields and syndrome adjudication fields
  select(record_id, event_label, enrolling_center, all_of(syndrome_fields)) %>%
  ## make sure there is one record per participant, even if no adjudication row
  right_join(data %>% select(record_id) %>% filter(!duplicated(record_id)),
    by='record_id')

## show a portion of the table
syndrome_data %>%
  select(record_id, ards_clinical_judgement,
    pna_clinical_judgement, sepsis_clinical_judgement) %>%
  head() %>%
  gt()
```

# Derived variables

## SOFA and SOFA-2 scores

The code below converts SOFA score fields in wide format to long, computes each component of the SOFA score and the total score, and creates a figure to display them.

```{r 'sofa scores'}

## daily in-hospital measurements needed for SOFA are all collected at the
## 'Daily In-Hospital Forms' event. Each day has a separate set of fields,
## e.g., daily_pa02_lowest_m2, daily_pa02_lowest_m1, daily_pa02_lowest_0, ...
## which correspond to daily lowest PaO2 on day -2, -1, 0, ...

## isolate the daily in-hospital data
data_sofa <- data %>%

  ## filter to the relevant event
  filter(event_label == 'Daily In-Hospital Forms') %>%

  ## filter out any repeat instrument rows (none of the SOFA variables are
  ## on a repeating instrument/form)
  filter(is.na(repeat_instrument)) %>%

  ## remove the weight variable and merge it back in from the "Day 0" event
  ## where weight is collected
  select(-m_weight_kg) %>%
  left_join(data %>%
    filter(event_label == 'Day 0') %>%
    select(record_id, m_weight_kg),
    by='record_id') %>%

  ## ensure there is exactly one row per participant; this is good practice
  ## because some participants will not have any records for some events; this
  ## ensures that there is a data point for each participant, even if that data
  ## point is NA
  right_join(data %>%
    filter(!duplicated(record_id)) %>%
    select(record_id),
    by='record_id') %>%

  ## select variables involved in SOFA calculations
  select(
    record_id,
    m_weight_kg,
    ## respiratory
    matches('daily_pa02_lowest_(m2|m1|[0-7])'),
    matches('daily_resp_lowest_pao2_(m2|m1|[0-7])'),
    matches('daily_fio2_lowest_pao2_(m2|m1|[0-7])'),
    matches('daily_o2_lowest_pao2_(m2|m1|[0-7])'),
    matches('daily_spo2_lowest_(m2|m1|[0-7])'),
    matches('daily_resp_lowest_(m2|m1|[0-7])'),
    matches('daily_fio2_lowest_(m2|m1|[0-7])'),
    matches('daily_o2_lowest_(m2|m1|[0-7])'),
    ## coagulation
    matches('daily_platelet_8a_(m2|m1|[0-7])'),
    ## liver
    matches('daily_tbili_8a_(m2|m1|[0-7])'),
    ## cardiovascular
    matches('daily_sbp_8a_(m2|m1|[0-7])'),
    matches('daily_dbp_8a_(m2|m1|[0-7])'),
    matches('daily_dopa_dose_8a_(m2|m1|[0-7])_(mcg|mcgkg)'),
    matches('daily_dopa_dos_8a_(m2|m1|[0-7])_(mcg|mcgkg)'),
    matches('daily_dobuta_8a_(m2|m1|[0-7])_(mcg|mcgkg)'),
    matches('daily_epi_dose_8a_(m2|m1|[0-7])_(mcg|mcgkg)'),
    matches('daily_ne_dose_8a_(m2|m1|[0-7])_(mcg|mcgkg)'),
    matches('daily_ang2_8a_(m2|m1|[0-7])_(mcg|mcgkg)'),
    matches('daily_phen_dos(e)?_8a_(m2|m1|[0-7])_(mcg|mcgkg)'),
    matches('daily_vaso_dose_8a_(m2|m1|[0-7])'),
    ## CNS
    matches('daily_gcs_8a_(m2|m1|[0-7])'),
    ## Renal
    matches('daily_cr_8a_(m2|m1|[0-7])')) %>%

  ## rename the columns so that the study day is always the last element
  rename_with(~sub('(.+)_(m2|m1|[0-7])_(.+)', '\\1_\\3_\\2', x=.)) %>%

  ## pivot from wide to long with respect to days -2, -1, 0, ..., 7
  pivot_longer(
    cols = -c(record_id, m_weight_kg), ## pivot all columns except these
    names_to = c('.value', 'study_day'),
    names_pattern = '(.+)_(m2|m1|[0-7])') %>%

  ## convert study_day to numeric
  mutate(study_day = as.numeric(sub('m', '-', study_day))) %>%

  ## respiratory
  mutate(pf_ratio = calc_pf_ratio(
    low_pao2 = daily_pa02_lowest,
    resp_low_pao2 = daily_resp_lowest_pao2,
    fio2_low_pao2 = daily_fio2_lowest_pao2,
    o2_low_pao2 = daily_o2_lowest_pao2)) %>%
  mutate(sf_ratio = calc_sf_ratio(
    low_spo2 = daily_spo2_lowest,
    resp_low_spo2 = daily_resp_lowest,
    fio2_low_spo2 = daily_fio2_lowest,
    o2_low_spo2 = daily_o2_lowest)) %>%
  mutate(sofa_resp = calc_sofa_resp(
    pf_ratio = pf_ratio,
    sf_ratio = sf_ratio)) %>%
  mutate(sofa_2_resp = calc_sofa_2_resp(
    pf_ratio = pf_ratio,
    sf_ratio = sf_ratio)) %>%

  ## coagulation
  mutate(sofa_coag   = calc_sofa_coag(platelets = daily_platelet_8a)) %>%
  mutate(sofa_2_coag = calc_sofa_2_coag(platelets = daily_platelet_8a)) %>%

  ## liver
  mutate(sofa_livr   = calc_sofa_livr(bilirubin = daily_tbili_8a)) %>%
  mutate(sofa_2_livr = calc_sofa_2_livr(bilirubin = daily_tbili_8a)) %>%

  ## cardiovascular
  mutate(sofa_card = calc_sofa_card(
    sbp = daily_sbp_8a,
    dbp = daily_sbp_8a,
    dopa_mcg = daily_dopa_dose_8a_mcg,
    dopa_mcgkg = daily_dopa_dos_8a_mcgkg,
    dobu_mcg = daily_dobuta_8a_mcg,
    dobu_mcgkg = daily_dobuta_8a_mcgkg,
    epin_mcg = daily_epi_dose_8a_mcg,
    epin_mcgkg = daily_epi_dose_8a_mcgkg,
    nore_mcg = daily_ne_dose_8a_mcg,
    nore_mcgkg = daily_ne_dose_8a_mcgkg,
    weight_kg = m_weight_kg)) %>%
  mutate(sofa_2_card = calc_sofa_2_card(
    sbp = daily_sbp_8a,
    dbp = daily_sbp_8a,
    dopa_mcg = daily_dopa_dose_8a_mcg,
    dopa_mcgkg = daily_dopa_dos_8a_mcgkg,
    dobu_mcg = daily_dobuta_8a_mcg,
    dobu_mcgkg = daily_dobuta_8a_mcgkg,
    epin_mcg = daily_epi_dose_8a_mcg,
    epin_mcgkg = daily_epi_dose_8a_mcgkg,
    nore_mcg = daily_ne_dose_8a_mcg,
    nore_mcgkg = daily_ne_dose_8a_mcgkg,
    phen_mcg = daily_phen_dose_8a_mcg,
    phen_mcgkg = daily_phen_dos_8a_mcgkg,
    vaso_dose = daily_vaso_dose_8a,
    ang2_mcg = daily_ang2_8a_mcg,
    ang2_mcgkg = daily_ang2_8a_mcgkg,
    weight_kg = m_weight_kg)) %>%

  ## CNS
  ## calculate wither 'T' present in GCS; indicating intubated patient
  mutate(sofa_cns_gcs_t = ifelse(is.na(daily_gcs_8a), NA, grepl('T', daily_gcs_8a))) %>%
  ## create variable where GCS with a 'T' are set to NA
  mutate(sofa_cns_gcs_no_t = as.numeric(daily_gcs_8a)) %>%
  mutate(sofa_cns   = calc_sofa_cns(gcs = daily_gcs_8a)) %>%
  mutate(sofa_2_cns = calc_sofa_2_cns(gcs = daily_gcs_8a)) %>%

  ## Renal
  mutate(sofa_rena   = calc_sofa_rena(daily_cr_8a)) %>%
  mutate(sofa_2_rena = calc_sofa_2_rena(daily_cr_8a)) %>%

  ## Total SOFA
  mutate(sofa_totl   = sofa_resp + sofa_coag + sofa_livr + sofa_card + sofa_cns + sofa_rena) %>%
  mutate(sofa_2_totl = sofa_2_resp + sofa_2_coag + sofa_2_livr + sofa_2_card + sofa_2_cns + sofa_2_rena)

# data_sofa %>%
#   select(record_id, study_day, matches('sofa_[^2]')) %>%
#   select(-starts_with('sofa_cns_gcs'), -sofa_totl) %>%
#   pivot_longer(cols = starts_with('sofa'), names_to = 'component') %>%
#   mutate(study_day = factor(study_day, levels=-2:7)) %>%
#   mutate(value = factor(value)) %>%
#   mutate(component = case_match(component,
#     "sofa_resp" ~ "Respiratory",
#     "sofa_coag" ~ "Coagulation",
#     "sofa_livr" ~ "Liver",
#     "sofa_card" ~ "Cardiovascular",
#     "sofa_cns" ~ "CNS",
#     "sofa_rena" ~ "Renal",
#     "sofa_totl" ~ "Total")) %>%
#   group_by(study_day, component, value) %>%
#   summarise(count = n(), .groups='drop') %>%
#   ggplot(aes(x=study_day, y=count, fill=value)) +
#     geom_bar(stat="identity", position='stack') +
#     facet_wrap(~component) +
#   labs(x='Study Day', y='Participant Count', fill='Score', title='SOFA Component Scores')
#
# data_sofa %>%
#   select(record_id, study_day, sofa_totl) %>%
#   mutate(study_day = factor(study_day, levels=-2:7)) %>%
#   mutate(sofa_totl = factor(sofa_totl)) %>%
#   group_by(study_day, sofa_totl) %>%
#   summarise(count = n(), .groups='drop') %>%
#   ggplot(aes(x=study_day, y=count, fill=sofa_totl)) +
#     geom_bar(stat="identity", position='stack') +
#     labs(x='Study Day', y='Participant Count', fill='Score', title='SOFA Total Score')

data_sofa_imp <- data_sofa %>%
  left_join(data %>%
    filter(event_label == 'Logs', is.na(repeat_instrument)) %>%
    select(record_id, dthind, dthdat, dsdecod, dsstdat),
    by='record_id') %>%
  left_join(data %>%
    filter(event_label == 'Hospital Discharge and Summary', is.na(repeat_instrument)) %>%
    select(record_id, disdat, icu_occur, icu_stdat, icu_endat, icu_discat),
    by='record_id') %>%
  left_join(data %>%
    filter(event_label == 'Day 0', is.na(repeat_instrument)) %>%
    select(record_id, ds_arrival_date, enrollment_time),
    by='record_id') %>%
  mutate(death_day = as.numeric(difftime(as.Date(dthdat), as.Date(enrollment_time), units='days'))) %>%
  mutate(icu_start_day= as.numeric(difftime(as.Date(icu_stdat), as.Date(enrollment_time), units='days'))) %>%
  mutate(icu_end_day= as.numeric(difftime(as.Date(icu_endat), as.Date(enrollment_time), units='days'))) %>%
  mutate(sofa_all_na = if_all(all_of(
    paste0('sofa_', c('resp','coag','livr','card','cns','rena'))), is.na)) %>%
  mutate(sofa_2_all_na = if_all(all_of(
    paste0('sofa_2_', c('resp','coag','livr','card','cns','rena'))), is.na)) %>%
  mutate(sofa_totl_imp = ifelse(!sofa_all_na, rowSums(across(all_of(
    paste0('sofa_', c('resp','coag','livr','card','cns','rena')))), na.rm=TRUE), NA)) %>%
  mutate(sofa_2_totl_imp = ifelse(!sofa_all_na, rowSums(across(all_of(
    paste0('sofa_2_', c('resp','coag','livr','card','cns','rena')))), na.rm=TRUE), NA)) %>%
  mutate(study_date = as.difftime(study_day, units='days') + as.Date(enrollment_time)) %>%
  mutate(sofa_missing_reason = case_when(
    study_date < as.Date(ds_arrival_date) ~ "Pre-hospital",
    !is.na(dthdat) & study_date > as.Date(dthdat) ~ "Deceased",
    !is.na(disdat) & study_date > as.Date(disdat) ~ "Discharged",
    (is.na(sofa_2_totl_imp) | is.na(sofa_totl_imp)) &
      grepl("No further", dsdecod) ~ dsdecod,
    !is.na(dsstdat) & study_date > as.Date(dsstdat) &
      grepl('Withdrawn|Lost', dsdecod) ~ dsdecod,
    is.na(sofa_totl_imp) | is.na(sofa_2_totl_imp) ~ "Other",
    TRUE ~ NA)) %>%
  select(record_id, study_day,
    all_of(paste0('sofa_', c('resp','coag','livr','card','cns','rena'))),
    'sofa_totl', 'sofa_totl_imp',
    all_of(paste0('sofa_2_', c('resp','coag','livr','card','cns','rena'))),
    'sofa_2_totl', 'sofa_2_totl_imp',
    'sofa_missing_reason',
    icu_start_day, icu_end_day, death_day)

data_sofa_imp %>%
  select(record_id, study_day, matches('sofa_2')) %>%
  select(-sofa_2_totl, -sofa_2_totl_imp) %>%
  pivot_longer(cols = starts_with('sofa'), names_to = 'component') %>%
  mutate(study_day = factor(study_day, levels=-2:7)) %>%
  mutate(value = factor(value)) %>%
  mutate(component = case_match(component,
    "sofa_2_resp" ~ "Respiratory",
    "sofa_2_coag" ~ "Coagulation",
    "sofa_2_livr" ~ "Liver",
    "sofa_2_card" ~ "Cardiovascular",
    "sofa_2_cns" ~ "CNS",
    "sofa_2_rena" ~ "Renal",
    "sofa_2_totl" ~ "Total")) %>%
  group_by(study_day, component, value) %>%
  summarise(count = n(), .groups='drop') %>%
  ggplot(aes(x=study_day, y=count, fill=value)) +
    geom_bar(stat="identity", position='stack') +
    facet_wrap(~component) +
  labs(x='Study Day', y='Participant Count', fill='Score', title='SOFA-2 Component Scores')

data_sofa_imp %>%
  select(record_id, study_day, sofa_2_totl_imp) %>%
  mutate(study_day = factor(study_day, levels=-2:7)) %>%
  mutate(sofa_2_totl_imp = cut(sofa_2_totl_imp, breaks=c(-Inf, 1, 6, 9, 12, Inf),
    labels=c('0-1 Normal', '2-6 Mild', '7-9 Moderate', '10-12 Severe', '>12 Very Severe'))) %>%
  #mutate(sofa_2_totl_imp = factor(sofa_2_totl_imp)) %>%
  group_by(study_day, sofa_2_totl_imp) %>%
  summarise(count = n(), .groups='drop') %>%
  ggplot(aes(x=study_day, y=count, fill=sofa_2_totl_imp)) +
    geom_bar(stat="identity", position='stack') +
    labs(x='Study Day', y='Participant Count', fill='Score', title='SOFA-2 Total Score')

data_sofa_imp %>%
  select(record_id, study_day, sofa_missing_reason) %>%
  mutate(study_day = factor(study_day, levels=-2:7)) %>%
  mutate(sofa_missing_reason =
    ifelse(is.na(sofa_missing_reason), 'Not missing', sofa_missing_reason)) %>%
  mutate(sofa_missing_reason = factor(sofa_missing_reason, levels=c(
    "Pre-hospital", "Discharged", "Deceased",
    "Discontinued - No further data collection", "Other",
    "Not missing"))) %>%
  group_by(study_day, sofa_missing_reason) %>%
  summarise(count = n(), .groups='drop') %>%
  ggplot(aes(x=study_day, y=count, fill=sofa_missing_reason)) +
    geom_bar(stat="identity", position='stack') +
    labs(x='Study Day', y='Participant Count', fill='Reason', title='SOFA-2 Missing Reason') +
    scale_fill_manual(values = c(hue_pal()(5), "grey70")) +
    theme_light()
```
