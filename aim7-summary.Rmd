---
title: "APS Aim 7 Derived Variables Summary"
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Libraries
library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')

## Get support functions
source('support_functions.R')

## Load data from N=500 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load(file = '../aps-data/20250731_data.RData')
```

```{r, echo = FALSE}
# Source variable derivation code
source("R/all.R")
```

## Streamlined DAG: Neuromuscular Blockade

- 0 = No neuromuscular blockade on Day 0 or missing
- 1 = Neuromuscular blockade given on Day 0

### Code to Generate Variable
```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(str_nmblockade_0 = calc_str_nmblockade_0(
    daily_paralysis_0 = daily_paralysis_0,
    trx_0 = trx_0
  )) |>
  select(str_nmblockade_0)
```

Note, filtering by 'Daily In-Hospital Forms' returns only 499 entries, not 500?

### Variable Summary

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(str_nmblockade_0 = calc_str_nmblockade_0(
    daily_paralysis_0 = daily_paralysis_0,
    trx_0 = trx_0
  )) |>
  count(str_nmblockade_0) |>
  gt()
```

### Missingness Report for `daily_paralysis_0`

#### Valid NA Values

These records were missing `daily_paralysis_0`, but this was *expected* by the branching logic of `trx_0 == 'Not Available'`.
These values were set to `neuromuscular_blockade_0 = 0` according to the variable definition.

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_paralysis_0) & (trx_0 == 'Not Available')) |>
  select(record_id, daily_paralysis_0, trx_0) |>
  gt()
```

#### Invalid NA Values

These records were missing `daily_paralysis_0`, but this was *unexpected* by the branching logic.
```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_paralysis_0) & (trx_0 %in% c('Available', NA))) |>
  mutate(missingness = case_when(
    trx_0 == 'Available' ~ 'By branching logic, "daily_paralysis_0" should have a value',
    is.na(trx_0) ~ '"trx_0" is also missing'
  )) |>
  select(record_id, daily_paralysis_0, trx_0, missingness) |>
  gt()
```
