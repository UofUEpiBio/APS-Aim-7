---
title: "APS Aim 7 Derived Variables Summary"
output:
  github_document:
    toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Libraries
library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')

## Get support functions
source('support_functions.R')

## Load data from N=500 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load(file = '../aps-data/20250731_data.RData')
```

```{r, echo = FALSE}
# Source variable derivation code
source("R/variables.R")
```

## (WIP) Global Physiology Severity -- Systematic DAG

**Variable Definition:**

Calculated the same as the APS component of the APACHE II score (integar value from 0 to 48).

**Summary:**

```{r}
data_day0_vars <- data |>
  filter(event_label == 'Day 0') |>
  select(
    record_id,
    vs_perf, # branching logic
    hightemp_vsorres,
    lowtemp_vsorres,
    highhr_vsorres,
    lowhr_vsorres,
    highrr_vsorres,
    lowrr_vsorres,
    lowsysbp_vsorres,
    lowdbp_vsorres
  )

data_hospitalform_vars <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  select(
    record_id,

    ## - Day 0
    dailysofa_perf_0, # branching logic
    daily_resp_8a_0, # branching logic
    daily_imv_mode_8a_0,
    daily_imv_fio2_8a_0,
    daily_pao2_occur_0, # branching logic
    daily_pa02_lowest_0,
    daily_paco2_lowest_0,
    daily_ph_lowest_0,
    daily_k_nc_0, # branching logic
    daily_k_8a_0,
    daily_na_nc_0, # branching logic
    daily_na_8a_0,
    daily_alb_nc_0, # branching logic
    daily_alb_8a_0,
    daily_tbili_nc_0, # branching logic
    daily_tbili_8a_0,
    daily_hct_nc_0, # branching logic
    daily_hct_8a_0,
    daily_wbc_nc_0, # branching logic
    daily_wbc_8a_0,
    daily_gluc_nc_0, # branching logic
    daily_gluc_8a_0,
    daily_bun_nc_0, # branching logic
    daily_bun_8a_0,
    daily_cr_nc_0, # branching logic
    daily_cr_8a_0,
    daily_gcs_8a_0,

    ## - Day -1
    dailysofa_perf_m1, # branching logic
    daily_resp_8a_m1, # branching logic
    daily_imv_mode_8a_m1,
    daily_imv_fio2_8a_m1,
    daily_pao2_occur_m1, # branching logic
    daily_pa02_lowest_m1,
    daily_paco2_lowest_m1,
    daily_ph_lowest_m1,
    daily_k_nc_m1, # branching logic
    daily_k_8a_m1,
    daily_na_nc_m1, # branching logic
    daily_na_8a_m1,
    daily_alb_nc_m1, # branching logic
    daily_alb_8a_m1,
    daily_tbili_nc_m1, # branching logic
    daily_tbili_8a_m1,
    daily_hct_nc_m1, # branching logic
    daily_hct_8a_m1,
    daily_wbc_nc_m1, # branching logic
    daily_wbc_8a_m1,
    daily_gluc_nc_m1, # branching logic
    daily_gluc_8a_m1,
    daily_bun_nc_m1, # branching logic
    daily_bun_8a_m1,
    daily_cr_nc_m1, # branching logic
    daily_cr_8a_m1,
    daily_gcs_8a_m1,

    ## - Day -2
    dailysofa_perf_m2, # branching logic
    daily_resp_8a_m2, # branching logic
    daily_imv_mode_8a_m2,
    daily_imv_fio2_8a_m2,
    daily_pao2_occur_m2, # branching logic
    daily_pa02_lowest_m2,
    daily_paco2_lowest_m2,
    daily_ph_lowest_m2,
    daily_k_nc_m2, # branching logic
    daily_k_8a_m2,
    daily_na_nc_m2, # branching logic
    daily_na_8a_m2,
    daily_alb_nc_m2, # branching logic
    daily_alb_8a_m2,
    daily_tbili_nc_m2, # branching logic
    daily_tbili_8a_m2,
    daily_hct_nc_m2, # branching logic
    daily_hct_8a_m2,
    daily_wbc_nc_m2, # branching logic
    daily_wbc_8a_m2,
    daily_gluc_nc_m2, # branching logic
    daily_gluc_8a_m2,
    daily_bun_nc_m2, # branching logic
    daily_bun_8a_m2,
    daily_cr_nc_m2, # branching logic
    daily_cr_8a_m2,
    daily_gcs_8a_m2
  )

data_aps_vars <- data_day0_vars |>
  left_join(
    data_hospitalform_vars,
    by = 'record_id'
  ) |>
  select(
    record_id,

    # day0_vars
    vs_perf, # branching logic
    hightemp_vsorres,
    lowtemp_vsorres,
    highhr_vsorres,
    lowhr_vsorres,
    highrr_vsorres,
    lowrr_vsorres,
    lowsysbp_vsorres,
    lowdbp_vsorres,

    # hospitalform_vars
    ## - Day 0
    dailysofa_perf_0, # branching logic
    daily_resp_8a_0, # branching logic
    daily_imv_mode_8a_0,
    daily_imv_fio2_8a_0,
    daily_pao2_occur_0, # branching logic
    daily_pa02_lowest_0,
    daily_paco2_lowest_0,
    daily_ph_lowest_0,
    daily_k_nc_0, # branching logic
    daily_k_8a_0,
    daily_na_nc_0, # branching logic
    daily_na_8a_0,
    daily_alb_nc_0, # branching logic
    daily_alb_8a_0,
    daily_tbili_nc_0, # branching logic
    daily_tbili_8a_0,
    daily_hct_nc_0, # branching logic
    daily_hct_8a_0,
    daily_wbc_nc_0, # branching logic
    daily_wbc_8a_0,
    daily_gluc_nc_0, # branching logic
    daily_gluc_8a_0,
    daily_bun_nc_0, # branching logic
    daily_bun_8a_0,
    daily_cr_nc_0, # branching logic
    daily_cr_8a_0,
    daily_gcs_8a_0,

    ## - Day -1
    dailysofa_perf_m1, # branching logic
    daily_resp_8a_m1, # branching logic
    daily_imv_mode_8a_m1,
    daily_imv_fio2_8a_m1,
    daily_pao2_occur_m1, # branching logic
    daily_pa02_lowest_m1,
    daily_paco2_lowest_m1,
    daily_ph_lowest_m1,
    daily_k_nc_m1, # branching logic
    daily_k_8a_m1,
    daily_na_nc_m1, # branching logic
    daily_na_8a_m1,
    daily_alb_nc_m1, # branching logic
    daily_alb_8a_m1,
    daily_tbili_nc_m1, # branching logic
    daily_tbili_8a_m1,
    daily_hct_nc_m1, # branching logic
    daily_hct_8a_m1,
    daily_wbc_nc_m1, # branching logic
    daily_wbc_8a_m1,
    daily_gluc_nc_m1, # branching logic
    daily_gluc_8a_m1,
    daily_bun_nc_m1, # branching logic
    daily_bun_8a_m1,
    daily_cr_nc_m1, # branching logic
    daily_cr_8a_m1,
    daily_gcs_8a_m1,

    ## - Day -2
    dailysofa_perf_m2, # branching logic
    daily_resp_8a_m2, # branching logic
    daily_imv_mode_8a_m2,
    daily_imv_fio2_8a_m2,
    daily_pao2_occur_m2, # branching logic
    daily_pa02_lowest_m2,
    daily_paco2_lowest_m2,
    daily_ph_lowest_m2,
    daily_k_nc_m2, # branching logic
    daily_k_8a_m2,
    daily_na_nc_m2, # branching logic
    daily_na_8a_m2,
    daily_alb_nc_m2, # branching logic
    daily_alb_8a_m2,
    daily_tbili_nc_m2, # branching logic
    daily_tbili_8a_m2,
    daily_hct_nc_m2, # branching logic
    daily_hct_8a_m2,
    daily_wbc_nc_m2, # branching logic
    daily_wbc_8a_m2,
    daily_gluc_nc_m2, # branching logic
    daily_gluc_8a_m2,
    daily_bun_nc_m2, # branching logic
    daily_bun_8a_m2,
    daily_cr_nc_m2, # branching logic
    daily_cr_8a_m2,
    daily_gcs_8a_m2
  )
```

## (WIP) Hypotension Severity -- Systematic DAG

**Variable Definition:**

**Summary:**


## Hypotension Severity -- Streamlined DAG

Currently calculated the same as Systematic DAG: Hypotension Severity (see above).

## Active SARS-CoV-2 Infection -- Systematic DAG

**Variable Definition:**

Binary indicator variable

- 0 (No) = If (not positive on OR before Day 0) OR not tested
- 1 (Yes) = If tested positive on OR before Day 0

**Summary:**

```{r}
# Get enrollment times
data_enrollment <- data |>
  filter(event_label == 'Day 0') |>
  select(record_id, enrollment_time)

# Get all positive COVID-19 tests on or before enrollment
data_positive_covid <- data |>
  filter(event_label == 'Hospital Discharge and Summary') |>
  left_join(
    get_code_label_map('cxpos', dictionary),
    by = 'cxpos'
  ) |>
  left_join(
    get_code_label_map('resp_pathogen', dictionary),
    by = 'resp_pathogen'
  ) |>
  filter(cxpos_code == 3 & resp_pathogen_code == 6) |>
  select(record_id, pathogen_date) |>
  left_join(data_enrollment, by = 'record_id') |>
  # Calculate if positive test was on or before enrollment
  mutate(positive_before_enrollment = pathogen_date <= enrollment_time) |>
  # Keep only tests on or before enrollment
  filter(positive_before_enrollment) |>
  # Group by patient and check if ANY test was positive before enrollment
  group_by(record_id) |>
  summarise(has_pos_covid_0 = 1, .groups = 'drop')

# Create final classification for variable
data_active_covid19 <- data_enrollment |>
  left_join(data_positive_covid, by = 'record_id') |>
  mutate(sys_active_covid19_0 = calc_sys_active_covid19_0(
    has_pos_covid_0 = has_pos_covid_0
  )) |>
  select(record_id, sys_active_covid19_0)

data_active_covid19 |>
  count(sys_active_covid19_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```


### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Active SARS-CoV-2 Infection -- Streamlined DAG

Currently calculated the same as Systematic DAG: Active SARS-CoV-2 Infection (see above).

## Active Influenza Infection -- Systematic DAG

**Variable Definition:**

Binary indicator variable

- 0 (No) = If (not positive on OR before Day 0) OR not tested
- 1 (Yes) = If tested positive on OR before Day 0

**Summary:**

```{r}
# Get enrollment times
data_enrollment <- data |>
  filter(event_label == 'Day 0') |>
  select(record_id, enrollment_time)

# Get all positive influenza tests on or before enrollment
data_positive_influenza <- data |>
  filter(event_label == 'Hospital Discharge and Summary') |>
  left_join(
    get_code_label_map('cxpos', dictionary),
    by = 'cxpos'
  ) |>
  left_join(
    get_code_label_map('resp_pathogen', dictionary),
    by = 'resp_pathogen'
  ) |>
  filter(cxpos_code == 3 & resp_pathogen_code %in% c(15, 16)) |>
  select(record_id, pathogen_date) |>
  left_join(data_enrollment, by = 'record_id') |>
  # Calculate if positive test was on or before enrollment
  mutate(positive_before_enrollment = pathogen_date <= enrollment_time) |>
  # Keep only tests on or before enrollment
  filter(positive_before_enrollment) |>
  # Group by patient and check if ANY test was positive before enrollment
  group_by(record_id) |>
  summarise(has_pos_influenza_0 = 1, .groups = 'drop')

# Create final classification for variable
data_active_influenza <- data_enrollment |>
  left_join(data_positive_influenza, by = 'record_id') |>
  mutate(sys_active_influenza_0 = calc_sys_active_influenza_0(
    has_pos_influenza_0 = has_pos_influenza_0
  )) |>
  select(record_id, sys_active_influenza_0)

data_active_influenza |>
  count(sys_active_influenza_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Active Influenza Infection -- Streamlined DAG

Currently calculated the same as Systematic DAG: Active Influenza Infection (see above).


## (WIP) Baseline Performance Status -- Systematic DAG

### Variable 1: Frailty Status

**Variable Definition:**

Derived from `frailty_base`:

- 0 = Not performed
- 1 = Very Fit
- 2 = Fit
- 3 = Managing Well
- 4 = Living with very mild frailty
- 5 = Living with mild frailty
- 6 = Living with moderate frailty
- 7 = Living with severe frailty
- 8 = Living with very severe frailty
- 9 = Terminally ill

**Summary:**

```{r}
data |>
  filter(event_label == "Patient/Surrogate Interview") |>
  left_join(
    get_code_label_map('frailty_base', dictionary),
    by ='frailty_base'
    ) |>
  mutate(sys_frailty_status_0 = calc_sys_frailty_status_0(
    frailty_base_code = frailty_base_code,
    frailty_perf = frailty_perf
  )) |>
  count(sys_frailty_status_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```


### (WIP, BLOCKED) Variable 2: Comorbidity Burden

**Variable Definition:**

**Summary:**

## (WIP) Organ Failure Trajectory -- Systematic DAG

**Variable Definition:**

**Summary:**



## (WIP) Delirium -- Systematic DAG

**Variable Definition:**

**Summary:**

## Delirium -- Streamlined DAG

Currently calculated the same as Systematic DAG: Delirium (see above).


## (WIP) Presence of Sepsis Syndrome -- Systematic DAG

**Variable Definition:**

**Summary:**


## (WIP) Presence of ARDS Syndrome -- Systematic DAG

**Variable Definition:**

**Summary:**


## Presence of ARDS Syndrome -- Streamlined DAG

Currently calculated the same as Systematic DAG: Presence of ARDS Syndrome (see above).

## (WIP) Presence of Pneumonia Syndrome -- Systematic DAG

**Variable Definition:**

**Summary:**


## Presence of Pneumonia Syndrome -- Streamlined DAG

Currently calculated the same as Systematic DAG: Presence of Pneumonia Syndrome (see above).

## (WIP) Septic Shock -- Systematic DAG

**Variable Definition:**

**Summary:**


## (WIP) Septic Shock -- Streamlined DAG

**Variable Definition:**

**Summary:**




## (WIP) Gastrointestinal Bleeding -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) Major Recent Surgery -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) Dementia -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) Acute Allergic Reaction -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) Diffuse Alveolar Hemorrhage -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) Acute Inflammatory Drug Toxicity -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) Acute Cryptogenic Organizing Pneumonia -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) SCAP Criterion Respiratory Rate -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) SCAP Criterion BUN Value -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) SCAP Criterion Acidosis -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) SCAP Criterion Bilateral Opacities -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) SCAP Criterion Leukopenia -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) SCAP Criterion Thrombocytopenia -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) SCAP Criterion Hypothermia -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) Chronic Neuromuscular Disease -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) PSI Score -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) Active Vasculitis -- Streamlined DAG

**Variable Definition:**

**Summary:**
