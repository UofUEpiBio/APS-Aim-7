---
title: "APS Aim 7 Derived Variables Summary"
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Libraries
library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')

## Get support functions
source('support_functions.R')

## Load data from N=500 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load(file = '../aps-data/20250731_data.RData')
```

```{r, echo = FALSE}
# Source variable derivation code
source("R/all.R")
```

## Streamlined DAG: Neuromuscular Blockade

- 0 = No neuromuscular blockade on Day 0 or missing
- 1 = Neuromuscular blockade given on Day 0

### Summary

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(str_nmblockade_0 = calc_str_nmblockade_0(
    daily_paralysis_0 = daily_paralysis_0,
    trx_0 = trx_0
  )) |>
  count(str_nmblockade_0) |>
  gt()
```

### Missingness Report

#### Valid NA Values

These records were correctly missing `daily_paralysis_0` by the branching logic of `trx_0 == 'Not Available'`. They were set to `str_nmblockade_0 = 0` according to the variable definition.

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_paralysis_0) & (trx_0 == 'Not Available')) |>
  select(record_id, daily_paralysis_0, trx_0) |>
  gt()
```

#### Invalid NA Values

These records were incorrectly missing `daily_paralysis_0`:
```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_paralysis_0) & (trx_0 %in% c('Available', NA))) |>
  mutate(missingness = case_when(
    trx_0 == 'Available' ~ 'By branching logic, "daily_paralysis_0" should have a value',
    is.na(trx_0) ~ '"trx_0" is also missing'
  )) |>
  select(record_id, daily_paralysis_0, trx_0, missingness) |>
  gt()
```


## Streamlined DAG: Inflammatory Profile

- 0 = Day 0 CRP not checked
- 1 = Day 0 CRP checked and < 15
- 2 = Day 0 CRP checked and â‰¥ 15

### Summary

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(str_inflamprofile_0 = calc_str_inflamprofile_0(
    daily_crp_8a_0 = daily_crp_8a_0,
    daily_crp_nc_0 = daily_crp_nc_0
  )) |>
  count(str_inflamprofile_0) |>
  gt()
```

### Missingness Report

#### Valid NA Values

All missing values of `daily_crp_8a_0` expected by the branching logic of `daily_crp_nc_0 == 'Not Collected'` were correctly set to `str_inflamprofile_0 = 0` according to the variable definition.

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(str_inflamprofile_0 = calc_str_inflamprofile_0(
    daily_crp_8a_0 = daily_crp_8a_0,
    daily_crp_nc_0 = daily_crp_nc_0
  )) |>
  filter(is.na(daily_crp_8a_0) & (daily_crp_nc_0 == 'Not Collected')) |>
  count(daily_crp_nc_0, daily_crp_8a_0, str_inflamprofile_0) |>
  gt()
```

#### Invalid NA Values

These records were incorrectly missing both `daily_crp_8a_0` and `daily_crp_nc_0`:

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_crp_8a_0) & is.na(daily_crp_nc_0)) |>
  select(record_id, daily_crp_8a_0, daily_crp_nc_0) |>
  gt()
```
