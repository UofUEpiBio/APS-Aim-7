---
title: "APS Aim 7 Derived Variables Summary"
output:
  github_document:
    toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Libraries
library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')

## Get support functions
source('support_functions.R')

## Load data from N=500 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load(file = '../aps-data/20250731_data.RData')
```

```{r, echo = FALSE}
# Source variable derivation code
source("R/steroid-dag-variables.R")
```

## (NEW) Hypotension Severity -- Systematic DAG

**Variable Definition:**

SOFA cardiovascular component score based on mean arterial pressure and vasopressor/inotrope use at 8am on Day 0.

- 0 = No vasopressors/inotropes, MAP ≥70
- 1 = No vasopressors/inotropes, MAP <70
- 2 = Dobutamine or milrinone (with dopamine ≤5 mcg/min/kg and no other vasopressors)
- 3 = On vasopressors with norepinephrine equivalents (NEE) ≤0.1 mcg/min/kg
- 4 = NEE >0.1 mcg/min/kg

Citation for NEE calculation: Goradia S, Sardaneh AA, Narayan SW, Penm J, Patanwala AE. Vasopressor dose equivalence: A scoping review and suggested formula. J Crit Care, 2021;61:233–40.

**Summary:**

```{r}
data_with_hypotension_sev <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  # Remove the weight variable and merge it back in from the "Day 0" event
  select(-m_weight_kg) |>
  left_join(data |>
    filter(event_label == 'Day 0') |>
    select(record_id, m_weight_kg),
    by = 'record_id') |>
  mutate(
    sys_hypotension_sev_0 = calc_sys_hypotension_sev_0(
      daily_vasopressors_0___0,
      daily_vasopressors_0___1,
      daily_vasopressors_0___2,
      daily_vasopressors_0___3,
      daily_vasopressors_0___4,
      daily_vasopressors_0___5,
      daily_vasopressors_0___6,
      daily_vasopressors_0___7,
      daily_vasopressors_0___8,
      daily_vasopressors_0___88,

      daily_sbp_8a_0,
      daily_dbp_8a_0,

      daily_ne_dose_8a_0_mcg,
      daily_ne_dose_8a_0_mcgkg,
      daily_epi_dose_8a_0_mcg,
      daily_epi_dose_8a_0_mcgkg,
      daily_phen_dose_8a_0_mcg,
      daily_phen_dos_8a_0_mcgkg,
      daily_vaso_dose_8a_0,
      daily_dopa_dose_8a_0_mcg,
      daily_dopa_dos_8a_0_mcgkg,
      daily_dobuta_8a_0_mcg,
      daily_dobuta_8a_0_mcgkg,
      daily_ang2_8a_0_mcg,
      daily_ang2_8a_0_mcgkg,
      daily_milr_8a_0_mcg,
      daily_milr_8a_0_mcgkg,

      m_weight_kg
    )
  )

data_with_hypotension_sev |>
  count(sys_hypotension_sev_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### Unknown/Missing Values

The two records missing for this variable are the same ones missing almost all of their labs. These should be queried.

```{r}
data_with_hypotension_sev |>
  filter(is.na(sys_hypotension_sev_0)) |>
  select(
    record_id,
    daily_vasopressors_0___0,
    daily_vasopressors_0___1,
    daily_vasopressors_0___2,
    daily_vasopressors_0___3,
    daily_vasopressors_0___4,
    daily_vasopressors_0___5,
    daily_vasopressors_0___6,
    daily_vasopressors_0___7,
    daily_vasopressors_0___8,
    daily_vasopressors_0___88,

    daily_sbp_8a_0,
    daily_dbp_8a_0,

    daily_ne_dose_8a_0_mcg,
    daily_ne_dose_8a_0_mcgkg,
    daily_epi_dose_8a_0_mcg,
    daily_epi_dose_8a_0_mcgkg,
    daily_phen_dose_8a_0_mcg,
    daily_phen_dos_8a_0_mcgkg,
    daily_vaso_dose_8a_0,
    daily_dopa_dose_8a_0_mcg,
    daily_dopa_dos_8a_0_mcgkg,
    daily_dobuta_8a_0_mcg,
    daily_dobuta_8a_0_mcgkg,
    daily_ang2_8a_0_mcg,
    daily_ang2_8a_0_mcgkg,
    daily_milr_8a_0_mcg,
    daily_milr_8a_0_mcgkg,

    m_weight_kg
  ) |>
  gt()
```


## Hypotension Severity -- Streamlined DAG

Currently calculated the same as Systematic DAG: Hypotension Severity (see above).

## (NEW) Baseline Performance Status -- Systematic DAG

### Variable 1: Frailty Status

**Variable Definition:**

Frailty status derived from Clinical Frailty Scale assessment (`frailty_base`):

- 0 = Not performed
- 1 = Very Fit
- 2 = Fit
- 3 = Managing Well
- 4 = Living with very mild frailty
- 5 = Living with mild frailty
- 6 = Living with moderate frailty
- 7 = Living with severe frailty
- 8 = Living with very severe frailty
- 9 = Terminally ill
- 99 = Unknown

**Summary:**

```{r}
data_with_frailty <- data |>
  filter(event_label == "Patient/Surrogate Interview") |>
  left_join(
    get_code_label_map('frailty_base', dictionary),
    by = 'frailty_base'
  ) |>
  mutate(
    sys_frailty_status_0 = calc_sys_frailty_status_0(
      frailty_base_code = frailty_base_code,
      frailty_perf = frailty_perf
    )
  )

data_with_frailty |>
  count(sys_frailty_status_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### Unknown/Missing Values

No missing or unknown records for this variable.


### Variable 2: Comorbidity Burden

**Variable Definition:**

The weighted van Walraven Elixhauser comorbidity score (Reference: van Walraven et al. Medical Care 2009;47(6):626-633 https://journals.lww.com/lww-medicalcare/fulltext/2009/06000/a_modification_of_the_elixhauser_comorbidity.4.aspx).

**Summary:**

```{r}
data_with_comorbid <- data |>
  filter(event_label == 'Day 0') |>
  # Remove substance use variables and merge them back in from Patient/Surrogate Interview
  select(-c(susubcat___1, susubcat___2, susubcat___3, susubcat___4,
            susubcat___5, susubcat___6, susubcat___7, susubcat___8,
            susubcat___9, susubcat___88, susubcat___99)) |>
  # Join Patient/Surrogate Interview variables (substance use)
  left_join(data |>
    filter(event_label == 'Patient/Surrogate Interview') |>
    select(record_id, susubcat___1, susubcat___2, susubcat___3, susubcat___4,
           susubcat___5, susubcat___6, susubcat___7, susubcat___8,
           susubcat___9, susubcat___88, susubcat___99),
    by = 'record_id') |>
  mutate(
    sys_comorbid_burden_0 = calc_sys_comorbid_burden_0(
      # Cardiovascular conditions
      m_cv_conditions___2,
      m_cv_conditions___5,
      m_cv_conditions___6,
      # Neurologic conditions
      m_neurologic_conditions___4,
      m_neurologic_conditions___5,
      m_neurologic_conditions___1,
      # Pulmonary conditions
      m_pulm_conditions___3,
      # Kidney and liver conditions
      m_kid_liver_conditions___1,
      m_kid_liver_conditions___2,
      # Cancer conditions
      m_cancer_conditions___2,
      m_cancer_conditions___3,
      m_cancer_conditions___4,
      # Psychiatric conditions
      m_psych_conditions___1,
      # Substance use
      susubcat___1,
      susubcat___2,
      susubcat___3,
      susubcat___4,
      susubcat___5,
      susubcat___6,
      susubcat___7,
      susubcat___8,
      susubcat___9,
      susubcat___88,
      susubcat___99
    )
  )

data_with_comorbid |>
  summarize(
    n = n(),
    mean = mean(sys_comorbid_burden_0, na.rm = TRUE),
    sd = sd(sys_comorbid_burden_0, na.rm = TRUE),
    median = median(sys_comorbid_burden_0, na.rm = TRUE),
    min = min(sys_comorbid_burden_0, na.rm = TRUE),
    max = max(sys_comorbid_burden_0, na.rm = TRUE)
  ) |>
  gt()

data_with_comorbid |>
  ggplot(aes(sys_comorbid_burden_0)) +
    geom_histogram(bins = 30) +
    labs(
      title = "Distribution of Comorbidity Burden Score",
      x = "van Walraven Elixhauser Score",
      y = "Count"
    )
```

#### Unknown/Missing Values

The only record missing (NA) was missing all substance abuse data points. This is the `52-0023` record, so doesn't need to be queried.

The reason no others showed up as NA is that we're using checkbox values for all score components, and these are Unchecked by default.

## (NEW) Organ Failure Trajectory -- Systematic DAG

### Variable 1: Total Day 0 SOFA Score

**Variable Definition:**

Total Day 0 SOFA score (sum of 6 component SOFA scores). Value between 0-24.

**Summary:**

```{r}
data_with_sofa_day_0 <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  # Remove the weight variable and merge it back in from the "Day 0" event
  # where weight is collected
  select(-m_weight_kg) |>
  left_join(data |>
    filter(event_label == 'Day 0') |>
    select(record_id, m_weight_kg),
    by='record_id') |>
  mutate(
    sofa_total_day_0 = calc_sys_sofa_total_0(
      daily_pa02_lowest_0,
      daily_resp_lowest_pao2_0,
      daily_fio2_lowest_pao2_0,
      daily_o2_lowest_pao2_0,
      daily_spo2_lowest_0,
      daily_resp_lowest_0,
      daily_fio2_lowest_0,
      daily_o2_lowest_0,
      daily_platelet_8a_0,
      daily_tbili_8a_0,
      daily_sbp_8a_0,
      daily_dbp_8a_0,
      daily_dopa_dose_8a_0_mcg,
      daily_dopa_dos_8a_0_mcgkg,
      daily_dobuta_8a_0_mcg,
      daily_dobuta_8a_0_mcgkg,
      daily_epi_dose_8a_0_mcg,
      daily_epi_dose_8a_0_mcgkg,
      daily_ne_dose_8a_0_mcg,
      daily_ne_dose_8a_0_mcgkg,
      m_weight_kg,
      daily_gcs_8a_0,
      daily_cr_8a_0
    )
  )

data_with_sofa_day_0 |>
  count(sofa_total_day_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### Unknown/Missing Values

These records have missing SOFA scores because one of the inputs is missing and the SOFA calculations don't explicitly assign NA to a SOFA score.

```{r}
data_with_sofa_day_0 |>
  filter(is.na(sofa_total_day_0)) |>
  select(
    record_id,
    dailysofa_perf_0,
    daily_pa02_lowest_0,
    daily_resp_lowest_pao2_0,
    daily_fio2_lowest_pao2_0,
    daily_o2_lowest_pao2_0,
    daily_spo2_lowest_0,
    daily_resp_lowest_0,
    daily_fio2_lowest_0,
    daily_o2_lowest_0,
    daily_platelet_8a_0,
    daily_tbili_8a_0,
    daily_sbp_8a_0,
    daily_dbp_8a_0,
    daily_dopa_dose_8a_0_mcg,
    daily_dopa_dos_8a_0_mcgkg,
    daily_dobuta_8a_0_mcg,
    daily_dobuta_8a_0_mcgkg,
    daily_epi_dose_8a_0_mcg,
    daily_epi_dose_8a_0_mcgkg,
    daily_ne_dose_8a_0_mcg,
    daily_ne_dose_8a_0_mcgkg,
    m_weight_kg,
    daily_gcs_8a_0,
    daily_cr_8a_0
  ) |>
  gt()
```

This is how many of each input are missing:
```{r}
data_with_sofa_day_0 |>
  filter(is.na(sofa_total_day_0)) |>
  select(
    daily_pa02_lowest_0,
    daily_resp_lowest_pao2_0,
    daily_fio2_lowest_pao2_0,
    daily_o2_lowest_pao2_0,
    daily_spo2_lowest_0,
    daily_resp_lowest_0,
    daily_fio2_lowest_0,
    daily_o2_lowest_0,
    daily_platelet_8a_0,
    daily_tbili_8a_0,
    daily_sbp_8a_0,
    daily_dbp_8a_0,
    daily_dopa_dose_8a_0_mcg,
    daily_dopa_dos_8a_0_mcgkg,
    daily_dobuta_8a_0_mcg,
    daily_dobuta_8a_0_mcgkg,
    daily_epi_dose_8a_0_mcg,
    daily_epi_dose_8a_0_mcgkg,
    daily_ne_dose_8a_0_mcg,
    daily_ne_dose_8a_0_mcgkg,
    m_weight_kg,
    daily_gcs_8a_0,
    daily_cr_8a_0
  ) |>
  summarise(across(everything(), ~ sum(is.na(.)))) |>
  pivot_longer(everything(), names_to = "parameter", values_to = "na_count") |>
  arrange(desc(na_count)) |>
  gt()
```
### Variable 2: Total Day -1 SOFA Score

**Variable Definition:**

Total Day -1 SOFA score (sum of 6 component SOFA scores). Value between 0-24.
- `99` not applicable (not in hospital on Day -1)

**Summary:**

```{r}
data_with_sofa_day_m1 <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  # Remove the weight variable and merge it back in from the "Day 0" event
  # where weight is collected
  select(-m_weight_kg) |>
  left_join(data |>
    filter(event_label == 'Day 0') |>
    select(record_id, m_weight_kg),
    by='record_id') |>
  mutate(
    sofa_total_day_m1 = calc_sys_sofa_total_m1(
      dailysofa_perf_m1,
      daily_pa02_lowest_m1,
      daily_resp_lowest_pao2_m1,
      daily_fio2_lowest_pao2_m1,
      daily_o2_lowest_pao2_m1,
      daily_spo2_lowest_m1,
      daily_resp_lowest_m1,
      daily_fio2_lowest_m1,
      daily_o2_lowest_m1,
      daily_platelet_8a_m1,
      daily_tbili_8a_m1,
      daily_sbp_8a_m1,
      daily_dbp_8a_m1,
      daily_dopa_dose_8a_m1_mcg,
      daily_dopa_dos_8a_m1_mcgkg,
      daily_dobuta_8a_m1_mcg,
      daily_dobuta_8a_m1_mcgkg,
      daily_epi_dose_8a_m1_mcg,
      daily_epi_dose_8a_m1_mcgkg,
      daily_ne_dose_8a_m1_mcg,
      daily_ne_dose_8a_m1_mcgkg,
      m_weight_kg,
      daily_gcs_8a_m1,
      daily_cr_8a_m1
    )
  )

data_with_sofa_day_m1 |>
  count(sofa_total_day_m1) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### Unknown/Missing Values

These records have `sofa_total_day_m1 == 99` because `dailysofa_perf_m1 == 'Not Available'`, indicating patient was not in hospital on Day -1.

```{r}
data_with_sofa_day_m1 |>
  filter(sofa_total_day_m1 == 99) |>
  select(
    record_id,
    dailysofa_perf_m1
  ) |>
  gt()
```

These records have missing SOFA scores because one of the inputs is missing and the SOFA calculations don't explicitly assign NA to a SOFA score.

```{r}
data_with_sofa_day_m1 |>
  filter(is.na(sofa_total_day_m1)) |>
  select(
    record_id,
    dailysofa_perf_m1,
    daily_pa02_lowest_m1,
    daily_resp_lowest_pao2_m1,
    daily_fio2_lowest_pao2_m1,
    daily_o2_lowest_pao2_m1,
    daily_spo2_lowest_m1,
    daily_resp_lowest_m1,
    daily_fio2_lowest_m1,
    daily_o2_lowest_m1,
    daily_platelet_8a_m1,
    daily_tbili_8a_m1,
    daily_sbp_8a_m1,
    daily_dbp_8a_m1,
    daily_dopa_dose_8a_m1_mcg,
    daily_dopa_dos_8a_m1_mcgkg,
    daily_dobuta_8a_m1_mcg,
    daily_dobuta_8a_m1_mcgkg,
    daily_epi_dose_8a_m1_mcg,
    daily_epi_dose_8a_m1_mcgkg,
    daily_ne_dose_8a_m1_mcg,
    daily_ne_dose_8a_m1_mcgkg,
    m_weight_kg,
    daily_gcs_8a_m1,
    daily_cr_8a_m1
  ) |>
  gt()
```

This is how many of each input are missing:
```{r}
data_with_sofa_day_m1 |>
  filter(is.na(sofa_total_day_m1)) |>
  select(
    daily_pa02_lowest_m1,
    daily_resp_lowest_pao2_m1,
    daily_fio2_lowest_pao2_m1,
    daily_o2_lowest_pao2_m1,
    daily_spo2_lowest_m1,
    daily_resp_lowest_m1,
    daily_fio2_lowest_m1,
    daily_o2_lowest_m1,
    daily_platelet_8a_m1,
    daily_tbili_8a_m1,
    daily_sbp_8a_m1,
    daily_dbp_8a_m1,
    daily_dopa_dose_8a_m1_mcg,
    daily_dopa_dos_8a_m1_mcgkg,
    daily_dobuta_8a_m1_mcg,
    daily_dobuta_8a_m1_mcgkg,
    daily_epi_dose_8a_m1_mcg,
    daily_epi_dose_8a_m1_mcgkg,
    daily_ne_dose_8a_m1_mcg,
    daily_ne_dose_8a_m1_mcgkg,
    m_weight_kg,
    daily_gcs_8a_m1,
    daily_cr_8a_m1
  ) |>
  summarise(across(everything(), ~ sum(is.na(.)))) |>
  pivot_longer(everything(), names_to = "parameter", values_to = "na_count") |>
  arrange(desc(na_count)) |>
  gt()
```


## Delirium -- Systematic DAG

**Variable Definition:**

Three-level variable:

- 0 = CAM done and not present (negative on all assessments)
- 1 = CAM done and present (positive at least once)
- 2 = CAM not done

**Summary:**

```{r}
data_with_delirium <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    sys_delirium_0 = calc_sys_delirium_0(
      cam_0 = cam_0,
      cam_m1 = cam_m1,
      cam_m2 = cam_m2,

      lowrass_orres_0 = lowrass_orres_0,
      lowrass_orres_m1 = lowrass_orres_m1,
      lowrass_orres_m2 = lowrass_orres_m2,

      highestrass_orres_0 = highestrass_orres_0,
      highestrass_orres_m1 = highestrass_orres_m1,
      highestrass_orres_m2 = highestrass_orres_m2
    )
  )

data_with_delirium |>
  count(sys_delirium_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Delirium -- Streamlined DAG

Currently calculated the same as Systematic DAG: Delirium (see above).


## Presence of Sepsis Syndrome -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Syndrome not present OR syndrome not present on or before Day 0
- 1 = Syndrome present AND syndrome present on or before Day 0
- 99 = Unknown

**Summary:**

```{r}
data_with_sepsis <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  mutate(
    sys_sepsis_0 = calc_sys_sepsis_0(
      sepsis_present,
      sepsis_clinical_judgement
    )
  )

data_with_sepsis |>
  count(sys_sepsis_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because they were missing (NA) `sepsis_present` and have `sepsis_clinical_judgement == 'Unknown'`. These should be queried.

```{r}
data_with_sepsis |>
  filter(sys_sepsis_0 == 99) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement
  ) |>
  gt()
```

This record was missing (NA) `sepsis_present` but had `sepsis_clinical_judgement == 'Yes'`. This should be queried.

```{r}
data_with_sepsis |>
  filter(is.na(sys_sepsis_0)) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement
  ) |>
  gt()
```

## Presence of ARDS Syndrome -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Syndrome not present OR syndrome not present on or before Day 0
- 1 = Syndrome present AND syndrome present on or before Day 0
- 99 = Unknown

**Summary:**

```{r}
data_with_ards <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  mutate(
    sys_ards_0 = calc_sys_ards_0(
      ards_present,
      ards_clinical_judgement
    )
  )

data_with_ards |>
  count(sys_ards_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

There are no unknown or missing values for this variable.


## Presence of ARDS Syndrome -- Streamlined DAG

Currently calculated the same as Systematic DAG: Presence of ARDS Syndrome (see above).

## Presence of Pneumonia Syndrome -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Syndrome not present on or before Day 0
- 1 = Syndrome present on or before Day 0
- 99 = Unknown

**Summary:**

```{r}
data_with_pneumonia <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  mutate(
    sys_pneumonia_0 = calc_sys_pneumonia_0(
      pna_clinical_judgement
    )
  )

data_with_pneumonia |>
  count(sys_pneumonia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```
### Unknown/Missing Values

These records have `pna_clinical_judgement == 'Unknown'`:

```{r}
data_with_pneumonia |>
  filter(sys_pneumonia_0 == 99) |>
  select(
    record_id,
    pna_clinical_judgement
  ) |>
  gt()
```

## Presence of Pneumonia Syndrome -- Streamlined DAG

Currently calculated the same as Systematic DAG: Presence of Pneumonia Syndrome (see above).

## Septic Shock Variables (Systematic and Streamlined)
```{r}
# Get weight data
data_with_weight <- data |>
  filter(event_label == 'Day 0') |>
  select(
    record_id,
    m_weight_kg
  )

# Get vasopressor data
data_with_vasopressors <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  select(
    record_id,
    daily_vasopressors_0___0,
    daily_sbp_8a_0,
    daily_dbp_8a_0,
    daily_ne_dose_8a_0_mcg,
    daily_ne_dose_8a_0_mcgkg,
    daily_epi_dose_8a_0_mcg,
    daily_epi_dose_8a_0_mcgkg,
    daily_phen_dose_8a_0_mcg,
    daily_phen_dos_8a_0_mcgkg,
    daily_vaso_dose_8a_0,
    daily_dopa_dose_8a_0_mcg,
    daily_dopa_dos_8a_0_mcgkg,
    daily_dobuta_8a_0_mcg,
    daily_dobuta_8a_0_mcgkg,
    daily_ang2_8a_0_mcg,
    daily_ang2_8a_0_mcgkg,
    daily_milr_8a_0_mcg,
    daily_milr_8a_0_mcgkg
  )

# Get sepsis data
data_with_sepsis <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement
  )
```
## (NEW) Septic Shock -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Septic shock not present on/before Day 0
- 1 = Septic shock present on/before Day 0 AND on vasopressor at 8am on Day 0 AND vasopressor dose > 0.5 norepinephrine equivalents
- 99 = Unknown

**Summary:**

```{r}
data_with_sys_septic_shock <- data_with_weight |>
  left_join(data_with_vasopressors, by = 'record_id') |>
  left_join(data_with_sepsis, by = 'record_id') |>
  mutate(
    sys_septic_shock_0 = calc_sys_septic_shock_0(
      sepsis_present = sepsis_present,
      sepsis_clinical_judgement = sepsis_clinical_judgement,

      daily_vasopressors_0___0 = daily_vasopressors_0___0,
      daily_sbp_8a_0 = daily_sbp_8a_0,
      daily_dbp_8a_0 = daily_dbp_8a_0,
      daily_ne_dose_8a_0_mcg = daily_ne_dose_8a_0_mcg,
      daily_ne_dose_8a_0_mcgkg = daily_ne_dose_8a_0_mcgkg,
      daily_epi_dose_8a_0_mcg = daily_epi_dose_8a_0_mcg,
      daily_epi_dose_8a_0_mcgkg = daily_epi_dose_8a_0_mcgkg,
      daily_phen_dose_8a_0_mcg = daily_phen_dose_8a_0_mcg,
      daily_phen_dos_8a_0_mcgkg = daily_phen_dos_8a_0_mcgkg,
      daily_vaso_dose_8a_0 = daily_vaso_dose_8a_0,
      daily_dopa_dose_8a_0_mcg = daily_dopa_dose_8a_0_mcg,
      daily_dopa_dos_8a_0_mcgkg = daily_dopa_dos_8a_0_mcgkg,
      daily_dobuta_8a_0_mcg = daily_dobuta_8a_0_mcg,
      daily_dobuta_8a_0_mcgkg = daily_dobuta_8a_0_mcgkg,
      daily_ang2_8a_0_mcg = daily_ang2_8a_0_mcg,
      daily_ang2_8a_0_mcgkg = daily_ang2_8a_0_mcgkg,
      daily_milr_8a_0_mcg = daily_milr_8a_0_mcg,
      daily_milr_8a_0_mcgkg = daily_milr_8a_0_mcgkg,

      m_weight_kg = m_weight_kg
    )
  )

data_with_sys_septic_shock |>
  count(sys_septic_shock_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because they have `sepsis_clinical_judgement == 'Unknown'` and are missing `sepsis_present`. They are all also recorded as Unknown in "Presence of Sepsis Syndrome Systematic DAG" (above). These should be queried.

```{r}
data_with_sys_septic_shock |>
  filter(sys_septic_shock_0 == 99) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement,
    daily_vasopressors_0___0,
    daily_sbp_8a_0,
    daily_dbp_8a_0,
    daily_ne_dose_8a_0_mcg,
    daily_ne_dose_8a_0_mcgkg,
    daily_epi_dose_8a_0_mcg,
    daily_epi_dose_8a_0_mcgkg,
    daily_phen_dose_8a_0_mcg,
    daily_phen_dos_8a_0_mcgkg,
    daily_vaso_dose_8a_0,
    daily_dopa_dose_8a_0_mcg,
    daily_dopa_dos_8a_0_mcgkg,
    daily_dobuta_8a_0_mcg,
    daily_dobuta_8a_0_mcgkg,
    daily_ang2_8a_0_mcg,
    daily_ang2_8a_0_mcgkg,
    daily_milr_8a_0_mcg,
    daily_milr_8a_0_mcgkg,
    m_weight_kg
  ) |>
  gt()
```

No missing records for this variable.

## (NEW) Septic Shock -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Septic shock not present on/before Day 0
- 1 = Septic shock present on/before Day 0 AND on vasopressor at 8am on Day 0
- 99 = Unknown

**Summary:**

```{r}
data_with_str_septic_shock <- data_with_vasopressors |>
  left_join(data_with_sepsis, by = 'record_id') |>
  mutate(
    str_septic_shock_0 = calc_str_septic_shock_0(
      sepsis_present = sepsis_present,
      sepsis_clinical_judgement = sepsis_clinical_judgement,
      daily_vasopressors_0___0 = daily_vasopressors_0___0
    )
  )

data_with_str_septic_shock |>
  count(str_septic_shock_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because they have `sepsis_clinical_judgement == 'Unknown'` and are missing `sepsis_present`. They are all also recorded as Unknown in "Presence of Sepsis Syndrome Systematic DAG" (above). These should be queried.

```{r}
data_with_str_septic_shock |>
  filter(str_septic_shock_0 == 99) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement,
    daily_vasopressors_0___0
  ) |>
  gt()
```

These record were missing (NA) because they are missing `sepsis_present` and `sepsis_clinical_judgement` and `daily_vasopressors_0___0` is unchecked (indicated patient is not on vasopressors).

```{r}
data_with_str_septic_shock |>
  filter(is.na(str_septic_shock_0)) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement,
    daily_vasopressors_0___0
  ) |>
  gt()
```

## (NEW) Gastrointestinal Bleeding -- Streamlined DAG

**Variable Definition:**

Continuous variable summing total number of packed red blood cell units
transfused on study days -2 to 0.

**Summary:**

```{r}
data_with_gi_bleeding <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_gi_bleeding_0 = calc_str_gi_bleeding_0(
      blood_prbc_units_m2 = blood_prbc_units_m2,
      blood_prbc_units_m1 = blood_prbc_units_m1,
      blood_prbc_units_0 = blood_prbc_units_0,
      daily_blood_product_m2 = daily_blood_product_m2,
      daily_blood_product_m1 = daily_blood_product_m1,
      daily_blood_product_0 = daily_blood_product_0,
      blood_product_spec_m2___1 = blood_product_spec_m2___1,
      blood_product_spec_m1___1 = blood_product_spec_m1___1,
      blood_product_spec_0___1 = blood_product_spec_0___1
    )
  )

data_with_gi_bleeding |>
  select(str_gi_bleeding_0) |>
  filter(!is.na(str_gi_bleeding_0) & str_gi_bleeding_0 > -1) |>
  ggplot(aes(str_gi_bleeding_0)) +
    geom_histogram(bins = 40)
```



### Unknown/Missing Values

This many records are missing (NA):

```{r}
data_with_gi_bleeding |>
  filter(is.na(str_gi_bleeding_0)) |>
  count()
```

This is because of an invalid branching logic on one of the three days (typically Day -2), which causes the whole count to be NA.

```{r}
data_with_gi_bleeding |>
  filter(is.na(str_gi_bleeding_0)) |>
  select(
    record_id,

    trx_0,
    daily_blood_product_0,
    blood_product_spec_0___1,
    blood_prbc_units_0,

    trx_m1,
    daily_blood_product_m1,
    blood_product_spec_m1___1,
    blood_prbc_units_m1,

    trx_m2,
    daily_blood_product_m2,
    blood_product_spec_m2___1,
    blood_prbc_units_m2
  ) |>
  gt()
```

## Major Recent Surgery -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 = No surgery on Day -2, Day -1, AND Day 0
- 1 = Surgery on Day -2, Day -1, OR Day 0

**Note:** The surgery description fields aren't necessarily part of this variable, but they should be in the dataset, since they are defined in the dictionary. We will need to follow up to find out how we can get access to those fields. They may have been removed as part of de-identification.

**Summary:**

```{r}
data_with_major_surgery <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_major_surgery_0 = calc_str_major_surgery_0(
      daily_surgery_m2,
      daily_surgery_m1,
      daily_surgery_0
    )
  )

data_with_major_surgery |>
  count(str_major_surgery_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

No missing values for Major Recent Surgery.

## Dementia -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = No dementia history
- 1 = Dementia history
- 99 = Unknown

**Summary:**

```{r}
data_with_dementia <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_dementia_0 = calc_str_dementia_0(
      m_neurologic_conditions___1,
      m_neurologic
    )
  )

data_with_dementia |>
  count(str_dementia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because `m_neurologic == "Unknown"`:

```{r}
data_with_dementia |>
  filter(str_dementia_0 == 99) |>
  select(
    record_id,
    m_neurologic_conditions___1,
    m_neurologic
  ) |>
  gt()
```

One record was missing (NA) `m_neurologic`, but this is the same record missing from the N=500 dataset and does not need to be queried further.

## Acute Allergic Reaction -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = No suspected anaphylaxis if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected anaphylaxis if `organ_dysnfx_cause` = 2

**NOTE:** The variables "Acute Allergic Reaction", "Diffuse Alveolar Hemorrhage", "Acute Inflammatory Drug Toxicity", and "Acute Cryptogenic Organizing Pneumonia" are currently identical. This is because they require additional free-text information paired with `organ_dysnfx_cause == 2` to determine whether a patient meets criteria. These should be quick information gathered from physicians, but the team will need to determine how to best proceed.

**Summary:**

```{r}
data_with_allergic <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_acute_allergic_reaction_0 = calc_str_acute_allergic_reaction_0(
      organ_dysfnx_cause_code
    )
  )

data_with_allergic |>
  count(str_acute_allergic_reaction_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Diffuse Alveolar Hemorrhage -- Streamlined DAG

**Variable Definition:**

Binary variable (likely not used in primary analysis):

- 0 = No DAH if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected DAH if `organ_dysnfx_cause` = 2

**NOTE:** The variables "Acute Allergic Reaction", "Diffuse Alveolar Hemorrhage", "Acute Inflammatory Drug Toxicity", and "Acute Cryptogenic Organizing Pneumonia" are currently identical. This is because they require additional free-text information paired with `organ_dysnfx_cause == 2` to determine whether a patient meets criteria. These should be quick information gathered from physicians, but the team will need to determine how to best proceed.

**Summary:**

```{r}
data_with_dah <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_dah_0 = calc_str_dah_0(
      organ_dysfnx_cause_code
    )
  )

data_with_dah |>
  count(str_dah_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Acute Inflammatory Drug Toxicity -- Streamlined DAG

**Variable Definition:**

Binary variable (likely not used in primary analysis):

- 0 = No acute inflammatory drug reaction if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected acute inflammatory drug reaction if `organ_dysnfx_cause` = 2

**NOTE:** The variables "Acute Allergic Reaction", "Diffuse Alveolar Hemorrhage", "Acute Inflammatory Drug Toxicity", and "Acute Cryptogenic Organizing Pneumonia" are currently identical. This is because they require additional free-text information paired with `organ_dysnfx_cause == 2` to determine whether a patient meets criteria. These should be quick information gathered from physicians, but the team will need to determine how to best proceed.

**Summary:**

```{r}
data_with_drug_toxicity <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_drug_toxicity_0 = calc_str_drug_toxicity_0(
      organ_dysfnx_cause_code
    )
  )

data_with_drug_toxicity |>
  count(str_drug_toxicity_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Acute Cryptogenic Organizing Pneumonia -- Streamlined DAG

**Variable Definition:**

Binary variable (likely not used in primary analysis):

- 0 = No acute COP if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected acute COP if `organ_dysnfx_cause` = 2

**NOTE:** The variables "Acute Allergic Reaction", "Diffuse Alveolar Hemorrhage", "Acute Inflammatory Drug Toxicity", and "Acute Cryptogenic Organizing Pneumonia" are currently identical. This is because they require additional free-text information paired with `organ_dysnfx_cause == 2` to determine whether a patient meets criteria. These should be quick information gathered from physicians, but the team will need to determine how to best proceed.

**Summary:**

```{r}
data_with_cop <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_cop_0 = calc_str_cop_0(
      organ_dysfnx_cause_code
    )
  )

data_with_cop |>
  count(str_cop_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## SCAP Criterion Respiratory Rate -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 daily value. If that's not available, use last
value carried forward from Day -1 or Day -2.

- 0 = Respiratory rate ≤ 30
- 1 = Respiratory rate > 30

Respiratory rate is based on the respiratory support type. Check the support type for Day 0 and look for the associated respiratory rate variable. If missing, repeat for Day -1 then again for Day -2. If still missing after that, treat as missing (NA). For ECMO without IMV (2), No resp support at all (7), Unknown (99) use `highrr_vsorres` (for all days, even though only measured on Day 0).

**Summary:**

```{r}
data_with_highrr_vsorres <- data |>
  filter(event_label == 'Day 0') |>
  select(
    record_id,
    highrr_vsorres
  )

data_with_scap_rr <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  left_join(
    get_code_label_map("daily_resp_8a_0", dictionary),
    by = "daily_resp_8a_0"
  ) |>
  left_join(
    get_code_label_map("daily_resp_8a_m1", dictionary),
    by = "daily_resp_8a_m1"
  ) |>
  left_join(
    get_code_label_map("daily_resp_8a_m2", dictionary),
    by = "daily_resp_8a_m2"
  ) |>
  select(
    record_id,

    daily_resp_8a_0_code,
    daily_resp_8a_m1_code,
    daily_resp_8a_m2_code,

    daily_hfnc_rr_8a_0,
    daily_hfnc_rr_8a_m1,
    daily_hfnc_rr_8a_m2,

    daily_niv_rr_8a_0,
    daily_niv_rr_8a_m1,
    daily_niv_rr_8a_m2,

    daily_standard_rr_8a_0,
    daily_standard_rr_8a_m1,
    daily_standard_rr_8a_m2,

    daily_resp_rate_8a_0,
    daily_resp_rate_8a_m1,
    daily_resp_rate_8a_m2
  ) |>
  left_join(
    data_with_highrr_vsorres,
    by = "record_id"
  ) |>
  mutate(
    str_scap_rr_0 = calc_str_scap_rr_0(
      daily_resp_8a_0_code,
      daily_resp_8a_m1_code,
      daily_resp_8a_m2_code,

      daily_hfnc_rr_8a_0,
      daily_hfnc_rr_8a_m1,
      daily_hfnc_rr_8a_m2,

      daily_niv_rr_8a_0,
      daily_niv_rr_8a_m1,
      daily_niv_rr_8a_m2,

      daily_standard_rr_8a_0,
      daily_standard_rr_8a_m1,
      daily_standard_rr_8a_m2,

      daily_resp_rate_8a_0,
      daily_resp_rate_8a_m1,
      daily_resp_rate_8a_m2,

      highrr_vsorres
    )
  )

data_with_scap_rr |>
  count(str_scap_rr_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

There are 3 missing (NA) records for this variable:

```{r}
data_with_scap_rr |>
  filter(is.na(str_scap_rr_0)) |>
  select(record_id) |>
  gt()
```

These reasons for missingness are similar for the records `45-0011` and `45-0015`. Both records have missing values that should be queried.

- **Day 0:** Both missing a measurement for `daily_resp_rate_8a_0` in violation of the branching logic. Both have a `daily_resp_8a_0` (respiratory support type) of `3 (IMV without ECMO)`. According to the branching logic, this means they should both have a value for `daily_imv_mode_8a_0`. Record `45-0011` has a value, while `45-0015` does not. Record `45-0011` has `daily_imv_mode_8a_0 == 3 (PRVC/APV)`. According to the branching logic, this record should then have a `daily_resp_rate_8a_0` measurement, which it does not.
- **Day -1:** Record `45-0015` has `daily_resp_8a_0 == 3 (IMV without ECMO)`, but with the same problems as Day 0. However, record `45-0011` has `daily_resp_8a_0 == 6 (Standard flow)`. According to the branching logic, this record should then have a value for `daily_resp_8a_m1`, but it is missing.
- **Day -2:** Both records are missing `daily_resp_8a_m2` and everything that follows.


```{r}
data |>
  filter(record_id %in% c('45-0011', '45-0015')) |>
  left_join(
    get_code_label_map("daily_resp_8a_0", dictionary),
    by = "daily_resp_8a_0"
  ) |>
  left_join(
    get_code_label_map("daily_resp_8a_m1", dictionary),
    by = "daily_resp_8a_m1"
  ) |>
  left_join(
    get_code_label_map("daily_resp_8a_m2", dictionary),
    by = "daily_resp_8a_m2"
  ) |>
  filter(event_label %in% c("Daily In-Hospital Forms")) |>
  select(
    record_id,

    # Day 0
    daily_resp_8a_0_code,
    daily_resp_8a_0,
    daily_imv_mode_8a_0,
    daily_resp_rate_8a_0,

    # Day -1
    daily_resp_8a_m1_code,
    daily_resp_8a_m1,
    daily_resp_rate_8a_m1,
    daily_standard_rr_8a_m1,

    # Day -2
    daily_resp_8a_m2_code,
    daily_resp_8a_m2
  ) |>
  gt()
```

Record `63-0008` is different, in that it has `dailysofa_perf_* == 'Not Available'` for all three days. This technically satisfies the branching logic for having a missing `daily_resp_8a_0`. We either need to query this or adapt the variable definition to account for this. **Note:** If we choose to assign `dailysofa_perf_* == 'Not Available'` to `highrr_vsorres` (treating it like "no respiratory support"), then both of the other missing records (described above) will also be classified that way as they both have `dailysofa_perf_m2 == 'Not Available'`.

```{r}
data |>
  filter(record_id == '63-0008') |>
  filter(event_label %in% c("Daily In-Hospital Forms")) |>
  select(
    record_id,

    dailysofa_perf_0,
    daily_resp_8a_0,
    dailysofa_perf_m1,
    daily_resp_8a_m1,
    dailysofa_perf_m2,
    daily_resp_8a_m2
  ) |>
  gt()
```


```{r}
data_with_scap_rr |>
  filter(is.na(str_scap_rr_0)) |>
  filter(record_id == '63-0008') |>
  select(
    record_id,

    highrr_vsorres,

    daily_resp_8a_0_code,
    # daily_resp_8a_m1_code,
    # daily_resp_8a_m2_code,

    daily_hfnc_rr_8a_0,
    # daily_hfnc_rr_8a_m1,
    # daily_hfnc_rr_8a_m2,

    daily_niv_rr_8a_0,
    # daily_niv_rr_8a_m1,
    # daily_niv_rr_8a_m2,

    daily_standard_rr_8a_0,
    # daily_standard_rr_8a_m1,
    # daily_standard_rr_8a_m2,

    daily_resp_rate_8a_0,
    # daily_resp_rate_8a_m1,
    # daily_resp_rate_8a_m2
  ) |>
  gt()
```

## SCAP Criterion BUN Value -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 daily value. If that's not available, use last
value carried forward from Day -1 or Day -2:

- 0 = BUN <= 30 mg/dL
- 1 = BUN > 30 mg/dL

**Summary:**

```{r}
data_with_scap_bun <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_bun_0 = calc_str_scap_bun_0(
      daily_bun_8a_0,
      daily_bun_8a_m1,
      daily_bun_8a_m2
    )
  )

data_with_scap_bun |>
  count(str_scap_bun_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were missing (NA). Most of these are due to valid branching logic (daily_bun was 'Not Collected'), but a few records were missing all `daily_bun_nc_*`/`daily_bun_8a_*` pairs, which violates the branching logic (should be mutually exclusive). These should be queried.

```{r}
data_with_scap_bun |>
  filter(is.na(str_scap_bun_0)) |>
  select(
    record_id,

    daily_bun_nc_0,
    daily_bun_8a_0,

    daily_bun_nc_m1,
    daily_bun_8a_m1,

    daily_bun_nc_m2,
    daily_bun_8a_m2
  ) |>
  gt()
```

## SCAP Criterion Acidosis -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 daily lowest. If that's not available, use last
value carried forward from Day -1 or Day -2:

- 0 = pH ≥ 7.30
- 1 = pH < 7.30

**Summary:**

```{r}
data_with_scap_acidosis <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_acidosis_0 = calc_str_scap_acidosis_0(
      daily_ph_lowest_0,
      daily_ph_lowest_m1,
      daily_ph_lowest_m2
    )
  )

data_with_scap_acidosis |>
  count(str_scap_acidosis_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable. That is, in part, because we treat missing `daily_ph_lowest_*` value as `0 (no Acidosis)`.

## SCAP Criterion Bilateral Opacities -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = (all) `*_opacity != 2`
- 1 = (any) `*_opacity == 2`

**Summary:**

```{r}
data_with_scap_bilat_opac <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map("cxr_dm2_opacity", dictionary),
    by = "cxr_dm2_opacity"
  ) |>
  left_join(
    get_code_label_map("ct_dm2_opacity", dictionary),
    by = "ct_dm2_opacity"
  ) |>
  left_join(
    get_code_label_map("cxr_dm1_opacity", dictionary),
    by = "cxr_dm1_opacity"
  ) |>
  left_join(
    get_code_label_map("ct_dm1_opacity", dictionary),
    by = "ct_dm1_opacity"
  ) |>
  left_join(
    get_code_label_map("cxr_d0_opacity", dictionary),
    by = "cxr_d0_opacity"
  ) |>
  left_join(
    get_code_label_map("ct_d0_opacity", dictionary),
    by = "ct_d0_opacity"
  ) |>
  mutate(
    str_scap_bilateral_opacities_0 = calc_str_scap_bilateral_opacities_0(
      cxr_dm2_available,
      cxr_dm2_opacity_code,
      ct_dm2_available,
      ct_dm2_opacity_code,
      cxr_dm1_available,
      cxr_dm1_opacity_code,
      ct_dm1_available,
      ct_dm1_opacity_code,
      cxr_d0_available,
      cxr_d0_opacity_code,
      ct_d0_available,
      ct_d0_opacity_code
    )
  )

data_with_scap_bilat_opac |>
  count(str_scap_bilateral_opacities_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were missing (NA) imaging data for one or more days and should be queried.

```{r}
data_with_scap_bilat_opac |>
  filter(is.na(str_scap_bilateral_opacities_0)) |>
  select(
    record_id,
    cxr_dm2_available,
    cxr_dm2_opacity,
    ct_dm2_available,
    ct_dm2_opacity,
    cxr_dm1_available,
    cxr_dm1_opacity,
    ct_dm1_available,
    ct_dm1_opacity,
    cxr_d0_available,
    cxr_d0_opacity,
    ct_d0_available,
    ct_d0_opacity
  ) |>
  gt()
```

## SCAP Criterion Leukopenia -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 value from daily assessment data. If that's not
available, use last value carried forward from Day -1 or Day -2:

- 0 = WBC >= 4
- 1 = WBC < 4

**Summary:**

```{r}
data_with_scap_leukopenia <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_leukopenia_0 = calc_str_scap_leukopenia_0(
      daily_wbc_8a_0,
      daily_wbc_8a_m1,
      daily_wbc_8a_m2
    )
  )

data_with_scap_leukopenia |>
  count(str_scap_leukopenia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were missing (NA) because they are missing all `daily_wbc_nc_*`/`daily_wbc_8a_*` pairs. This is invalid branching logic, because each pair is supposed to be mutually exclusive.

```{r}
data_with_scap_leukopenia |>
  filter(is.na(str_scap_leukopenia_0)) |>
  select(
    record_id,
    daily_wbc_nc_0,
    daily_wbc_8a_0,

    daily_wbc_nc_m1,
    daily_wbc_8a_m1,

    daily_wbc_nc_m2,
    daily_wbc_8a_m2
  ) |>
  gt()
```

## SCAP Criterion Thrombocytopenia -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 value from daily assessment data. If that's not
available, use last value carried forward from Day -1 or Day -2:

- 0 = Platelets >= 100
- 1 = Platelets < 100

**Summary:**

```{r}
data_with_scap_thrombocyt <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_thrombocytopenia_0 = calc_str_scap_thrombocytopenia_0(
      daily_platelet_8a_0,
      daily_platelet_8a_m1,
      daily_platelet_8a_m2
    )
  )

data_with_scap_thrombocyt |>
  count(str_scap_thrombocytopenia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were missing (NA) because they are missing all `daily_platelet_nc_*`/`daily_platelet_8a_*` pairs. This is invalid branching logic, because each pair is supposed to be mutually exclusive.

```{r}
data_with_scap_thrombocyt |>
  filter(is.na(str_scap_thrombocytopenia_0)) |>
  select(
    record_id,
    daily_platelet_nc_0,
    daily_platelet_8a_0,

    daily_platelet_nc_m1,
    daily_platelet_8a_m1,

    daily_platelet_nc_m2,
    daily_platelet_8a_m2
  ) |>
  gt()
```

## SCAP Criterion Hypothermia -- Streamlined DAG

**Variable Definition:**

Binary variable from the "Vital signs day 0" form. If that's not available,
use last value carried forward from Day -1 or Day -2:

- 0 = Temperature ≥ 35.0°C
- 1 = Temperature < 35.0°C

**Summary:**

```{r}
data_with_scap_hypothermia <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_scap_hypothermia_0 = calc_str_scap_hypothermia_0(
      lowtemp_vsorres
    )
  )

data_with_scap_hypothermia |>
  count(str_scap_hypothermia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were missing (NA) `lowtemp_vsorres`. One record is the one missing from the N=500 dataset (`52-0023`) and doesn't need to be queried. The other has `vs_perf == 'No'` so the missing `lowtemp_vsorres` is valid branching logic, but since all patients should have their Day 0 vital signs, this should be queried.

```{r}
data_with_scap_hypothermia |>
  filter(is.na(str_scap_hypothermia_0)) |>
  select(
    record_id,
    vs_perf,
    lowtemp_vsorres
  ) |>
  gt()
```

## Chronic Neuromuscular Disease -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = No chronic neuromuscular disease history
- 1 = Chronic neuromuscular disease history
- 99 = Unknown

**Summary:**

```{r}
data_with_neuromuscular <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_neuromuscular_disease_0 = calc_str_neuromuscular_disease_0(
      m_neurologic_conditions___6,
      m_neurologic
    )
  )

data_with_neuromuscular |>
  count(str_neuromuscular_disease_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because `m_neurologic == 'Unknown'`:

```{r}
data_with_neuromuscular |>
  filter(str_neuromuscular_disease_0 == 99) |>
  select(
    record_id,
    m_neurologic_conditions___6,
    m_neurologic
  ) |>
  gt()
```

The only missing (NA) record is the same one missing from the N=500 dataset and doesn't need to be queried further.

## (NEW) PSI Score -- Streamlined DAG

**Variable Definition:**

PSI score calculated per formula in the original reference
(https://pubmed.ncbi.nl.nih.gov/8995086/)

Inputs to PSI score:

**Demographics:**
- Age (age in years = points)
- Female sex (–10 points)
- Nursing home resident (+10 points)

**Coexisting Illnesses:**
- Congestive heart failure (+10 points)
- Cerebrovascular disease (+10 points) [Prior stroke OR Prior TIA]
- Neoplastic disease (+30 points)
- Renal disease (+10 points) [Chronic kidney disease]
- Liver disease (+20 points) [Cirrhosis]

**Physical Examination Findings:**
- Altered mental status (+20 points)
- Pulse ≥ 125/min (+10 points)
- Respiratory rate ≥ 30/min (+20 points)
- Systolic blood pressure < 90 mm Hg (+20 points)
- Temperature < 35°C or ≥ 40°C (+15 points)

**Laboratory and Radiographic Findings:**
- Blood urea nitrogen ≥ 30 mg/dl (+20 points)
- Glucose ≥ 250 mg/dl (+10 points)
- Hematocrit < 30% (+10 points)
- Sodium < 130 mmol/liter (+20 points)
- PaO2 < 60 mm Hg (+10 points)
- Arterial pH < 7.35 (+30 points)
- Pleural effusion (+10 points)

**Summary:**

```{r}
data_with_psi <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  # Remove variables from other events and merge them back in
  select(-c(age, sex, prssrc,
            m_cv_conditions___2, m_neurologic_conditions___2, m_neurologic_conditions___3,
            m_cancer, m_kid_liver_conditions___1, m_kid_liver_conditions___2,
            highhr_vsorres, highrr_vsorres, lowsysbp_vsorres, lowtemp_vsorres, hightemp_vsorres,
            pna_effusion)) |>
  # Join Day 0 variables (demographics, coexisting illnesses, physical exam)
  left_join(data |>
    filter(event_label == 'Day 0') |>
    select(record_id, age, sex, prssrc,
           m_cv_conditions___2, m_neurologic_conditions___2, m_neurologic_conditions___3,
           m_cancer, m_kid_liver_conditions___1, m_kid_liver_conditions___2,
           highhr_vsorres, highrr_vsorres, lowsysbp_vsorres, lowtemp_vsorres, hightemp_vsorres),
    by = 'record_id') |>
  # Join Syndrome Adjudication variables (pleural effusion)
  left_join(data |>
    filter(event_label == 'Syndrome Adjudication') |>
    select(record_id, pna_effusion),
    by = 'record_id') |>
  mutate(
    str_psi_score_0 = calc_str_psi_score_0(
      # Demographics (Day 0)
      age,
      sex,
      prssrc,
      # Coexisting Illnesses (Day 0)
      m_cv_conditions___2,
      m_neurologic_conditions___2,
      m_neurologic_conditions___3,
      m_cancer,
      m_kid_liver_conditions___1,
      m_kid_liver_conditions___2,
      # Altered Mental Status (Daily In-Hospital Forms)
      cam_0,
      cam_m1,
      cam_m2,
      # Physical Examination Findings (Day 0)
      highhr_vsorres,
      highrr_vsorres,
      lowsysbp_vsorres,
      lowtemp_vsorres,
      hightemp_vsorres,
      # Laboratory Findings - BUN (Daily In-Hospital Forms)
      daily_bun_8a_0,
      daily_bun_8a_m1,
      daily_bun_8a_m2,
      # Laboratory Findings - Glucose (Daily In-Hospital Forms)
      daily_gluc_8a_0,
      daily_gluc_8a_m1,
      daily_gluc_8a_m2,
      # Laboratory Findings - Hematocrit (Daily In-Hospital Forms)
      daily_hct_8a_0,
      daily_hct_8a_m1,
      daily_hct_8a_m2,
      # Laboratory Findings - Sodium (Daily In-Hospital Forms)
      daily_na_8a_0,
      daily_na_8a_m1,
      daily_na_8a_m2,
      # Laboratory Findings - PaO2 (Daily In-Hospital Forms)
      daily_pa02_lowest_0,
      daily_pa02_lowest_m1,
      daily_pa02_lowest_m2,
      # Laboratory Findings - pH (Daily In-Hospital Forms)
      daily_ph_lowest_0,
      daily_ph_lowest_m1,
      daily_ph_lowest_m2,
      # Radiographic Findings - Pleural Effusion (Syndrome Adjudication)
      pna_effusion
    )
  )

data_with_psi |>
  select(str_psi_score_0) |>
  filter(!is.na(str_psi_score_0) & str_psi_score_0 > -1) |>
  ggplot(aes(str_psi_score_0)) +
    geom_histogram(bins = 40)
```

### Unknown/Missing Values

No missing records for this variable.


## Active Vasculitis -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = `m_rheum_conditions___8 == 'Unchecked'` OR (`m_immunosup_conditions___4 == 'Unchecked'` AND `mhccster == 'No'`)
- 1 = `m_rheum_conditions___8 == 'Checked'` AND (`m_immunosup_conditions___4 == 'Checked'` OR `mhccster == 'Yes'`)
- 99 = Unknown

**Summary:**

```{r}
data_with_vasculitis <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_vasculitis_0 = calc_str_vasculitis_0(
      mhrheumd,
      m_rheum_conditions___8,
      m_immunosuppression,
      m_immunosup_conditions___4,
      mhccster
    )
  )

data_with_vasculitis |>
  count(str_vasculitis_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because `mhrheumd`, `m_immunosuppression`, and/or `mhccster` are "Unknown".

```{r}
data_with_vasculitis |>
  filter(str_vasculitis_0 == 99) |>
  select(
    record_id,
    mhrheumd,
    m_rheum_conditions___8,
    m_immunosuppression,
    m_immunosup_conditions___4,
    mhccster
  ) |>
  gt()
```

The only missing (NA) record is the same one missing from the N=500 dataset and doesn't need to be queried further.

## Global Physiology Severity -- Systematic DAG

**Variable Definition:**

Calculated the same as the APS component of the APACHE II score (integer value from 0 to 48).

### Required Variables

```{r}
data_day0_vars <- data |>
  filter(event_label == 'Day 0') |>
  select(
    record_id,
    vs_perf, # branching logic
    hightemp_vsorres,
    lowtemp_vsorres,
    highhr_vsorres,
    lowhr_vsorres,
    highrr_vsorres,
    lowrr_vsorres,
    lowsysbp_vsorres,
    lowdbp_vsorres,
    sofa_unk, # branching logic
    sofa_base_renal_dysnfx,
    sofa_base_renal_chronic
  )

data_hospitalform_vars <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  select(
    record_id,

    ## - Day 0
    dailysofa_perf_0, # branching logic
    daily_resp_8a_0, # branching logic
    daily_imv_mode_8a_0,
    daily_imv_fio2_8a_0,
    daily_standard_flow_8a_0,
    daily_hfnc_fi02_8a_0,
    daily_niv_fi02_8a_0,
    daily_epap_8a_0,
    daily_pao2_occur_0, # branching logic
    daily_pa02_lowest_0,
    daily_paco2_lowest_0,
    daily_ph_lowest_0,
    daily_k_nc_0, # branching logic
    daily_k_8a_0,
    daily_na_nc_0, # branching logic
    daily_na_8a_0,
    daily_hct_nc_0, # branching logic
    daily_hct_8a_0,
    daily_wbc_nc_0, # branching logic
    daily_wbc_8a_0,
    daily_cr_nc_0, # branching logic
    daily_cr_8a_0,
    daily_gcs_8a_0,

    ## - Day -1
    dailysofa_perf_m1, # branching logic
    daily_resp_8a_m1, # branching logic
    daily_imv_mode_8a_m1,
    daily_imv_fio2_8a_m1,
    daily_standard_flow_8a_m1,
    daily_hfnc_fi02_8a_m1,
    daily_niv_fi02_8a_m1,
    daily_epap_8a_m1,
    daily_pao2_occur_m1, # branching logic
    daily_pa02_lowest_m1,
    daily_paco2_lowest_m1,
    daily_ph_lowest_m1,
    daily_k_nc_m1, # branching logic
    daily_k_8a_m1,
    daily_na_nc_m1, # branching logic
    daily_na_8a_m1,
    daily_hct_nc_m1, # branching logic
    daily_hct_8a_m1,
    daily_wbc_nc_m1, # branching logic
    daily_wbc_8a_m1,
    daily_cr_nc_m1, # branching logic
    daily_cr_8a_m1,
    daily_gcs_8a_m1,

    ## - Day -2
    dailysofa_perf_m2, # branching logic
    daily_resp_8a_m2, # branching logic
    daily_imv_mode_8a_m2,
    daily_imv_fio2_8a_m2,
    daily_standard_flow_8a_m2,
    daily_hfnc_fi02_8a_m2,
    daily_niv_fi02_8a_m2,
    daily_epap_8a_m2,
    daily_pao2_occur_m2, # branching logic
    daily_pa02_lowest_m2,
    daily_paco2_lowest_m2,
    daily_ph_lowest_m2,
    daily_k_nc_m2, # branching logic
    daily_k_8a_m2,
    daily_na_nc_m2, # branching logic
    daily_na_8a_m2,
    daily_hct_nc_m2, # branching logic
    daily_hct_8a_m2,
    daily_wbc_nc_m2, # branching logic
    daily_wbc_8a_m2,
    daily_cr_nc_m2, # branching logic
    daily_cr_8a_m2,
    daily_gcs_8a_m2
  ) |>
  # Add code mappings for respiratory support variables
  left_join(
    get_code_label_map('daily_resp_8a_0', dictionary),
    by = 'daily_resp_8a_0'
  ) |>
  left_join(
    get_code_label_map('daily_resp_8a_m1', dictionary),
    by = 'daily_resp_8a_m1'
  ) |>
  left_join(
    get_code_label_map('daily_resp_8a_m2', dictionary),
    by = 'daily_resp_8a_m2'
  )

data_aps_vars <- data_day0_vars |>
  left_join(
    data_hospitalform_vars,
    by = 'record_id'
  )

data_aps_vars <- data_aps_vars |>
  mutate(
    # Calculate respiratory support type for day 0
    resp_support_type_0 = calc_resp_support_type(
      daily_resp_8a_code = daily_resp_8a_0_code,
      dailysofa_perf = dailysofa_perf_0,
      daily_standard_flow_8a = daily_standard_flow_8a_0,
      daily_hfnc_fi02_8a = daily_hfnc_fi02_8a_0,
      daily_niv_fi02_8a = daily_niv_fi02_8a_0,
      daily_imv_fio2_8a = daily_imv_fio2_8a_0,
      daily_epap_8a = daily_epap_8a_0
    ),
    # Calculate respiratory support type for day -1
    resp_support_type_m1 = calc_resp_support_type(
      daily_resp_8a_code = daily_resp_8a_m1_code,
      dailysofa_perf = dailysofa_perf_m1,
      daily_standard_flow_8a = daily_standard_flow_8a_m1,
      daily_hfnc_fi02_8a = daily_hfnc_fi02_8a_m1,
      daily_niv_fi02_8a = daily_niv_fi02_8a_m1,
      daily_imv_fio2_8a = daily_imv_fio2_8a_m1,
      daily_epap_8a = daily_epap_8a_m1
    ),
    # Calculate respiratory support type for day -2
    resp_support_type_m2 = calc_resp_support_type(
      daily_resp_8a_code = daily_resp_8a_m2_code,
      dailysofa_perf = dailysofa_perf_m2,
      daily_standard_flow_8a = daily_standard_flow_8a_m2,
      daily_hfnc_fi02_8a = daily_hfnc_fi02_8a_m2,
      daily_niv_fi02_8a = daily_niv_fi02_8a_m2,
      daily_imv_fio2_8a = daily_imv_fio2_8a_m2,
      daily_epap_8a = daily_epap_8a_m2
    )
  )
```



### Component Summaries

```{r}
data_aps_component_vars <- data_aps_vars |>
  mutate(
    aps_temp_score = calc_aps_temp_score(
      hightemp_vsorres = hightemp_vsorres,
      lowtemp_vsorres = lowtemp_vsorres
    )
  ) |>
  mutate(
    aps_map_score = calc_aps_map_score(
      lowsysbp_vsorres = lowsysbp_vsorres,
      lowdbp_vsorres = lowdbp_vsorres
    )
  ) |>
  mutate(
    aps_hr_score = calc_aps_hr_score(
      highhr_vsorres = highhr_vsorres,
      lowhr_vsorres = lowhr_vsorres
    )
  ) |>
  mutate(
    aps_rr_score = calc_aps_rr_score(
      highrr_vsorres = highrr_vsorres,
      lowrr_vsorres = lowrr_vsorres
    )
  ) |>
  mutate(
    aps_oxy_score = calc_aps_oxy_score(
      resp_support_type_0 = resp_support_type_0,
      resp_support_type_m1 = resp_support_type_m1,
      resp_support_type_m2 = resp_support_type_m2,

      daily_resp_8a_0_code = daily_resp_8a_0_code,
      daily_resp_8a_m1_code = daily_resp_8a_m1_code,
      daily_resp_8a_m2_code = daily_resp_8a_m2_code,

      daily_standard_flow_8a_0 = daily_standard_flow_8a_0,
      daily_standard_flow_8a_m1 = daily_standard_flow_8a_m1,
      daily_standard_flow_8a_m2 = daily_standard_flow_8a_m2,

      daily_hfnc_fi02_8a_0 = daily_hfnc_fi02_8a_0,
      daily_hfnc_fi02_8a_m1 = daily_hfnc_fi02_8a_m1,
      daily_hfnc_fi02_8a_m2 = daily_hfnc_fi02_8a_m2,

      daily_niv_fi02_8a_0 = daily_niv_fi02_8a_0,
      daily_niv_fi02_8a_m1 = daily_niv_fi02_8a_m1,
      daily_niv_fi02_8a_m2 = daily_niv_fi02_8a_m2,

      daily_imv_fio2_8a_0 = daily_imv_fio2_8a_0,
      daily_imv_fio2_8a_m1 = daily_imv_fio2_8a_m1,
      daily_imv_fio2_8a_m2 = daily_imv_fio2_8a_m2,

      daily_pa02_lowest_0 = daily_pa02_lowest_0,
      daily_pa02_lowest_m1 = daily_pa02_lowest_m1,
      daily_pa02_lowest_m2 = daily_pa02_lowest_m2,

      daily_paco2_lowest_0 = daily_paco2_lowest_0,
      daily_paco2_lowest_m1 = daily_paco2_lowest_m1,
      daily_paco2_lowest_m2 = daily_paco2_lowest_m2
    )
  ) |>
  mutate(
    aps_ph_score = calc_aps_ph_score(
      daily_ph_lowest_0 = daily_ph_lowest_0,
      daily_ph_lowest_m1 = daily_ph_lowest_m1,
      daily_ph_lowest_m2 = daily_ph_lowest_m2
    )
  ) |>
  mutate(
    aps_sodium_score = calc_aps_sodium_score(
      daily_na_8a_0 = daily_na_8a_0,
      daily_na_8a_m1 = daily_na_8a_m1,
      daily_na_8a_m2 = daily_na_8a_m2
    )
  ) |>
  mutate(
    aps_potassium_score = calc_aps_potassium_score(
      daily_k_8a_0 = daily_k_8a_0,
      daily_k_8a_m1 = daily_k_8a_m1,
      daily_k_8a_m2 = daily_k_8a_m2
    )
  ) |>
  mutate(
    aps_creatinine_score = calc_aps_creatinine_score(
      daily_cr_8a_0 = daily_cr_8a_0,
      daily_cr_8a_m1 = daily_cr_8a_m1,
      daily_cr_8a_m2 = daily_cr_8a_m2,
      sofa_base_renal_dysnfx = sofa_base_renal_dysnfx,
      sofa_base_renal_chronic = sofa_base_renal_chronic
    )
  ) |>
  mutate(
    aps_hct_score = calc_aps_hct_score(
      daily_hct_8a_0 = daily_hct_8a_0,
      daily_hct_8a_m1 = daily_hct_8a_m1,
      daily_hct_8a_m2 = daily_hct_8a_m2
    )
  ) |>
  mutate(
    aps_wbc_score = calc_aps_wbc_score(
      daily_wbc_8a_0 = daily_wbc_8a_0,
      daily_wbc_8a_m1 = daily_wbc_8a_m1,
      daily_wbc_8a_m2 = daily_wbc_8a_m2
    )
  ) |>
  mutate(
    aps_gcs_score = calc_aps_gcs_score(
      daily_gcs_8a_0 = daily_gcs_8a_0,
      daily_gcs_8a_m1 = daily_gcs_8a_m1,
      daily_gcs_8a_m2 = daily_gcs_8a_m2
    )
  )
```

#### 1. Temperature

```{r}
data_aps_component_vars |>
  count(aps_temp_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### 2. Mean Arterial Pressure (MAP)

```{r}
data_aps_component_vars |>
  count(aps_map_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### 3. Heart Rate

```{r}
data_aps_component_vars |>
  count(aps_hr_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### 4. Respiratory Rate

```{r}
data_aps_component_vars |>
  count(aps_rr_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### 5. Oxygenation (A-aDO2 or PaO2)

```{r}
data_aps_component_vars |>
  count(aps_oxy_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### 6. Arterial pH

```{r}
data_aps_component_vars |>
  count(aps_ph_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### 7. Serum Sodium

```{r}
data_aps_component_vars |>
  count(aps_sodium_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### 8. Serum Potassium

```{r}
data_aps_component_vars |>
  count(aps_potassium_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### 9. Serum Creatinine

```{r}
data_aps_component_vars |>
  count(aps_creatinine_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### 10. Hematocrit

```{r}
data_aps_component_vars |>
  count(aps_hct_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### 11. White Blood Cell Count

```{r}
data_aps_component_vars |>
  count(aps_wbc_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### 12. Glasgow Coma Score

```{r}
data_aps_component_vars |>
  count(aps_gcs_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Component Unknown/Missing Values

#### 1. Temperature

These records couldn't be scored because they are missing (NA) both `hightemp_vsorres` and `lowtemp_vsorres`. One record is `52-0023`, which is the record ultimately excluded from the N=500 dataset (and can therefore be ignored). The other has `vs_perf == 'No'` (Day 0 vital signs weren't collected), so missing `hightemp_vsorres` and `lowtemp_vsorres` technically satisfies the branching logic, but these should probably have values.

```{r}
data_aps_component_vars |>
  filter(is.na(aps_temp_score)) |>
  select(
    record_id,
    vs_perf,
    hightemp_vsorres,
    lowtemp_vsorres
  ) |>
  gt()
```

#### 2. Mean Arterial Pressure (MAP)

These records couldn't be scored because they are missing (NA) both `lowsysbp_vsorres` and `lowdbp_vsorres`. One record is `52-0023`, which is the record ultimately excluded from the N=500 dataset (and can therefore be ignored). Of the others, one has `vs_perf == 'No'` (Day 0 vital signs weren't collected), so missing `lowsysbp_vsorres` and `lowdbp_vsorres` technically satisfies the branching logic, but these should probably have values. This is the same record missing measurements for Temperature (above). The other has `vs_perf == 'Yes'`, so those missing values violate the branching logic.

```{r}
data_aps_component_vars |>
  filter(is.na(aps_map_score)) |>
  select(
    record_id,
    vs_perf,
    lowsysbp_vsorres,
    lowdbp_vsorres
  ) |>
  gt()
```

#### 3. Heart Rate

These records couldn't be scored because they are missing (NA) both `highhr_vsorres` and `lowhr_vsorres`. One record is `52-0023`, which is the record ultimately excluded from the N=500 dataset (and can therefore be ignored). Of the others, one has `vs_perf == 'No'` (Day 0 vital signs weren't collected), so missing `highhr_vsorres` and `lowhr_vsorres` technically satisfies the branching logic, but these should probably have values. This is the same record missing measurements for Temperature (above).

```{r}
data_aps_component_vars |>
  filter(is.na(aps_hr_score)) |>
  select(
    record_id,
    vs_perf,
    highhr_vsorres,
    lowhr_vsorres
  ) |>
  gt()
```

#### 4. Respiratory Rate

These records couldn't be scored because they are missing (NA) both `highrr_vsorres` and `lowrr_vsorres`. One record is `52-0023`, which is the record ultimately excluded from the N=500 dataset (and can therefore be ignored). Of the others, one has `vs_perf == 'No'` (Day 0 vital signs weren't collected), so missing `highrr_vsorres` and `lowrr_vsorres` technically satisfies the branching logic, but these should probably have values. This is the same record missing measurements for Temperature (above).

```{r}
data_aps_component_vars |>
  filter(is.na(aps_rr_score)) |>
  select(
    record_id,
    vs_perf,
    highrr_vsorres,
    lowrr_vsorres
  ) |>
  gt()
```

#### 5. Oxygenation (A-aDO2 or PaO2)

No records are missing this component, since all missing measurements are imputed as normal (0 points). This is because the measurements for this component are commonly missing (and shouldn't be queried).

#### 6. Arterial pH

No records are missing this component, since all missing measurements are imputed as normal (0 points). This is because the measurements for this component are commonly missing (and shouldn't be queried).

#### 7. Serum Sodium

These records couldn't be scored because they are missing (NA) all pairs for `daily_na_nc_*`/`daily_na_8a_*`. The branching logic dictates these should be mutually exclusive - if one is NA, the other shouldn't be. One record is `52-0023`, which is the record ultimately excluded from the N=500 dataset (and can therefore be ignored), but the others should be queried.

```{r}
data_aps_component_vars |>
  filter(is.na(aps_sodium_score)) |>
  select(
    record_id,
    daily_na_nc_0,
    daily_na_nc_m1,
    daily_na_nc_m2,
    daily_na_8a_0,
    daily_na_8a_m1,
    daily_na_8a_m2
  ) |>
  gt()
```

#### 8. Serum Potassium

These records couldn't be scored because they are missing (NA) all pairs for `daily_k_nc_*`/`daily_k_8a_*`. The branching logic dictates these should be mutually exclusive - if one is NA, the other shouldn't be. One record is `52-0023`, which is the record ultimately excluded from the N=500 dataset (and can therefore be ignored), but the others should be queried. These are the same records missing Serum Sodium (above).

```{r}
data_aps_component_vars |>
  filter(is.na(aps_potassium_score)) |>
  select(
    record_id,
    daily_k_nc_0,
    daily_k_nc_m1,
    daily_k_nc_m2,
    daily_k_8a_0,
    daily_k_8a_m1,
    daily_k_8a_m2
  ) |>
  gt()
```

#### 9. Serum Creatinine

These records couldn't be scored because they are missing (NA) all pairs for `daily_cr_nc_*`/`daily_cr_8a_*`. The branching logic dictates these should be mutually exclusive - if one is NA, the other shouldn't be. One record is `52-0023`, which is the record ultimately excluded from the N=500 dataset (and can therefore be ignored), but the others should be queried. These are the same records missing Serum Sodium (above).

These records are also missing values related to `sofa_base_renal_dysnfx`, but these appear to be valid. `13-0016` has `sofa_base_renal_dysnfx == 'No'`, so missing `sofa_unk` and `sofa_base_renal_chronic` satisfies the branching logic. And `63-0008` has `sofa_unk == '<b>Select here if pre-illness SOFA score information is unknown</b>'` (this data input should be a more readable value, but it is consistent throughout the dataset) so missing `sofa_base_renal_dysnfx` and `sofa_base_renal_chronic` satisfies the branching logic.

```{r}
data_aps_component_vars |>
  filter(is.na(aps_creatinine_score)) |>
  select(
    record_id,
    sofa_unk,
    sofa_base_renal_dysnfx,
    sofa_base_renal_chronic,
    daily_cr_nc_0,
    daily_cr_nc_m1,
    daily_cr_nc_m2,
    daily_cr_8a_0,
    daily_cr_8a_m1,
    daily_cr_8a_m2
  ) |>
  gt()
```

#### 10. Hematocrit

These records couldn't be scored. Three are missing (NA) all pairs for `daily_hct_nc_*`/`daily_hct_8a_*`. The branching logic dictates these should be mutually exclusive - if one is NA, the other shouldn't be. One record is `52-0023`, which is the record ultimately excluded from the N=500 dataset (and can therefore be ignored), but the others should be queried. These are the same records missing Serum Sodium (above).

An additional record has `daily_hct_nc_* == 'Not Collected'` for all days. This satisfies the branching logic, but our formula doesn't know how to classify this record.

```{r}
data_aps_component_vars |>
  filter(is.na(aps_hct_score)) |>
  select(
    record_id,
    daily_hct_nc_0,
    daily_hct_nc_m1,
    daily_hct_nc_m2,
    daily_hct_8a_0,
    daily_hct_8a_m1,
    daily_hct_8a_m2
  ) |>
  gt()
```

#### 11. White Blood Cell Count

These records couldn't be scored because they are missing (NA) all pairs for `daily_wbc_nc_*`/`daily_wbc_8a_*`. The branching logic dictates these should be mutually exclusive - if one is NA, the other shouldn't be. One record is `52-0023`, which is the record ultimately excluded from the N=500 dataset (and can therefore be ignored), but the others should be queried. These are the same records missing Serum Sodium (above).

```{r}
data_aps_component_vars |>
  filter(is.na(aps_wbc_score)) |>
  select(
    record_id,
    daily_wbc_nc_0,
    daily_wbc_nc_m1,
    daily_wbc_nc_m2,
    daily_wbc_8a_0,
    daily_wbc_8a_m1,
    daily_wbc_8a_m2
  ) |>
  gt()
```

#### 12. Glasgow Coma Score

No records missing GCS.



### Full Variable Summary

```{r}
data_aps_var <- data_aps_component_vars |>
  mutate(
    aps_score = calc_aps_score(
      aps_temp_score = aps_temp_score,
      aps_map_score = aps_map_score,
      aps_hr_score = aps_hr_score,
      aps_rr_score = aps_rr_score,
      aps_oxy_score = aps_oxy_score,
      aps_ph_score = aps_ph_score,
      aps_sodium_score = aps_sodium_score,
      aps_potassium_score = aps_potassium_score,
      aps_creatinine_score = aps_creatinine_score,
      aps_hct_score = aps_hct_score,
      aps_wbc_score = aps_wbc_score,
      aps_gcs_score = aps_gcs_score
    )
  )

data_aps_var |>
  count(aps_score) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Full Variable Unknown/Missing Values

In the final calculation of the full variable, we impute normal (0 points) for any missing component score. This is consistent with how the APS score is calculated for APACHE II. However, since we still want the capability of flagging records that are missing a component score due to missing data that must be queried, we impute normal for all components during the final calculation step.

Below, we highlight the records that were otherwise missing their component score. Three component scores have no associated missing records: Oxygenation, Arterial pH, and GCS. Only one record (`52-0023`, excluded from the dataset) is missing all other components of the APS score. (this is the one record that is set to value of `0` in the Global Physiology Severity DAG). The others are missing several components, often with a given record missing several related components. All of these records should be queried for the missing data (e.g., `vs_perf == 0`, `nc/8a` mutual exclusivity, key labs labeled as 'Not Collected', etc.).

```{r}
data_aps_var |>
  filter(
    is.na(aps_temp_score) |
    is.na(aps_map_score) |
    is.na(aps_hr_score) |
    is.na(aps_rr_score) |
    is.na(aps_oxy_score) |
    is.na(aps_ph_score) |
    is.na(aps_sodium_score) |
    is.na(aps_potassium_score) |
    is.na(aps_creatinine_score) |
    is.na(aps_hct_score) |
    is.na(aps_wbc_score) |
    is.na(aps_gcs_score)
  ) |>
  select(
    record_id,
    aps_temp_score,
    aps_map_score,
    aps_hr_score,
    aps_rr_score,
    aps_oxy_score,
    aps_ph_score,
    aps_sodium_score,
    aps_potassium_score,
    aps_creatinine_score,
    aps_hct_score,
    aps_wbc_score,
    aps_gcs_score
  ) |>
  gt()
```


## QUERIED VARIABLES BELOW HERE

## Missing Record Data

There should be records for 500 patients in the dataset. However, for certain events appear to be missing data for one patient. When I filter the data for `event_label == "Daily In-Hospital Forms"`, which has values for the variables we are using, the result has 499 rows, not 500. Other events, such as `event_label == "Day 0"` have 500 rows, so the patient is included in some events but not this one. There may be other events that are missing as well that I didn't check.

Here is the patient record missing the "Daily In-Hospital Forms" event:

```{r}
ihf_data <- filter(data, event_label == 'Daily In-Hospital Forms')
d0_data <- filter(data, event_label == 'Day 0')
anti_join(d0_data, ihf_data, by="record_id") |>
  select(record_id) |>
  gt()
```

Given that this patient is missing, the totals for the derived variables below come to 499 instead of 500.

### Query Response
> When there is no record for a record id-event pair, it means that no data had been entered for that pair (and no such record exists). However, all participants should have the "Daily In-Hospital Forms" event. I believe this participant was the one we identified as being erroneously included in the N=500 data set and will be omitted in the final N=500 data set. Of course, this participant will appear in subsequent data sets assuming they do not withdraw by the withdrawal cut-off.


## Neuromuscular Blockade -- Systematic DAG

**Variable Definition:**

- 0 = No neuromuscular blockade on Day 0 or not applicable
- 1 = Neuromuscular blockade given on Day 0

**Summary:**

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(sys_nmblockade_0 = calc_sys_nmblockade_0(
    daily_paralysis_0 = daily_paralysis_0,
    trx_0 = trx_0
  )) |>
  count(sys_nmblockade_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Missingness Report

The branching logic for `daily_paralysis_0` states that if the variable `trx_0 == "Available"`, then `daily_paralysis_0` should be present. If `trx_0 == "Not Available"`, then `daily_paralysis_0` will be missing (NA). `trx_0` has no associated branching logic and thus should always have one of those two values.

Thus, according to the branching logic, these records were incorrectly missing `daily_paralysis_0`:
```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_paralysis_0) & (trx_0 %in% c('Available', NA))) |>
  mutate(missingness = case_when(
    trx_0 == 'Available' ~ 'By branching logic, "daily_paralysis_0" should have a value',
    is.na(trx_0) ~ '"trx_0" is also missing'
  )) |>
  select(record_id, daily_paralysis_0, trx_0, missingness) |>
  gt()
```

#### Query Response
> This is likely missing because data were not entered for daily paralysis even though it should have been entered. Although we have many data quality rules and coordinators fix many problems, we are not at 100% (and likely will never be, meaning that this kind of missingness should be considered in the analysis).

Matt then asked two people to look at these (and the other missing values below) to see if there should be additional data quality rules.

#### Valid NA Values

These records were missing `daily_paralysis_0`, but this was considered valid (e.g., "Not Applicable") by the branching logic of `trx_0 == 'Not Available'`. Thus, they were set to `sys_nmblockade_0 = 0` according to the variable definition. However, as we are unsure what `trx_0` represents and why it would be marked "Not Available", we've included those records for completeness.

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_paralysis_0) & (trx_0 == 'Not Available')) |>
  select(record_id, daily_paralysis_0, trx_0) |>
  gt()
```

##### Query Response
> Agree it seems suspicious that no in-hospital treatments would be available on day 0, even if the participant died shortly after enrollment.


## Neuromuscular Blockade -- Streamlined DAG

Currently calculated the same as the Systematic DAG Neuromuscular Blockade (see above).


## (REWORKED) Inflammatory Profile -- Systematic DAG

**Variable Definition:**

Four variables, one for each element:

1. `crp_0`
  - 0 = Day 0 CRP not checked
  - 1 = Day 0 CRP checked and < 15
  - 2 = Day 0 CRP checked and ≥ 15
2. `ferritin_0`
  - 0 = Day 0 Ferritin not checked
  - 1 = Day 0 Ferritin checked and < 700
  - 2 = Day 0 Ferritin checked and ≥ 700
3. `fibrinogen_0`
  - 0 = Day 0 Fibrinogen not checked
  - 1 = Day 0 Fibrinogen checked and < 150
  - 2 = Day 0 Fibrinogen checked and ≥ 150
4. `ddimer_0`
  - 0 = Day 0 D-dimer not checked
  - 1 = Day 0 D-dimer checked and < 1500
  - 2 = Day 0 D-dimer checked and ≥ 1500

For each variable, if Day 0 lab results are missing, prior lab values (Day -1 or Day -2) are used.

**Summary:**

```{r}
data_with_sys_inflamprofile_0 <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(crp_0 = calc_crp_0(
    daily_crp_8a_0,
    daily_crp_nc_0,
    daily_crp_8a_m1,
    daily_crp_nc_m1,
    daily_crp_8a_m2,
    daily_crp_nc_m2
    )) |>
  mutate(ferritin_0 = calc_ferritin_0(
    daily_ferritin_8a_0,
    daily_ferritin_nc_0,
    daily_ferritin_8a_m1,
    daily_ferritin_nc_m1,
    daily_ferritin_8a_m2,
    daily_ferritin_nc_m2
    )) |>
  mutate(fibrinogen_0 = calc_fibrinogen_0(
    daily_fibrinogen_8a_0,
    daily_fibrinogen_nc_0,
    daily_fibrinogen_8a_m1,
    daily_fibrinogen_nc_m1,
    daily_fibrinogen_8a_m2,
    daily_fibrinogen_nc_m2
    )) |>
  mutate(ddimer_0 = calc_ddimer_0(
    daily_ddimer_8a_0,
    daily_ddimer_nc_0,
    daily_ddimer_8a_m1,
    daily_ddimer_nc_m1,
    daily_ddimer_8a_m2,
    daily_ddimer_nc_m2
    ))

data_with_sys_inflamprofile_0 |>
  pivot_longer(
    cols = c(crp_0, ferritin_0, fibrinogen_0, ddimer_0),
    names_to = "variable",
    values_to = "level"
  ) |>
  count(variable, level) |>
  pivot_wider(
    names_from = level,
    values_from = n
  ) |>
  mutate(Total = rowSums(across(where(is.numeric)))) |>
  gt() |>
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = list(
      cells_body(columns = Total),
      cells_column_labels(columns = Total)
    )
  )
```

### Missing Values

Each variable is computed from thee pairs (Days 0, -1, -2) of variables `daily_<element_name>_8a_<day_num>` and `daily_<element_name>_nc_<day_num>` (e.g., `daily_crp_8a_0` and `daily_crp_nc_0` for Day 0). The `*_nc_*` suffix indicates "not collected", while the `*_8a_*` suffix contains the value of the measurement. The branching logic makes each pair mutually exclusive. Thus, if one variable in the pair is present, the other should be missing (NA).

According to the branching logic, these records were missing all three pairs (all days) for all four variables:

```{r}
data_with_sys_inflamprofile_0 |>
  filter(is.na(crp_0) | is.na(ferritin_0) | is.na(fibrinogen_0) | is.na(ddimer_0)) |>
  select(
    record_id,
    daily_crp_8a_0,
    daily_crp_nc_0,
    daily_crp_8a_m1,
    daily_crp_nc_m1,
    daily_crp_8a_m2,
    daily_crp_nc_m2,
    daily_ferritin_8a_0,
    daily_ferritin_nc_0,
    daily_ferritin_8a_m1,
    daily_ferritin_nc_m1,
    daily_ferritin_8a_m2,
    daily_ferritin_nc_m2,
    daily_fibrinogen_8a_0,
    daily_fibrinogen_nc_0,
    daily_fibrinogen_8a_m1,
    daily_fibrinogen_nc_m1,
    daily_fibrinogen_8a_m2,
    daily_fibrinogen_nc_m2,
    daily_ddimer_8a_0,
    daily_ddimer_nc_0,
    daily_ddimer_8a_m1,
    daily_ddimer_nc_m1,
    daily_ddimer_8a_m2,
    daily_ddimer_nc_m2
  ) |>
  gt()
```


#### Query Response
> Again, this is likely missing because data were not entered even though they should have been entered.





## (REWORKED) Inflammatory Profile -- Streamlined DAG

**Variable Definition:**

- 0 = Day 0 CRP not checked
- 1 = Day 0 CRP checked and < 15
- 2 = Day 0 CRP checked and ≥ 15

If Day 0 lab results are missing, prior lab values (Day -1 or Day -2) are used.

**Summary:**

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(str_inflamprofile_0 = calc_str_inflamprofile_0(
    daily_crp_8a_0,
    daily_crp_nc_0,
    daily_crp_8a_m1,
    daily_crp_nc_m1,
    daily_crp_8a_m2,
    daily_crp_nc_m2
  )) |>
  count(str_inflamprofile_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Missing Values

The records missing (NA) for the `crp` component variable of "Inflammatory Profile" (Systematic DAG) above is also missing for this variable.

## Respiratory Failure Severity -- Systematic DAG

### Variable 1: Type of support

**Variable Definition:**

- 1 = No Oxygen
- 2 = Standard Flow
- 3 = HFNC
- 4 = NIV
- 5 = (IMV AND PEEP < 12) but NOT ECMO
- 6 = (IMV AND PEEP ≥ 12) OR ECMO
- 99 = Unknown

**Summary:**

```{r}
data_with_sysrespfail_var1 <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  left_join(
    get_code_label_map('daily_resp_8a_0', dictionary),
    by ='daily_resp_8a_0'
    ) |>
  mutate(resp_support_type_0 = calc_resp_support_type(
    daily_resp_8a_code = daily_resp_8a_0_code,
    dailysofa_perf = dailysofa_perf_0,
    daily_standard_flow_8a = daily_standard_flow_8a_0,
    daily_hfnc_fi02_8a = daily_hfnc_fi02_8a_0,
    daily_niv_fi02_8a = daily_niv_fi02_8a_0,
    daily_imv_fio2_8a = daily_imv_fio2_8a_0,
    daily_epap_8a = daily_epap_8a_0
  ))

data_with_sysrespfail_var1 |>
  count(resp_support_type_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### Unknown Values

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" - "6" and having "Unknown" for either `daily_resp_8a_0`:

```{r}
data_with_sysrespfail_var1 |>
  filter(resp_support_type_0 == 99) |>
  select(
    record_id,
    daily_resp_8a_0_code,
    daily_resp_8a_0
    ) |>
  gt()
```


#### Missing Values

These records couldn't be defined due to invalid branching logic.

When respiratory support type is "Invasive mechanical ventilation without ECMO" (`daily_resp_8a_0_code == 3`), the branching logic expects values for `daily_imv_mode_8a_0` and `daily_epap_8a_0`.

When support type is "Non-invasive ventilation" (`daily_resp_8a_0_code == 4`), the branching logic expects a value for `daily_niv_fi02_8a_0`.

These records are missing one or both of those expected values:

```{r}
data_with_sysrespfail_var1 |>
  filter(is.na(resp_support_type_0)) |>
  select(
    record_id,
    daily_resp_8a_0_code,
    daily_resp_8a_0,
    daily_imv_mode_8a_0,
    daily_epap_8a_0,
    daily_niv_fi02_8a_0
    ) |>
  gt() |>
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "red")
    ),
    locations = cells_body(
      columns = daily_niv_fi02_8a_0,
      rows = daily_resp_8a_0_code == 4
    )
  ) |>
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "red")
    ),
    locations = cells_body(
      columns = c(daily_imv_mode_8a_0, daily_epap_8a_0),
      rows = daily_resp_8a_0_code == 3
    )
  )
```


#### "Valid" Missing Values

One record was missing `daily_resp_8a_0`, but this was satisfied by the branching logic with `dailysofa_perf_0 == 'Not Available'`. Thus, `resp_support_type_0` was set to "1" (no oxygen/not applicable) according to the variable definition, but due to missing measurements couldn't be defined under Variable 2 (below).

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  left_join(
    get_code_label_map('daily_resp_8a_0', dictionary),
    by ='daily_resp_8a_0'
    ) |>
  filter(is.na(daily_resp_8a_0)) |>
  select(record_id, dailysofa_perf_0, daily_resp_8a_0) |>
  gt()
```

### Variable 2: S/F Ratio Closest to 8am

**Variable Definition:**

Calculated using one of 3 options dependent on Variable #1 (type of support):

- If Variable 1 = 3, 4, 5, 6 -> [8a SpO2]/[8a FiO2]
- If Variable 1 = 2 -> [8a SpO2]/[0.21 + (0.03 * 8a O2 flow)]
- If Variable 1 = 1 -> [8a SpO2]/[0.21]

Note, if the patient is on ECMO but NOT on IMV, the S/F ratio cannot be calculated due to no Fi02 measurement and is set to missing (NA). No records in this dataset have this condition, but it may arise in future datasets. If it does, the variable definition will need to account for it.

**Summary:**

```{r}
data_with_sysrespfail_var2 <- data_with_sysrespfail_var1 |>
  mutate(sfratio_8a_0 = calc_sfratio_8a_0(
    resp_support_type_0 = resp_support_type_0,
    daily_spo2_8a_0 = daily_spo2_8a_0,
    daily_standard_flow_8a_0 = daily_standard_flow_8a_0,
    daily_hfnc_fi02_8a_0 = daily_hfnc_fi02_8a_0,
    daily_niv_fi02_8a_0 = daily_niv_fi02_8a_0,
    daily_imv_fio2_8a_0 = daily_imv_fio2_8a_0
  ))

data_with_sysrespfail_var2 |>
  filter(!is.na(sfratio_8a_0)) |>
  select(resp_support_type_0, sfratio_8a_0) |>
  ggplot(aes(sfratio_8a_0)) +
    geom_histogram(bins = 10) +
    facet_wrap(~ resp_support_type_0,
               labeller = as_labeller(c(
                 '1' = '1 (No Support)',
                 '2' = '2 (Standard Flow)',
                 '3' = '3 (HFNC)',
                 '4' = '4 (NIV)',
                 '5' = '5 (IMV, PEEP < 12, no ECMO)',
                 '6' = '6 ([IMV, PEEP ≥ 12] OR ECMO)'
               ))) +
    ggtitle("S/F Ratio Closest to 8am by Respiratory Support Type")
```

The histograms above show the distribution of S/F ratios for each support type.

#### Missingness Report

The records missing under Variable 1 (`resp_support_type_0`) are also missing for Variable 2 (`sfratio_8a_0`):

```{r}
data_with_sysrespfail_var2 |>
  filter(is.na(sfratio_8a_0) & is.na(resp_support_type_0)) |>
  select(record_id, sfratio_8a_0, resp_support_type_0) |>
  gt()
```

Details for why these records are missing are given above.

##### Valid NA Values

One record was missing `sfratio_8a_0` (Variable 2), but not missing `resp_support_type_0` (Variable 1). This is explained by the branching logic: if `dailysofa_perf_0 == 'Not Available'`, then `daily_spo2_8a_0` will be missing and the S/F ratio cannot be calculated according to the definition of Variable 2.

```{r}
data_with_sysrespfail_var2 |>
  filter(is.na(sfratio_8a_0) & !is.na(resp_support_type_0)) |>
  select(record_id, sfratio_8a_0, resp_support_type_0, daily_spo2_8a_0, dailysofa_perf_0) |>
  gt()
```

## Respiratory Failure Severity -- Streamlined DAG

Currently calculated the same as Variable 2 from the Systematic DAG Respiratory Failure Severity (see above).



## Chronic Moderate-Dose Steroid Use -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(mhccster == 0)` OR `(m_endo_conditions___2 == 1)` OR `(m_immunosup_conditions___1 == 1)`
- 1 (Yes) = `(mhccster == 1)` AND `(m_endo_conditions___2 == 0)` AND `(m_immunosup_conditions___1 == 0)`
- 99 (Unknown) = `mhccster == "Unknown"` OR `m_endocrine == "Unknown"` OR `m_immunosuppression == "Unknown"` (and doesn't meet either of the first two conditions)

**Summary:**

```{r}
data_with_sys_chron_steroid_moddose_0 <- data|>
  filter(event_label == 'Day 0') |>
  mutate(sys_chron_steroid_moddose_0 = calc_sys_chron_steroid_moddose_0(
    mhccster = mhccster,
    m_endo_conditions___2 = m_endo_conditions___2,
    m_immunosup_conditions___1 = m_immunosup_conditions___1,
    m_endocrine = m_endocrine,
    m_immunosuppression = m_immunosuppression
  ))

data_with_sys_chron_steroid_moddose_0 |>
  count(sys_chron_steroid_moddose_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were marked "Unknown" for one of the fields required to assess this variable:

```{r}
data_with_sys_chron_steroid_moddose_0 |>
  filter(sys_chron_steroid_moddose_0 == 99) |>
  select(record_id, mhccster, m_endocrine, m_endo_conditions___2, m_immunosuppression, m_immunosup_conditions___1) |>
  gt() |>
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "blue")
    ),
    locations = list(
      cells_body(
        columns = mhccster,
        rows = mhccster == "Unknown"
      ),
      cells_body(
        columns = m_endocrine,
        rows = m_endocrine == "Unknown"
      ),
      cells_body(
        columns = m_immunosuppression,
        rows = m_immunosuppression == "Unknown"
      )
    )
  )
```

### Missing Values

According to the branching logic, `m_endo_conditions___*` will only have a value if `m_endocrine == "Yes"` and `m_immunosup_conditions___*` will only have a value if `m_immunosuppression == "Yes"`. One record was missing (NA) `mhccster`, `m_endocrine`, and `m_immunosuppression`, but this is the same record missing from the N=500 dataset and does not need to be queried further.

## Chronic Moderate-Dose Steroid Use -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(mhccster == 0)` OR `(m_endo_conditions___2 == 1)`
- 1 (Yes) = `(mhccster == 1)` AND `(m_endo_conditions___2 == 0)`
- 99 (Unknown) = `mhccster == "Unknown"` OR `m_endocrine == "Unknown"` (and doesn't meet either of the first two conditions)

**Summary:**

```{r}
data_with_str_chron_steroid_moddose_0 <- data |>
  filter(event_label == 'Day 0') |>
  mutate(str_chron_steroid_moddose_0 = calc_str_chron_steroid_moddose_0(
    mhccster = mhccster,
    m_endo_conditions___2 = m_endo_conditions___2,
    m_endocrine = m_endocrine
  ))

data_with_str_chron_steroid_moddose_0 |>
  count(str_chron_steroid_moddose_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were marked "Unknown" for one of the fields required to assess this variable:

```{r}
data_with_str_chron_steroid_moddose_0 |>
  filter(str_chron_steroid_moddose_0 == 99) |>
  select(record_id, mhccster, m_endocrine, m_endo_conditions___2) |>
  gt() |>
  tab_style(
    style = list(
      cell_text(weight = "bold", color = "blue")
    ),
    locations = list(
      cells_body(
        columns = mhccster,
        rows = mhccster == "Unknown"
      ),
      cells_body(
        columns = m_endocrine,
        rows = m_endocrine == "Unknown"
      )
    )
  )
```

### Missing Values

According to the branching logic, `m_endo_conditions___*` will only have a value if `m_endocrine == "Yes"`. One record was missing (NA) `mhccster` and `m_endocrine`, but this is the same record missing from the N=500 dataset and does not need to be queried further.






## Definite Adrenal Insufficiency -- Systematic DAG

**Variable Definition:**

Binary indicator variable (used to exclude patients if yes)

- 0 (No) = `(m_endo_conditions___2 == 0)` AND `(m_immunosup_conditions___1 == 0)`
- 1 (Yes) = `(m_endo_conditions___2 == 1)` OR `(m_immunosup_conditions___1 == 1)`
- 99 (Unknown) = `m_endocrine == "Unknown"` OR `m_immunosuppression == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_def_adrenal_insufficiency_0 = calc_sys_def_adrenal_insufficiency_0(
    m_endocrine = m_endocrine,
    m_endo_conditions___2 = m_endo_conditions___2,
    m_immunosuppression = m_immunosuppression,
    m_immunosup_conditions___1 = m_immunosup_conditions___1
  )) |>
  count(sys_def_adrenal_insufficiency_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" or "0" and having "Unknown" for either `m_endocrine` or `m_immunosuppression`:

```{r}
data |>
  filter(event_label == 'Day 0') |>
  filter(is_unknown(m_endocrine) | is_unknown(m_immunosuppression)) |>
  select(
    record_id,
    m_endocrine,
    m_immunosuppression
  ) |>
  gt()
```

### Missing Values

According to the branching logic, `m_endo_conditions___*` will only have a value if `m_endocrine == "Yes"` and `m_immunosup_conditions___*` will only have a value if `m_immunosuppression == "Yes"`. One record was missing (NA) both `m_endocrine` and `m_immunosuppression`, but this is the same record missing from the N=500 dataset and does not need to be queried further.

## Definite Adrenal Insufficiency -- Streamlined DAG

**Variable Definition:**

Binary indicator variable (used to exclude patients if yes)

- 0 (No) = `(m_endo_conditions___2 == 0)`
- 1 (Yes) = `(m_endo_conditions___2 == 1)`
- 99 (Unknown) = `m_endocrine == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(str_def_adrenal_insufficiency_0 = calc_str_adrenal_insufficiency_0(
    m_endocrine,
    m_endo_conditions___2 = m_endo_conditions___2
  )) |>
  count(str_def_adrenal_insufficiency_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_endocrine` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.

## Chronic Steroids High Dose -- Streamlined DAG

**Variable Definition:**

Binary indicator variable (used to exclude patients if yes):

- 0 (No) = `m_immunosup_conditions___1 == 0`
- 1 (Yes) = `m_immunosup_conditions___1 == 1`
- 99 (Unknown) = `m_immunosuppression == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(str_chron_steroid_highdose_0 = calc_str_chron_steroid_highdose_0(
    m_immunosuppression = m_immunosuppression,
    m_immunosup_conditions___1 = m_immunosup_conditions___1
  )) |>
  count(str_chron_steroid_highdose_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_immunosuppression` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.


## Steroid Responsive Comorbidity -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = All `(m_rheum_conditions___* == 0)` AND `(m_pulm_conditions___6 == 0)`
- 1 (Yes) = Any `(m_rheum_conditions___* == 1)` OR `(m_pulm_conditions___6 == 1)`
- 99 (Unknown) = `mhrheumd == "Unknown"` OR `m_pulmonary == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data_with_sys_steroid_comorb_0 <- data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_steroid_comorb_0 = calc_sys_steroid_comorb_0(
    mhrheumd = mhrheumd,
    m_rheum_conditions___1 = m_rheum_conditions___1,
    m_rheum_conditions___2 = m_rheum_conditions___2,
    m_rheum_conditions___3 = m_rheum_conditions___3,
    m_rheum_conditions___4 = m_rheum_conditions___4,
    m_rheum_conditions___5 = m_rheum_conditions___5,
    m_rheum_conditions___6 = m_rheum_conditions___6,
    m_rheum_conditions___7 = m_rheum_conditions___7,
    m_rheum_conditions___8 = m_rheum_conditions___8,
    m_rheum_conditions___88 = m_rheum_conditions___88,
    m_pulmonary = m_pulmonary,
    m_pulm_conditions___6 = m_pulm_conditions___6
  ))

data_with_sys_steroid_comorb_0 |>
  count(sys_steroid_comorb_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" or "0" and having "Unknown" for `mhrheumd` or `m_pulmonary`:

```{r}
data_with_sys_steroid_comorb_0 |>
  filter(sys_steroid_comorb_0 == 99) |>
  select(
    record_id,
    mhrheumd,
    m_pulmonary
  ) |>
  gt()
```

### Missing Values

According to the branching logic, `m_rheum_conditions___*` will only have a value if `mhrheumd == "Yes"` and `m_pulm_conditions___*` will only have a value if `m_pulmonary == "Yes"`. One record was missing (NA) `mhrheumd` and `m_pulmonary`, but this is the same record missing from the N=500 dataset and does not need to be queried further.

## Steroid Responsive Comorbidity -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = All `(m_rheum_conditions___* == 0)` (ignoring `m_rheum_conditions___8`) OR (`m_immunosup_conditions___4 == 0` AND `mhccster == 0`)
- 1 (Yes) = Any `(m_rheum_conditions___* == 1)` (ignoring `m_rheum_conditions___8`) AND (`m_immunosup_conditions___4 == 1` OR `mhccster == 1`)
- 99 (Unknown) = `mhrheumd == "Unknown"` OR `m_immunosuppression == "Unknown"` OR `mhccster == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data_with_str_steroid_comorb_0 <- data |>
  filter(event_label == 'Day 0') |>
  mutate(str_steroid_comorb_0 = calc_str_steroid_comorb_0(
    mhrheumd = mhrheumd,
    m_rheum_conditions___1 = m_rheum_conditions___1,
    m_rheum_conditions___2 = m_rheum_conditions___2,
    m_rheum_conditions___3 = m_rheum_conditions___3,
    m_rheum_conditions___4 = m_rheum_conditions___4,
    m_rheum_conditions___5 = m_rheum_conditions___5,
    m_rheum_conditions___6 = m_rheum_conditions___6,
    m_rheum_conditions___7 = m_rheum_conditions___7,
    m_rheum_conditions___88 = m_rheum_conditions___88,
    m_immunosuppression = m_immunosuppression,
    m_immunosup_conditions___4 = m_immunosup_conditions___4,
    mhccster = mhccster
  ))

data_with_str_steroid_comorb_0 |>
  count(str_steroid_comorb_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" or "0" and having "Unknown" for `mhrheumd` or `m_immunosuppression` or `mhccster`:

```{r}
data_with_str_steroid_comorb_0 |>
  filter(str_steroid_comorb_0 == 99) |>
  select(
    record_id,
    mhrheumd,
    m_immunosuppression,
    mhccster
  ) |>
  gt()
```

### Missing Values

The record missing (NA) for the variable "Steroid Responsive Comorbidity" (Systematic DAG) above is also missing for this variable.


## Obstructive Lung Disease -- Systematic DAG

**Variable Definition:**

Binary indicator variable

- 0 (No) = `(m_pulm_conditions___1 == 0)` AND `(m_pulm_conditions___3 == 0)`
- 1 (Yes) = `(m_pulm_conditions___1 == 1)` OR `(m_pulm_conditions___3 == 1)`
- 99 (Unknown) = `m_pulmonary == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_obstruct_lung_0 = calc_sys_obstruct_lung_0(
    m_pulmonary = m_pulmonary,
    m_pulm_conditions___1 = m_pulm_conditions___1,
    m_pulm_conditions___3 = m_pulm_conditions___3
  )) |>
  count(sys_obstruct_lung_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_pulmonary` listed under the variable "Steroid Responsive Comorbidity" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Steroid Responsive Comorbidity" (Systematic DAG) above is also missing for this variable.


## Obstructive Lung Disease -- Streamlined DAG

Currently calculated the same as Systematic DAG: Obstructive Lung Disease (see above).


## Chronic Immunocompromise -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = All `(m_immunosup_conditions___* == 0)` (excluding `m_immunosup_conditions___1`)
- 1 (Yes) = Any `(m_immunosup_conditions___* == 1)` (excluding `m_immunosup_conditions___1`)
- 99 (Unknown) = `m_immunosuppression == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_chron_immunocomp_0 = calc_sys_chron_immunocomp_0(
    m_immunosuppression = m_immunosuppression,
    m_immunosup_conditions___2 = m_immunosup_conditions___2,
    m_immunosup_conditions___3 = m_immunosup_conditions___3,
    m_immunosup_conditions___4 = m_immunosup_conditions___4,
    m_immunosup_conditions___5 = m_immunosup_conditions___5,
    m_immunosup_conditions___6 = m_immunosup_conditions___6,
    m_immunosup_conditions___7 = m_immunosup_conditions___7,
    m_immunosup_conditions___88 = m_immunosup_conditions___88
  )) |>
  count(sys_chron_immunocomp_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_immunosuppression` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.

## (REWORK) Hyperglycemia -- Systematic DAG

### Variable 1: Diabetes Medical History

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(m_endo_conditions___1 == 0)`
- 1 (Yes) = `(m_endo_conditions___1 == 1)`
- 99 (Unknown) = `m_endocrine == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_hyperglyc_hist_0 = calc_sys_hyperglyc_hist_0(
    m_endocrine = m_endocrine,
    m_endo_conditions___1 = m_endo_conditions___1
  )) |>
  count(sys_hyperglyc_hist_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### Unknown and Missing Values

Those with "Unknown" for `m_endocrine` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.

### Variable 2: Glucose Level

**Variable Definition:**

Continuous variable: Day 0 glucose measurement (`daily_gluc_8a_0`)

**Summary:**

```{r}
data_with_sys_hyperglyc_gluc_0 <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(sys_hyperglyc_gluc_0 = calc_sys_hyperglyc_gluc_0(
    daily_gluc_8a_0 = daily_gluc_8a_0,
    daily_gluc_nc_0 = daily_gluc_nc_0
  ))

data_with_sys_hyperglyc_gluc_0 |>
  select(sys_hyperglyc_gluc_0) |>
  filter(!is.na(sys_hyperglyc_gluc_0) & sys_hyperglyc_gluc_0 > -1) |>
  ggplot(aes(sys_hyperglyc_gluc_0)) +
    geom_histogram(bins = 40)
```

#### Missingness Report

The branching logic for `daily_gluc_nc_0` and `daily_gluc_8a_0` states that if `daily_gluc_8a_0` is missing (NA), then `daily_gluc_nc_0 == "Not Collected`.

Thus, according to the branching logic, these records were incorrectly missing `daily_gluc_8a_0` or `daily_gluc_nc_0`:

```{r}
data_with_sys_hyperglyc_gluc_0 |>
  filter(is.na(sys_hyperglyc_gluc_0)) |>
  select(
    record_id,
    daily_gluc_nc_0,
    daily_gluc_8a_0,
    sys_hyperglyc_gluc_0
  ) |>
  gt()
```

##### Valid NA

These records are missing a daily glucose measurement, but this is satisfied by the branching logic of `daily_gluc_nc_0 == "Not Collected"`. For these cases, the value of the variable `sys_hyperglyc_gluc_0` is set to `-1`.

```{r}
data_with_sys_hyperglyc_gluc_0 |>
  filter(sys_hyperglyc_gluc_0 == -1) |>
  select(
    record_id,
    sys_hyperglyc_gluc_0,
    daily_gluc_nc_0,
    daily_gluc_8a_0
  ) |>
  gt()
```

## (REWORK) Hyperglycemia -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(daily_gluc_8a_0 <= 250)` OR missing (NA)
- 1 (Yes) = `(daily_gluc_8a_0 > 250)`

**Summary:**

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(str_hyperglyc_hist_0 = calc_str_hyperglyc_hist_0(
    daily_gluc_8a_0 = daily_gluc_8a_0,
    daily_gluc_nc_0 = daily_gluc_nc_0
  )) |>
  count(str_hyperglyc_hist_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Missingness Report

According to the variable definition, all records can be assigned a value for this variable. However, as mentioned under Systematic DAG: Hyperglycemia Variable 2, these records missing `daily_gluc_8a_0` have invalid branching logic:

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_gluc_8a_0) & is.na(daily_gluc_nc_0)) |>
  select(
    record_id,
    daily_gluc_nc_0,
    daily_gluc_8a_0
  ) |>
  gt()
```

According to the variable definition, they were assigned `0` for `str_hyperglyc_hist_0`, but they should be looked at more closely.


## Active Fungal Infection -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(mhantifungals == "No")` AND `(daily_antifungal_0 == "Not administered")`
- 1 (Yes) = `(mhantifungals == "Yes")` OR `(daily_antifungal_0 == "Administered")`
- 99 (Unknown) = `(mhantifungals == "Unknown")` OR `(daily_antifungal_0 == "UNK")` (and first two conditions not met)

**Summary:**

```{r}
data_with_daily_fungal_0 <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  select(record_id, daily_antifungal_0, trx_0)

data_with_mhantifungals <- data |>
  filter(event_label == 'Day 0') |>
  select(record_id, mhantifungals)

data_fungal_joined <- data_with_daily_fungal_0 |>
  left_join(
    data_with_mhantifungals,
    by ='record_id'
    )

data_with_active_fungal_0 <- data_fungal_joined |>
  mutate(sys_active_fungal_0 = calc_sys_active_fungal_0(
    mhantifungals = mhantifungals,
    daily_antifungal_0 = daily_antifungal_0,
    trx_0 = trx_0
  ))

data_with_active_fungal_0 |>
  count(sys_active_fungal_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" or "0" and having "Unknown" for `mhantifungals` or `daily_antifungal_0`:

```{r}
data_with_active_fungal_0 |>
  filter(sys_active_fungal_0 == 99) |>
  select(
    record_id,
    mhantifungals,
    daily_antifungal_0
  ) |>
  gt()
```

### Missing Values

According to the branching logic, `daily_antifungal_0` will only have a value if `trx_0 == "Available"` and `trx_0` should have a value of either "Available" or "Not Available". These records were incorrectly missing (NA) `daily_antifungal_0` and/or `trx_0`:

```{r}
data_with_active_fungal_0 |>
  filter(is.na(sys_active_fungal_0)) |>
  select(
    record_id,
    mhantifungals,
    daily_antifungal_0,
    trx_0
  ) |>
  gt()
```

## Active Fungal Infection -- Streamlined DAG

Currently calculated the same as Systematic DAG: Active Fungal Infection (see above).

## Age -- Streamlined DAG

**Variable Definition:**

Age at enrollment (continuous variable)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(str_age_0 = calc_str_age_0(
    age = age
  )) |>
  ggplot(aes(str_age_0)) +
    geom_histogram(bins = 10) +
    ggtitle("Age at Enrollment")
```

There are no records missing `age_0`.

## Active SARS-CoV-2 Infection -- Systematic DAG

**Variable Definition:**

Binary indicator variable

- 0 (No) = If (not positive on OR before Day 0) OR not tested
- 1 (Yes) = If tested positive on OR before Day 0

**Summary:**

```{r}
# Get enrollment times
data_enrollment <- data |>
  filter(event_label == 'Day 0') |>
  select(record_id, enrollment_time)

# Get all positive COVID-19 tests on or before enrollment
data_positive_covid <- data |>
  filter(event_label == 'Hospital Discharge and Summary') |>
  left_join(
    get_code_label_map('cxpos', dictionary),
    by = 'cxpos'
  ) |>
  left_join(
    get_code_label_map('resp_pathogen', dictionary),
    by = 'resp_pathogen'
  ) |>
  filter(cxpos_code == 3 & resp_pathogen_code == 6) |>
  select(record_id, pathogen_date) |>
  left_join(data_enrollment, by = 'record_id') |>
  # Calculate if positive test was on or before enrollment
  mutate(positive_before_enrollment = pathogen_date <= enrollment_time) |>
  # Keep only tests on or before enrollment
  filter(positive_before_enrollment) |>
  # Group by patient and check if ANY test was positive before enrollment
  group_by(record_id) |>
  summarise(has_pos_covid_0 = 1, .groups = 'drop')

# Create final classification for variable
data_active_covid19 <- data_enrollment |>
  left_join(data_positive_covid, by = 'record_id') |>
  mutate(sys_active_covid19_0 = calc_sys_active_covid19_0(
    has_pos_covid_0 = has_pos_covid_0
  )) |>
  select(record_id, sys_active_covid19_0)

data_active_covid19 |>
  count(sys_active_covid19_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```


### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Active SARS-CoV-2 Infection -- Streamlined DAG

Currently calculated the same as Systematic DAG: Active SARS-CoV-2 Infection (see above).

## Active Influenza Infection -- Systematic DAG

**Variable Definition:**

Binary indicator variable

- 0 (No) = If (not positive on OR before Day 0) OR not tested
- 1 (Yes) = If tested positive on OR before Day 0

**Summary:**

```{r}
# Get enrollment times
data_enrollment <- data |>
  filter(event_label == 'Day 0') |>
  select(record_id, enrollment_time)

# Get all positive influenza tests on or before enrollment
data_positive_influenza <- data |>
  filter(event_label == 'Hospital Discharge and Summary') |>
  left_join(
    get_code_label_map('cxpos', dictionary),
    by = 'cxpos'
  ) |>
  left_join(
    get_code_label_map('resp_pathogen', dictionary),
    by = 'resp_pathogen'
  ) |>
  filter(cxpos_code == 3 & resp_pathogen_code %in% c(15, 16)) |>
  select(record_id, pathogen_date) |>
  left_join(data_enrollment, by = 'record_id') |>
  # Calculate if positive test was on or before enrollment
  mutate(positive_before_enrollment = pathogen_date <= enrollment_time) |>
  # Keep only tests on or before enrollment
  filter(positive_before_enrollment) |>
  # Group by patient and check if ANY test was positive before enrollment
  group_by(record_id) |>
  summarise(has_pos_influenza_0 = 1, .groups = 'drop')

# Create final classification for variable
data_active_influenza <- data_enrollment |>
  left_join(data_positive_influenza, by = 'record_id') |>
  mutate(sys_active_influenza_0 = calc_sys_active_influenza_0(
    has_pos_influenza_0 = has_pos_influenza_0
  )) |>
  select(record_id, sys_active_influenza_0)

data_active_influenza |>
  count(sys_active_influenza_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Active Influenza Infection -- Streamlined DAG

Currently calculated the same as Systematic DAG: Active Influenza Infection (see above).




## END
