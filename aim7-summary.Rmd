---
title: "APS Aim 7 Derived Variables Summary"
output:
  github_document:
    toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Libraries
library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')

## Get support functions
source('support_functions.R')

## Load data from N=500 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load(file = '../aps-data/20250731_data.RData')
```

```{r, echo = FALSE}
# Source variable derivation code
source("R/variables.R")
```

## (WIP) Hypotension Severity -- Systematic DAG

**Variable Definition:**

**Summary:**


## Hypotension Severity -- Streamlined DAG

Currently calculated the same as Systematic DAG: Hypotension Severity (see above).

## (WIP) Baseline Performance Status -- Systematic DAG

### Variable 1: Frailty Status

**Variable Definition:**

Derived from `frailty_base`:

- 0 = Not performed
- 1 = Very Fit
- 2 = Fit
- 3 = Managing Well
- 4 = Living with very mild frailty
- 5 = Living with mild frailty
- 6 = Living with moderate frailty
- 7 = Living with severe frailty
- 8 = Living with very severe frailty
- 9 = Terminally ill

**Summary:**

```{r}
data |>
  filter(event_label == "Patient/Surrogate Interview") |>
  left_join(
    get_code_label_map('frailty_base', dictionary),
    by ='frailty_base'
    ) |>
  mutate(sys_frailty_status_0 = calc_sys_frailty_status_0(
    frailty_base_code = frailty_base_code,
    frailty_perf = frailty_perf
  )) |>
  count(sys_frailty_status_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```


### (WIP, BLOCKED) Variable 2: Comorbidity Burden

**Variable Definition:**

**Summary:**

## (WIP) Organ Failure Trajectory -- Systematic DAG

**Variable Definition:**

**Summary:**



## Delirium -- Systematic DAG

**Variable Definition:**

Three-level variable:

- 0 = CAM done and not present (negative on all assessments)
- 1 = CAM done and present (positive at least once)
- 2 = CAM not done

**Summary:**

```{r}
data_with_delirium <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    sys_delirium_0 = calc_sys_delirium_0(
      cam_0 = cam_0,
      cam_m1 = cam_m1,
      cam_m2 = cam_m2,

      lowrass_orres_0 = lowrass_orres_0,
      lowrass_orres_m1 = lowrass_orres_m1,
      lowrass_orres_m2 = lowrass_orres_m2,

      highestrass_orres_0 = highestrass_orres_0,
      highestrass_orres_m1 = highestrass_orres_m1,
      highestrass_orres_m2 = highestrass_orres_m2
    )
  )

data_with_delirium |>
  count(sys_delirium_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Delirium -- Streamlined DAG

Currently calculated the same as Systematic DAG: Delirium (see above).


## Presence of Sepsis Syndrome -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Syndrome not present OR syndrome not present on or before Day 0
- 1 = Syndrome present AND syndrome present on or before Day 0
- 99 = Unknown

**Summary:**

```{r}
data_with_sepsis <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  mutate(
    sys_sepsis_0 = calc_sys_sepsis_0(
      sepsis_present,
      sepsis_clinical_judgement
    )
  )

data_with_sepsis |>
  count(sys_sepsis_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because they were missing (NA) `sepsis_present` and have `sepsis_clinical_judgement == 'Unknown'`.

```{r}
data_with_sepsis |>
  filter(sys_sepsis_0 == 99) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement
  ) |>
  gt()
```

This record was missing (NA) `sepsis_present` but had `sepsis_clinical_judgement == 'Yes'`. According to the DAG formula, this is classified as NA. (see question in the function code).

```{r}
data_with_sepsis |>
  filter(is.na(sys_sepsis_0)) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement
  ) |>
  gt()
```

## Presence of ARDS Syndrome -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Syndrome not present OR syndrome not present on or before Day 0
- 1 = Syndrome present AND syndrome present on or before Day 0
- 99 = Unknown

**Summary:**

```{r}
data_with_ards <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  mutate(
    sys_ards_0 = calc_sys_ards_0(
      ards_present,
      ards_clinical_judgement
    )
  )

data_with_ards |>
  count(sys_ards_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.


## Presence of ARDS Syndrome -- Streamlined DAG

Currently calculated the same as Systematic DAG: Presence of ARDS Syndrome (see above).

## Presence of Pneumonia Syndrome -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Syndrome not present OR syndrome not present on or before Day 0
- 1 = Syndrome present AND syndrome present on or before Day 0
- 99 = Unknown

**Summary:**

```{r}
# Get enrollment times
data_enrollment <- data |>
  filter(event_label == 'Day 0') |>
  select(record_id, enrollment_time)

# Join with PNA data
data_with_pneumonia <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  select(
    record_id,
    pna_clinical_judgement,
    pna_date
    ) |>
  left_join(data_enrollment, by = 'record_id') |>
  mutate(
    sys_pneumonia_0 = calc_sys_pneumonia_0(
      pna_clinical_judgement,
      pna_date,
      enrollment_time
    )
  )

data_with_pneumonia |>
  count(sys_pneumonia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```
### Unknown/Missing Values

These records are missing `pna_date` and have `pna_clinical_judgement == "Unknown"` and are consequently assigned `99 (Unknown)`:

```{r}
data_with_pneumonia |>
  filter(sys_pneumonia_0 == 99) |>
  select(
    record_id,
    pna_clinical_judgement,
    pna_date,
    enrollment_time
  ) |>
  gt()
```

## Presence of Pneumonia Syndrome -- Streamlined DAG

Currently calculated the same as Systematic DAG: Presence of Pneumonia Syndrome (see above).

## (WIP) Septic Shock -- Systematic DAG

**Variable Definition:**

**Summary:**


## (WIP) Septic Shock -- Streamlined DAG

**Variable Definition:**

**Summary:**




## (WIP) Gastrointestinal Bleeding -- Streamlined DAG

**Variable Definition:**

**Summary:**

## Major Recent Surgery -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 = No surgery on Day -2, Day -1, AND Day 0
- 1 = Surgery on Day -2, Day -1, OR Day 0
- 99 = Unknown

**Summary:**

```{r}
data_with_major_surgery <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_major_surgery_0 = calc_str_major_surgery_0(
      daily_surgery_m2,
      daily_surgery_m1,
      daily_surgery_0
    )
  )

data_with_major_surgery |>
  count(str_major_surgery_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

The following records have `daily_surgery_* == NA` with the corresponding `trx_* == 'Not Available'`. This satisfies the branching logic, but should these records be classified as `0 (No Surgery)` or queried?

```{r}
data_with_major_surgery |>
  filter(is.na(str_major_surgery_0)) |>
  select(
    record_id,
    daily_surgery_m2,
    trx_m2,
    daily_surgery_m1,
    trx_m1,
    daily_surgery_0,
    trx_0
  ) |>
  gt()
```

## Dementia -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = No dementia history
- 1 = Dementia history
- 99 = Unknown

**Summary:**

```{r}
data_with_dementia <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_dementia_0 = calc_str_dementia_0(
      m_neurologic_conditions___1,
      m_neurologic
    )
  )

data_with_dementia |>
  count(str_dementia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because `m_neurologic == "Unknown"`:

```{r}
data_with_dementia |>
  filter(str_dementia_0 == 99) |>
  select(
    record_id,
    m_neurologic_conditions___1,
    m_neurologic
  ) |>
  gt()
```

One record was missing (NA) `m_neurologic`, but this is the same record missing from the N=500 dataset and does not need to be queried further.

## Acute Allergic Reaction -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = No suspected anaphylaxis if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected anaphylaxis if `organ_dysnfx_cause` = 2

**Summary:**

```{r}
data_with_allergic <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_acute_allergic_reaction_0 = calc_str_acute_allergic_reaction_0(
      organ_dysfnx_cause_code
    )
  )

data_with_allergic |>
  count(str_acute_allergic_reaction_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Diffuse Alveolar Hemorrhage -- Streamlined DAG

**Variable Definition:**

Binary variable (likely not used in primary analysis):

- 0 = No DAH if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected DAH if `organ_dysnfx_cause` = 2

**Summary:**

```{r}
data_with_dah <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_dah_0 = calc_str_dah_0(
      organ_dysfnx_cause_code
    )
  )

data_with_dah |>
  count(str_dah_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Acute Inflammatory Drug Toxicity -- Streamlined DAG

**Variable Definition:**

Binary variable (likely not used in primary analysis):

- 0 = No acute inflammatory drug reaction if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected acute inflammatory drug reaction if `organ_dysnfx_cause` = 2

**Summary:**

```{r}
data_with_drug_toxicity <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_drug_toxicity_0 = calc_str_drug_toxicity_0(
      organ_dysfnx_cause_code
    )
  )

data_with_drug_toxicity |>
  count(str_drug_toxicity_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Acute Cryptogenic Organizing Pneumonia -- Streamlined DAG

**Variable Definition:**

Binary variable (likely not used in primary analysis):

- 0 = No acute COP if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected acute COP if `organ_dysnfx_cause` = 2

**Summary:**

```{r}
data_with_cop <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_cop_0 = calc_str_cop_0(
      organ_dysfnx_cause_code
    )
  )

data_with_cop |>
  count(str_cop_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## (WIP - STARTED) SCAP Criterion Respiratory Rate -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 daily value. If that's not available, use last
value carried forward from Day -1 or Day -2:

- 0 = Respiratory rate ≤ 30
- 1 = Respiratory rate > 30

**Summary:**

```{r}
data_with_scap_rr <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_rr_0 = calc_str_scap_rr_0(
      daily_resp_rate_8a_0,
      daily_resp_rate_8a_m1,
      daily_resp_rate_8a_m2
    )
  )

data_with_scap_rr |>
  count(str_scap_rr_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because TODO

```{r}
data_with_scap_rr |>
  filter(str_scap_rr_0 == 99) |>
  select(
    record_id,
    daily_resp_rate_8a_0,
    daily_resp_rate_8a_m1,
    daily_resp_rate_8a_m2
  ) |>
  gt()
```

These records were missing (NA) because TODO

```{r}
data_with_scap_rr |>
  filter(is.na(str_scap_rr_0)) |>
  select(
    record_id,
    daily_resp_rate_8a_0,
    daily_resp_rate_8a_m1,
    daily_resp_rate_8a_m2
  ) |>
  gt()
```

## (WIP - STARTED) SCAP Criterion BUN Value -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 daily value. If that's not available, use last
value carried forward from Day -1 or Day -2:

- 0 = BUN ≤ 30 mg/dL
- 1 = BUN > 30 mg/dL

**Summary:**

```{r}
data_with_scap_bun <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_bun_0 = calc_str_scap_bun_0(
      daily_bun_8a_0,
      daily_bun_8a_m1,
      daily_bun_8a_m2
    )
  )

data_with_scap_bun |>
  count(str_scap_bun_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because TODO

```{r}
data_with_scap_bun |>
  filter(str_scap_bun_0 == 99) |>
  select(
    record_id,
    daily_bun_8a_0,
    daily_bun_8a_m1,
    daily_bun_8a_m2
  ) |>
  gt()
```

These records were missing (NA) because TODO

```{r}
data_with_scap_bun |>
  filter(is.na(str_scap_bun_0)) |>
  select(
    record_id,
    daily_bun_8a_0,
    daily_bun_8a_m1,
    daily_bun_8a_m2
  ) |>
  gt()
```

## (WIP - STARTED) SCAP Criterion Acidosis -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 daily lowest. If that's not available, use last
value carried forward from Day -1 or Day -2:

- 0 = pH ≥ 7.30
- 1 = pH < 7.30

**Summary:**

```{r}
data_with_scap_acidosis <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_acidosis_0 = calc_str_scap_acidosis_0(
      daily_ph_lowest_0,
      daily_ph_lowest_m1,
      daily_ph_lowest_m2
    )
  )

data_with_scap_acidosis |>
  count(str_scap_acidosis_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because TODO

```{r}
data_with_scap_acidosis |>
  filter(str_scap_acidosis_0 == 99) |>
  select(
    record_id,
    daily_ph_lowest_0,
    daily_ph_lowest_m1,
    daily_ph_lowest_m2
  ) |>
  gt()
```

These records were missing (NA) because TODO

```{r}
data_with_scap_acidosis |>
  filter(is.na(str_scap_acidosis_0)) |>
  select(
    record_id,
    daily_ph_lowest_0,
    daily_ph_lowest_m1,
    daily_ph_lowest_m2
  ) |>
  gt()
```

## (WIP - STARTED) SCAP Criterion Bilateral Opacities -- Streamlined DAG

**Variable Definition:**

Binary variable using imaging from the syndrome adjudication form:

- 0 = No bilateral opacities if all `*_opacity` values are not "2"
- 1 = Yes bilateral opacities if any one of listed `*_opacity` values are "2"

**Summary:**

```{r}
data_with_scap_bilat_opac <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  mutate(
    str_scap_bilateral_opacities_0 = calc_str_scap_bilateral_opacities_0(
      cxr_dm2_available,
      cxr_dm2_opacity,
      ct_dm2_available,
      ct_dm2_opacity,
      cxr_dm1_available,
      cxr_dm1_opacity,
      ct_dm1_available,
      ct_dm1_opacity,
      cxr_d0_available,
      cxr_d0_opacity,
      ct_d0_available,
      ct_d0_opacity
    )
  )

data_with_scap_bilat_opac |>
  count(str_scap_bilateral_opacities_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because TODO

```{r}
data_with_scap_bilat_opac |>
  filter(str_scap_bilateral_opacities_0 == 99) |>
  select(
    record_id,
    cxr_dm2_available,
    cxr_dm2_opacity,
    ct_dm2_available,
    ct_dm2_opacity,
    cxr_dm1_available,
    cxr_dm1_opacity,
    ct_dm1_available,
    ct_dm1_opacity,
    cxr_d0_available,
    cxr_d0_opacity,
    ct_d0_available,
    ct_d0_opacity
  ) |>
  gt()
```

These records were missing (NA) because TODO

```{r}
data_with_scap_bilat_opac |>
  filter(is.na(str_scap_bilateral_opacities_0)) |>
  select(
    record_id,
    cxr_dm2_available,
    cxr_dm2_opacity,
    ct_dm2_available,
    ct_dm2_opacity,
    cxr_dm1_available,
    cxr_dm1_opacity,
    ct_dm1_available,
    ct_dm1_opacity,
    cxr_d0_available,
    cxr_d0_opacity,
    ct_d0_available,
    ct_d0_opacity
  ) |>
  gt()
```

## (WIP - STARTED) SCAP Criterion Leukopenia -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 value from daily assessment data. If that's not
available, use last value carried forward from Day -1 or Day -2:

- 0 = WBC ≥ 4
- 1 = WBC < 4

**Summary:**

```{r}
data_with_scap_leukopenia <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_leukopenia_0 = calc_str_scap_leukopenia_0(
      daily_wbc_8a_0,
      daily_wbc_8a_m1,
      daily_wbc_8a_m2
    )
  )

data_with_scap_leukopenia |>
  count(str_scap_leukopenia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because TODO

```{r}
data_with_scap_leukopenia |>
  filter(str_scap_leukopenia_0 == 99) |>
  select(
    record_id,
    daily_wbc_8a_0,
    daily_wbc_8a_m1,
    daily_wbc_8a_m2
  ) |>
  gt()
```

These records were missing (NA) because TODO

```{r}
data_with_scap_leukopenia |>
  filter(is.na(str_scap_leukopenia_0)) |>
  select(
    record_id,
    daily_wbc_8a_0,
    daily_wbc_8a_m1,
    daily_wbc_8a_m2
  ) |>
  gt()
```

## (WIP - STARTED) SCAP Criterion Thrombocytopenia -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 value from daily assessment data. If that's not
available, use last value carried forward from Day -1 or Day -2:

- 0 = Platelets ≥ 100
- 1 = Platelets < 100

**Summary:**

```{r}
data_with_scap_thrombocyt <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_thrombocytopenia_0 = calc_str_scap_thrombocytopenia_0(
      daily_platelet_8a_0,
      daily_platelet_8a_m1,
      daily_platelet_8a_m2
    )
  )

data_with_scap_thrombocyt |>
  count(str_scap_thrombocytopenia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because TODO

```{r}
data_with_scap_thrombocyt |>
  filter(str_scap_thrombocytopenia_0 == 99) |>
  select(
    record_id,
    daily_platelet_8a_0,
    daily_platelet_8a_m1,
    daily_platelet_8a_m2
  ) |>
  gt()
```

These records were missing (NA) because TODO

```{r}
data_with_scap_thrombocyt |>
  filter(is.na(str_scap_thrombocytopenia_0)) |>
  select(
    record_id,
    daily_platelet_8a_0,
    daily_platelet_8a_m1,
    daily_platelet_8a_m2
  ) |>
  gt()
```

## (WIP - STARTED) SCAP Criterion Hypothermia -- Streamlined DAG

**Variable Definition:**

Binary variable from the "Vital signs day 0" form. If that's not available,
use last value carried forward from Day -1 or Day -2:

- 0 = Temperature ≥ 35.0°C
- 1 = Temperature < 35.0°C

**Summary:**

```{r}
data_with_scap_hypothermia <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_scap_hypothermia_0 = calc_str_scap_hypothermia_0(
      lowtemp_vsorres,
      lowtemp_vsorres_m1,
      lowtemp_vsorres_m2
    )
  )

data_with_scap_hypothermia |>
  count(str_scap_hypothermia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because TODO

```{r}
data_with_scap_hypothermia |>
  filter(str_scap_hypothermia_0 == 99) |>
  select(
    record_id,
    lowtemp_vsorres,
    lowtemp_vsorres_m1,
    lowtemp_vsorres_m2
  ) |>
  gt()
```

These records were missing (NA) because TODO

```{r}
data_with_scap_hypothermia |>
  filter(is.na(str_scap_hypothermia_0)) |>
  select(
    record_id,
    lowtemp_vsorres,
    lowtemp_vsorres_m1,
    lowtemp_vsorres_m2
  ) |>
  gt()
```

## (WIP - STARTED) Chronic Neuromuscular Disease -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = No chronic neuromuscular disease history
- 1 = Chronic neuromuscular disease history
- 99 = Unknown

**Summary:**

```{r}
data_with_neuromuscular <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_neuromuscular_disease_0 = calc_str_neuromuscular_disease_0(
      m_neurologic_conditions___6,
      m_neurologic
    )
  )

data_with_neuromuscular |>
  count(str_neuromuscular_disease_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because TODO

```{r}
data_with_neuromuscular |>
  filter(str_neuromuscular_disease_0 == 99) |>
  select(
    record_id,
    m_neurologic_conditions___6,
    m_neurologic
  ) |>
  gt()
```

These records were missing (NA) because TODO

```{r}
data_with_neuromuscular |>
  filter(is.na(str_neuromuscular_disease_0)) |>
  select(
    record_id,
    m_neurologic_conditions___6,
    m_neurologic
  ) |>
  gt()
```

## (WIP) PSI Score -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP - STARTED) Active Vasculitis -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = No vasculitis history if has no history of vasculitis OR (has no current
      immunosuppression for nontransplant/non-cancer condition AND has no
      current chronic steroids)
- 1 = Vasculitis history if has history of vasculitis AND (has current
      immunosuppression for nontransplant/non-cancer condition OR has current
      chronic steroids)
- 99 = Unknown

**Summary:**

```{r}
data_with_vasculitis <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_vasculitis_0 = calc_str_vasculitis_0(
      m_rheum_conditions___8,
      m_immunosup_conditions___4,
      mhccster
    )
  )

data_with_vasculitis |>
  count(str_vasculitis_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because TODO

```{r}
data_with_vasculitis |>
  filter(str_vasculitis_0 == 99) |>
  select(
    record_id,
    m_rheum_conditions___8,
    m_immunosup_conditions___4,
    mhccster
  ) |>
  gt()
```

These records were missing (NA) because TODO

```{r}
data_with_vasculitis |>
  filter(is.na(str_vasculitis_0)) |>
  select(
    record_id,
    m_rheum_conditions___8,
    m_immunosup_conditions___4,
    mhccster
  ) |>
  gt()
```
