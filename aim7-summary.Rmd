---
title: "APS Aim 7 Derived Variables Summary"
output:
  github_document:
    toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Libraries
library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')

## Get support functions
source('support_functions.R')

## Load data from N=500 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load(file = '../aps-data/20250731_data.RData')
```

```{r, echo = FALSE}
# Source variable derivation code
source("R/variables.R")
```

## Definite Adrenal Insufficiency -- Systematic DAG

**Variable Definition:**

Binary indicator variable (used to exclude patients if yes)

- 0 (No) = `(m_endo_conditions___2 == 0)` AND `(m_immunosup_conditions___1 == 0)`
- 1 (Yes) = `(m_endo_conditions___2 == 1)` OR `(m_immunosup_conditions___1 == 1)`
- 99 (Unknown) = `m_endocrine == "Unknown"` OR `m_immunosuppression == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_def_adrenal_insufficiency_0 = calc_sys_def_adrenal_insufficiency_0(
    m_endocrine = m_endocrine,
    m_endo_conditions___2 = m_endo_conditions___2,
    m_immunosuppression = m_immunosuppression,
    m_immunosup_conditions___1 = m_immunosup_conditions___1
  )) |>
  count(sys_def_adrenal_insufficiency_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" or "0" and having "Unknown" for either `m_endocrine` or `m_immunosuppression`:

```{r}
data |>
  filter(event_label == 'Day 0') |>
  filter(is_unknown(m_endocrine) | is_unknown(m_immunosuppression)) |>
  select(
    record_id,
    m_endocrine,
    m_immunosuppression
  ) |>
  gt()
```

### Missing Values

According to the branching logic, `m_endo_conditions___*` will only have a value if `m_endocrine == "Yes"` and `m_immunosup_conditions___*` will only have a value if `m_immunosuppression == "Yes"`. One record was missing (NA) both `m_endocrine` and `m_immunosuppression`, but this is the same record missing from the N=500 dataset and does not need to be queried further.

## Definite Adrenal Insufficiency -- Streamlined DAG

**Variable Definition:**

Binary indicator variable (used to exclude patients if yes)

- 0 (No) = `(m_endo_conditions___2 == 0)`
- 1 (Yes) = `(m_endo_conditions___2 == 1)`
- 99 (Unknown) = `m_endocrine == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(str_def_adrenal_insufficiency_0 = calc_str_adrenal_insufficiency_0(
    m_endocrine,
    m_endo_conditions___2 = m_endo_conditions___2
  )) |>
  count(str_def_adrenal_insufficiency_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_endocrine` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.

## Chronic Steroids High Dose -- Streamlined DAG

**Variable Definition:**

Binary indicator variable (used to exclude patients if yes):

- 0 (No) = `m_immunosup_conditions___1 == 0`
- 1 (Yes) = `m_immunosup_conditions___1 == 1`
- 99 (Unknown) = `m_immunosuppression == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(str_chron_steroid_highdose_0 = calc_str_chron_steroid_highdose_0(
    m_immunosuppression = m_immunosuppression,
    m_immunosup_conditions___1 = m_immunosup_conditions___1
  )) |>
  count(str_chron_steroid_highdose_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_immunosuppression` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.


## Rheumatologic Disease -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = All `(m_rheum_conditions___* == 0)` AND `(m_pulm_conditions___6 == 0)`
- 1 (Yes) = Any `(m_rheum_conditions___* == 1)` OR `(m_pulm_conditions___6 == 1)`
- 99 (Unknown) = `mhrheumd == "Unknown"` OR `m_pulmonary == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data_with_sys_rheumdis_0 <- data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_rheumdis_0 = calc_sys_rheumdis_0(
    mhrheumd = mhrheumd,
    m_rheum_conditions___1 = m_rheum_conditions___1,
    m_rheum_conditions___2 = m_rheum_conditions___2,
    m_rheum_conditions___3 = m_rheum_conditions___3,
    m_rheum_conditions___4 = m_rheum_conditions___4,
    m_rheum_conditions___5 = m_rheum_conditions___5,
    m_rheum_conditions___6 = m_rheum_conditions___6,
    m_rheum_conditions___7 = m_rheum_conditions___7,
    m_rheum_conditions___8 = m_rheum_conditions___8,
    m_rheum_conditions___88 = m_rheum_conditions___88,
    m_pulmonary = m_pulmonary,
    m_pulm_conditions___6 = m_pulm_conditions___6
  ))

data_with_sys_rheumdis_0 |>
  count(sys_rheumdis_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown Values

These records were assigned "99 (Unknown)" due to not fitting the variable definition for "1" or "0" and having "Unknown" for `mhrheumd` or `m_pulmonary`:

```{r}
data_with_sys_rheumdis_0 |>
  filter(sys_rheumdis_0 == 99) |>
  select(
    record_id,
    mhrheumd,
    m_pulmonary
  ) |>
  gt()
```

### Missing Values

According to the branching logic, `m_rheum_conditions___*` will only have a value if `mhrheumd == "Yes"` and `m_pulm_conditions___*` will only have a value if `m_pulmonary == "Yes"`. One record was missing (NA) `mhrheumd` and `m_pulmonary`, but this is the same record missing from the N=500 dataset and does not need to be queried further.

## Rheumatologic Disease -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = All `(m_rheum_conditions___* == 0)`
- 1 (Yes) = Any `(m_rheum_conditions___* == 1)`
- 99 (Unknown) = `mhrheumd == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(str_rheumdis_0 = calc_str_rheumdis_0(
    mhrheumd = mhrheumd,
    m_rheum_conditions___1 = m_rheum_conditions___1,
    m_rheum_conditions___2 = m_rheum_conditions___2,
    m_rheum_conditions___3 = m_rheum_conditions___3,
    m_rheum_conditions___4 = m_rheum_conditions___4,
    m_rheum_conditions___5 = m_rheum_conditions___5,
    m_rheum_conditions___6 = m_rheum_conditions___6,
    m_rheum_conditions___7 = m_rheum_conditions___7,
    m_rheum_conditions___8 = m_rheum_conditions___8,
    m_rheum_conditions___88 = m_rheum_conditions___88
  )) |>
  count(str_rheumdis_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `mhrheumd` listed under the variable "Rheumatologic Disease" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Rheumatologic Disease" (Systematic DAG) above is also missing for this variable.


## ILD -- Streamlined DAG

**Variable Definition:**

Binary indicator variable

- 0 (No) = `(m_pulm_conditions___6 == 0)`
- 1 (Yes) = `(m_pulm_conditions___6 == 1)`
- 99 (Unknown) = `m_pulmonary == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(str_ild_0 = calc_str_ild_0(
    m_pulmonary = m_pulmonary,
    m_pulm_conditions___6 = m_pulm_conditions___6
  )) |>
  count(str_ild_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_pulmonary` listed under the variable "Rheumatologic Disease" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Rheumatologic Disease" (Systematic DAG) above is also missing for this variable.


## Obstructive Lung Disease -- Systematic DAG

**Variable Definition:**

Binary indicator variable

- 0 (No) = `(m_pulm_conditions___1 == 0)` AND `(m_pulm_conditions___3 == 0)`
- 1 (Yes) = `(m_pulm_conditions___1 == 1)` OR `(m_pulm_conditions___3 == 1)`
- 99 (Unknown) = `m_pulmonary == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_obstruct_lung_0 = calc_sys_obstruct_lung_0(
    m_pulmonary = m_pulmonary,
    m_pulm_conditions___1 = m_pulm_conditions___1,
    m_pulm_conditions___3 = m_pulm_conditions___3
  )) |>
  count(sys_obstruct_lung_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_pulmonary` listed under the variable "Rheumatologic Disease" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Rheumatologic Disease" (Systematic DAG) above is also missing for this variable.


## Obstructive Lung Disease -- Streamlined DAG

Currently calculated the same as Systematic DAG: Obstructive Lung Disease (see above).

## (WIP) Active SARS-CoV-2 Infection -- Systematic DAG

**Variable Definition:**

Binary indicator variable

- 0 (No) = If (not positive on OR before Day 0) OR not tested
- 1 (Yes) = If tested positive on OR before Day 0

**Summary:**

```{r}
data |>
  filter(event_label == 'Hospital Discharge and Summary') |>
  left_join(
    get_code_label_map('cxpos', dictionary),
    by ='cxpos'
    ) |>
  left_join(
    get_code_label_map('resp_pathogen', dictionary),
    by ='resp_pathogen'
    ) |>
  mutate(sys_active_covid19_0 = calc_sys_active_covid19_0(
    pathogen_date = pathogen_date,
    resp_pathogen_code = resp_pathogen_code,
    cxpos_code = cxpos_code
  )) |>
  count(sys_active_covid19_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

## Active SARS-CoV-2 Infection -- Streamlined DAG

Currently calculated the same as Systematic DAG: Active SARS-CoV-2 Infection (see above).

## Chronic Immunocompromise -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = All `(m_immunosup_conditions___* == 0)` (excluding `m_immunosup_conditions___1`)
- 1 (Yes) = Any `(m_immunosup_conditions___* == 1)` (excluding `m_immunosup_conditions___1`)
- 99 (Unknown) = `m_immunosuppression == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_chron_immunocomp_0 = calc_sys_chron_immunocomp_0(
    m_immunosuppression = m_immunosuppression,
    m_immunosup_conditions___2 = m_immunosup_conditions___2,
    m_immunosup_conditions___3 = m_immunosup_conditions___3,
    m_immunosup_conditions___4 = m_immunosup_conditions___4,
    m_immunosup_conditions___5 = m_immunosup_conditions___5,
    m_immunosup_conditions___6 = m_immunosup_conditions___6,
    m_immunosup_conditions___7 = m_immunosup_conditions___7,
    m_immunosup_conditions___88 = m_immunosup_conditions___88
  )) |>
  count(sys_chron_immunocomp_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown and Missing Values

Those with "Unknown" for `m_immunosuppression` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.

## Chronic Immunocompromise -- Streamlined DAG

Currently calculated the same as Systematic DAG: Chronic Immunocompromise (see above).

## Hyperglycemia -- Systematic DAG

### Variable 1: Diabetes Medical History

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(m_endo_conditions___1 == 0)`
- 1 (Yes) = `(m_endo_conditions___1 == 1)`
- 99 (Unknown) = `m_endocrine == "Unknown"` (and first two conditions not met)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(sys_hyperglyc_hist_0 = calc_sys_hyperglyc_hist_0(
    m_endocrine = m_endocrine,
    m_endo_conditions___1 = m_endo_conditions___1
  )) |>
  count(sys_hyperglyc_hist_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

#### Unknown and Missing Values

Those with "Unknown" for `m_endocrine` listed under the variable "Definite Adrenal Insufficiency" (Systematic DAG) above are also "Unknown" for this variable.

The record missing (NA) for the variable "Definite Adrenal Insufficiency" (Systematic DAG) above is also missing for this variable.

### Variable 2: Glucose Level

**Variable Definition:**

Continuous variable: Day 0 glucose measurement (`daily_gluc_8a_0`)

**Summary:**

```{r}
data_with_sys_hyperglyc_gluc_0 <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(sys_hyperglyc_gluc_0 = calc_sys_hyperglyc_gluc_0(
    daily_gluc_8a_0 = daily_gluc_8a_0,
    daily_gluc_nc_0 = daily_gluc_nc_0
  ))

data_with_sys_hyperglyc_gluc_0 |>
  select(sys_hyperglyc_gluc_0) |>
  filter(!is.na(sys_hyperglyc_gluc_0) & sys_hyperglyc_gluc_0 > -1) |>
  ggplot(aes(sys_hyperglyc_gluc_0)) +
    geom_histogram(bins = 40)
```

#### Missingness Report

The branching logic for `daily_gluc_nc_0` and `daily_gluc_8a_0` states that if `daily_gluc_8a_0` is missing (NA), then `daily_gluc_nc_0 == "Not Collected`.

Thus, according to the branching logic, these records were incorrectly missing `daily_gluc_8a_0` or `daily_gluc_nc_0`:

```{r}
data_with_sys_hyperglyc_gluc_0 |>
  filter(is.na(sys_hyperglyc_gluc_0)) |>
  select(
    record_id,
    daily_gluc_nc_0,
    daily_gluc_8a_0,
    sys_hyperglyc_gluc_0
  ) |>
  gt()
```

##### Valid NA

These records are missing a daily glucose measurement, but this is satisfied by the branching logic of `daily_gluc_nc_0 == "Not Collected"`. For these cases, the value of the variable `sys_hyperglyc_gluc_0` is set to `-1`.

```{r}
data_with_sys_hyperglyc_gluc_0 |>
  filter(sys_hyperglyc_gluc_0 == -1) |>
  select(
    record_id,
    sys_hyperglyc_gluc_0,
    daily_gluc_nc_0,
    daily_gluc_8a_0
  ) |>
  gt()
```

## Hyperglycemia -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 (No) = `(daily_gluc_8a_0 <= 250)` OR missing (NA)
- 1 (Yes) = `(daily_gluc_8a_0 > 250)`

**Summary:**

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(str_hyperglyc_hist_0 = calc_str_hyperglyc_hist_0(
    daily_gluc_8a_0 = daily_gluc_8a_0,
    daily_gluc_nc_0 = daily_gluc_nc_0
  )) |>
  count(str_hyperglyc_hist_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Missingness Report

According to the variable definition, all records can be assigned a value for this variable. However, as mentioned under Systematic DAG: Hyperglycemia Variable 2, these records missing `daily_gluc_8a_0` have invalid branching logic:

```{r}
data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  filter(is.na(daily_gluc_8a_0) & is.na(daily_gluc_nc_0)) |>
  select(
    record_id,
    daily_gluc_nc_0,
    daily_gluc_8a_0
  ) |>
  gt()
```

According to the variable definition, they were assigned `0` for `str_hyperglyc_hist_0`, but they should be looked at more closely.

## (WIP) Active Influenza Infection -- Systematic DAG

**Summary:**

## (WIP) Active Influenza Infection -- Streamlined DAG

**Summary:**


## Age -- Streamlined DAG

**Variable Definition:**

Age at enrollment (continuous variable)

**Summary:**

```{r}
data |>
  filter(event_label == 'Day 0') |>
  mutate(age_0 = calc_age_0(
    age = age
  )) |>
  ggplot(aes(age_0)) +
    geom_histogram(bins = 10) +
    ggtitle("Age at Enrollment")
```

There are no records missing `age_0`.
