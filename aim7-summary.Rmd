---
title: "APS Aim 7 Derived Variables Summary"
output:
  github_document:
    toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Libraries
library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')

## Get support functions
source('support_functions.R')

## Load data from N=500 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load(file = '../aps-data/20250731_data.RData')
```

```{r, echo = FALSE}
# Source variable derivation code
source("R/variables.R")
```

## (WIP) Global Physiology Severity -- Systematic DAG

**Variable Definition:**

**Summary:**

## (WIP) Hypotension Severity -- Systematic DAG

**Variable Definition:**

**Summary:**


## Hypotension Severity -- Streamlined DAG

Currently calculated the same as Systematic DAG: Hypotension Severity (see above).

## (WIP, BLOCKED) Active SARS-CoV-2 Infection -- Systematic DAG

**Variable Definition:**

Binary indicator variable

- 0 (No) = If (not positive on OR before Day 0) OR not tested
- 1 (Yes) = If tested positive on OR before Day 0

**Summary:**

```{r}
data |>
  filter(event_label == 'Hospital Discharge and Summary') |>
  left_join(
    get_code_label_map('cxpos', dictionary),
    by ='cxpos'
    ) |>
  left_join(
    get_code_label_map('resp_pathogen', dictionary),
    by ='resp_pathogen'
    ) |>
  mutate(sys_active_covid19_0 = calc_sys_active_covid19_0(
    pathogen_date = pathogen_date,
    resp_pathogen_code = resp_pathogen_code,
    cxpos_code = cxpos_code
  )) |>
  count(sys_active_covid19_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

## Active SARS-CoV-2 Infection -- Streamlined DAG

Currently calculated the same as Systematic DAG: Active SARS-CoV-2 Infection (see above).

## (WIP, BLOCKED) Active Influenza Infection -- Systematic DAG

**Variable Definition:**

**Summary:**

## (WIP, BLOCKED) Active Influenza Infection -- Streamlined DAG

**Variable Definition:**

**Summary:**


## (WIP) Baseline Performance Status -- Systematic DAG

### Variable 1: Frailty Status

**Variable Definition:**

Derived from `frailty_base`:

- 0 = Not performed
- 1 = Very Fit
- 2 = Fit
- 3 = Managing Well
- 4 = Living with very mild frailty
- 5 = Living with mild frailty
- 6 = Living with moderate frailty
- 7 = Living with severe frailty
- 8 = Living with very severe frailty
- 9 = Terminally ill

**Summary:**

```{r}
data |>
  filter(event_label == "Patient/Surrogate Interview") |>
  left_join(
    get_code_label_map('frailty_base', dictionary),
    by ='frailty_base'
    ) |>
  mutate(sys_frailty_status_0 = calc_sys_frailty_status_0(
    frailty_base_code = frailty_base_code,
    frailty_perf = frailty_perf
  )) |>
  count(sys_frailty_status_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```


### (WIP) Variable 2: Comorbidity Burden

**Variable Definition:**

**Summary:**

## (WIP) Organ Failure Trajectory -- Systematic DAG

**Variable Definition:**

**Summary:**



## (WIP) Delirium -- Systematic DAG

**Variable Definition:**

**Summary:**

## Delirium -- Streamlined DAG

Currently calculated the same as Systematic DAG: Delirium (see above).


## (WIP) Gastrointestinal Bleeding -- Streamlined DAG

**Variable Definition:**

**Summary:**

## (WIP) Major Recent Surgery -- Streamlined DAG

**Variable Definition:**

**Summary:**
