---
title: "APS Aim 7 Derived Variables Summary"
output:
  github_document:
    toc: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# Libraries
library('ggplot2')
library('dplyr')
library('tidyr')
library('knitr')
library('gt')

## Get support functions
source('support_functions.R')

## Load data from N=500 APS cohort
## provides "data", "dictionary" and "codebook" in the working environment
load(file = '../aps-data/20250731_data.RData')
```

```{r, echo = FALSE}
# Source variable derivation code
source("R/variables.R")
```

## (WIP) Hypotension Severity -- Systematic DAG

**Variable Definition:**

**Summary:**


## Hypotension Severity -- Streamlined DAG

Currently calculated the same as Systematic DAG: Hypotension Severity (see above).

## (WIP) Baseline Performance Status -- Systematic DAG

### Variable 1: Frailty Status

**Variable Definition:**

Derived from `frailty_base`:

- 0 = Not performed
- 1 = Very Fit
- 2 = Fit
- 3 = Managing Well
- 4 = Living with very mild frailty
- 5 = Living with mild frailty
- 6 = Living with moderate frailty
- 7 = Living with severe frailty
- 8 = Living with very severe frailty
- 9 = Terminally ill

**Summary:**

```{r}
data |>
  filter(event_label == "Patient/Surrogate Interview") |>
  left_join(
    get_code_label_map('frailty_base', dictionary),
    by ='frailty_base'
    ) |>
  mutate(sys_frailty_status_0 = calc_sys_frailty_status_0(
    frailty_base_code = frailty_base_code,
    frailty_perf = frailty_perf
  )) |>
  count(sys_frailty_status_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```


### (WIP, BLOCKED) Variable 2: Comorbidity Burden

**Variable Definition:**

**Summary:**

## (WIP - STARTED) Organ Failure Trajectory -- Systematic DAG

**Variable Definition:**

Two variables:

1. Total Day 0 SOFA score (`sofa_total_day_0`)
   - Use `NA` if value is missing

2. Total Day -1 SOFA score (`sofa_total_day_m1`)
   - Use `NA` if value is missing
   - Use `99` if value is not applicable (i.e., not in hospital on day -1)

**Summary:**

```{r}
data_with_organ_failure <- data |>
  filter(event_label == 'PLACEHOLDER') |>
  mutate(
    sofa_total_day_0 = calc_sys_organ_failure_trajectory(
      day = 0,
      daily_pa02_lowest = daily_pa02_lowest_0,
      daily_resp_lowest_pao2 = daily_resp_lowest_pao2_0,
      daily_fio2_lowest_pao2 = daily_fio2_lowest_pao2_0,
      daily_o2_lowest_pao2 = daily_o2_lowest_pao2_0,
      daily_spo2_lowest = daily_spo2_lowest_0,
      daily_resp_lowest = daily_resp_lowest_0,
      daily_fio2_lowest = daily_fio2_lowest_0,
      daily_o2_lowest = daily_o2_lowest_0,
      daily_platelet_8a = daily_platelet_8a_0,
      daily_tbili_8a = daily_tbili_8a_0,
      daily_sbp_8a = daily_sbp_8a_0,
      daily_dbp_8a = daily_dbp_8a_0,
      daily_dopa_dos_8a_mcg = daily_dopa_dos_8a_0_mcg,
      daily_dopa_dos_8a_mcgkg = daily_dopa_dos_8a_0_mcgkg,
      daily_dobuta_8a_mcg = daily_dobuta_8a_0_mcg,
      daily_dobuta_8a_mcgkg = daily_dobuta_8a_0_mcgkg,
      daily_epi_dose_8a_mcg = daily_epi_dose_8a_0_mcg,
      daily_epi_dose_8a_mcgkg = daily_epi_dose_8a_0_mcgkg,
      daily_ne_dose_8a_mcg = daily_ne_dose_8a_0_mcg,
      daily_ne_dose_8a_mcgkg = daily_ne_dose_8a_0_mcgkg,
      m_weight_kg = m_weight_kg,
      daily_gcs_8a = daily_gcs_8a_0,
      daily_cr_8a = daily_cr_8a_0
    ),
    sofa_total_day_m1 = calc_sys_organ_failure_trajectory(
      day = -1,
      daily_pa02_lowest = daily_pa02_lowest_m1,
      daily_resp_lowest_pao2 = daily_resp_lowest_pao2_m1,
      daily_fio2_lowest_pao2 = daily_fio2_lowest_pao2_m1,
      daily_o2_lowest_pao2 = daily_o2_lowest_pao2_m1,
      daily_spo2_lowest = daily_spo2_lowest_m1,
      daily_resp_lowest = daily_resp_lowest_m1,
      daily_fio2_lowest = daily_fio2_lowest_m1,
      daily_o2_lowest = daily_o2_lowest_m1,
      daily_platelet_8a = daily_platelet_8a_m1,
      daily_tbili_8a = daily_tbili_8a_m1,
      daily_sbp_8a = daily_sbp_8a_m1,
      daily_dbp_8a = daily_dbp_8a_m1,
      daily_dopa_dos_8a_mcg = daily_dopa_dos_8a_m1_mcg,
      daily_dopa_dos_8a_mcgkg = daily_dopa_dos_8a_m1_mcgkg,
      daily_dobuta_8a_mcg = daily_dobuta_8a_m1_mcg,
      daily_dobuta_8a_mcgkg = daily_dobuta_8a_m1_mcgkg,
      daily_epi_dose_8a_mcg = daily_epi_dose_8a_m1_mcg,
      daily_epi_dose_8a_mcgkg = daily_epi_dose_8a_m1_mcgkg,
      daily_ne_dose_8a_mcg = daily_ne_dose_8a_m1_mcg,
      daily_ne_dose_8a_mcgkg = daily_ne_dose_8a_m1_mcgkg,
      m_weight_kg = m_weight_kg,
      daily_gcs_8a = daily_gcs_8a_m1,
      daily_cr_8a = daily_cr_8a_m1
    )
  )

data_with_organ_failure |>
  count(sofa_total_day_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )

data_with_organ_failure |>
  count(sofa_total_day_m1) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

Day 0: These records have missing SOFA scores because TODO

```{r}
data_with_organ_failure |>
  filter(is.na(sofa_total_day_0)) |>
  select(
    record_id,
    daily_pa02_lowest_0,
    daily_resp_lowest_pao2_0,
    daily_fio2_lowest_pao2_0,
    daily_o2_lowest_pao2_0,
    daily_spo2_lowest_0,
    daily_resp_lowest_0,
    daily_fio2_lowest_0,
    daily_o2_lowest_0,
    daily_platelet_8a_0,
    daily_tbili_8a_0,
    daily_sbp_8a_0,
    daily_dbp_8a_0,
    daily_gcs_8a_0,
    daily_cr_8a_0
  ) |>
  gt()
```

Day -1: These records have `sofa_total_day_m1 == 99` because patient was not in hospital on Day -1

```{r}
data_with_organ_failure |>
  filter(sofa_total_day_m1 == 99) |>
  select(
    record_id
  ) |>
  gt()
```

Day -1: These records have missing SOFA scores because TODO

```{r}
data_with_organ_failure |>
  filter(is.na(sofa_total_day_m1)) |>
  select(
    record_id,
    daily_pa02_lowest_m1,
    daily_resp_lowest_pao2_m1,
    daily_fio2_lowest_pao2_m1,
    daily_o2_lowest_pao2_m1,
    daily_spo2_lowest_m1,
    daily_resp_lowest_m1,
    daily_fio2_lowest_m1,
    daily_o2_lowest_m1,
    daily_platelet_8a_m1,
    daily_tbili_8a_m1,
    daily_sbp_8a_m1,
    daily_dbp_8a_m1,
    daily_gcs_8a_m1,
    daily_cr_8a_m1
  ) |>
  gt()
```


## Delirium -- Systematic DAG

**Variable Definition:**

Three-level variable:

- 0 = CAM done and not present (negative on all assessments)
- 1 = CAM done and present (positive at least once)
- 2 = CAM not done

**Summary:**

```{r}
data_with_delirium <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    sys_delirium_0 = calc_sys_delirium_0(
      cam_0 = cam_0,
      cam_m1 = cam_m1,
      cam_m2 = cam_m2,

      lowrass_orres_0 = lowrass_orres_0,
      lowrass_orres_m1 = lowrass_orres_m1,
      lowrass_orres_m2 = lowrass_orres_m2,

      highestrass_orres_0 = highestrass_orres_0,
      highestrass_orres_m1 = highestrass_orres_m1,
      highestrass_orres_m2 = highestrass_orres_m2
    )
  )

data_with_delirium |>
  count(sys_delirium_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Delirium -- Streamlined DAG

Currently calculated the same as Systematic DAG: Delirium (see above).


## Presence of Sepsis Syndrome -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Syndrome not present OR syndrome not present on or before Day 0
- 1 = Syndrome present AND syndrome present on or before Day 0
- 99 = Unknown

**Summary:**

```{r}
data_with_sepsis <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  mutate(
    sys_sepsis_0 = calc_sys_sepsis_0(
      sepsis_present,
      sepsis_clinical_judgement
    )
  )

data_with_sepsis |>
  count(sys_sepsis_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because they were missing (NA) `sepsis_present` and have `sepsis_clinical_judgement == 'Unknown'`. These should be queried.

```{r}
data_with_sepsis |>
  filter(sys_sepsis_0 == 99) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement
  ) |>
  gt()
```

This record was missing (NA) `sepsis_present` but had `sepsis_clinical_judgement == 'Yes'`. This should be queried.

```{r}
data_with_sepsis |>
  filter(is.na(sys_sepsis_0)) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement
  ) |>
  gt()
```

## Presence of ARDS Syndrome -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Syndrome not present OR syndrome not present on or before Day 0
- 1 = Syndrome present AND syndrome present on or before Day 0
- 99 = Unknown

**Summary:**

```{r}
data_with_ards <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  mutate(
    sys_ards_0 = calc_sys_ards_0(
      ards_present,
      ards_clinical_judgement
    )
  )

data_with_ards |>
  count(sys_ards_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

There are no unknown or missing values for this variable.


## Presence of ARDS Syndrome -- Streamlined DAG

Currently calculated the same as Systematic DAG: Presence of ARDS Syndrome (see above).

## Presence of Pneumonia Syndrome -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Syndrome not present on or before Day 0
- 1 = Syndrome present on or before Day 0
- 99 = Unknown

**Summary:**

```{r}
data_with_pneumonia <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  mutate(
    sys_pneumonia_0 = calc_sys_pneumonia_0(
      pna_clinical_judgement
    )
  )

data_with_pneumonia |>
  count(sys_pneumonia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```
### Unknown/Missing Values

These records have `pna_clinical_judgement == 'Unknown'`:

```{r}
data_with_pneumonia |>
  filter(sys_pneumonia_0 == 99) |>
  select(
    record_id,
    pna_clinical_judgement
  ) |>
  gt()
```

## Presence of Pneumonia Syndrome -- Streamlined DAG

Currently calculated the same as Systematic DAG: Presence of Pneumonia Syndrome (see above).

## Septic Shock Variables (Systematic and Streamlined)
```{r}
# Get weight data
data_with_weight <- data |>
  filter(event_label == 'Day 0') |>
  select(
    record_id,
    m_weight_kg
  )

# Get vasopressor data
data_with_vasopressors <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  select(
    record_id,
    daily_vasopressors_0___0,
    daily_sbp_8a_0,
    daily_dbp_8a_0,
    daily_ne_dose_8a_0_mcg,
    daily_ne_dose_8a_0_mcgkg,
    daily_epi_dose_8a_0_mcg,
    daily_epi_dose_8a_0_mcgkg,
    daily_phen_dose_8a_0_mcg,
    daily_phen_dos_8a_0_mcgkg,
    daily_vaso_dose_8a_0,
    daily_dopa_dose_8a_0_mcg,
    daily_dopa_dos_8a_0_mcgkg,
    daily_dobuta_8a_0_mcg,
    daily_dobuta_8a_0_mcgkg,
    daily_ang2_8a_0_mcg,
    daily_ang2_8a_0_mcgkg,
    daily_milr_8a_0_mcg,
    daily_milr_8a_0_mcgkg
  )

# Get sepsis data
data_with_sepsis <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement
  )
```
## (NEW) Septic Shock -- Systematic DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Septic shock not present on/before Day 0
- 1 = Septic shock present on/before Day 0 AND on vasopressor at 8am on Day 0 AND vasopressor dose > 0.5 norepinephrine equivalents
- 99 = Unknown

**Summary:**

```{r}
data_with_sys_septic_shock <- data_with_weight |>
  left_join(data_with_vasopressors, by = 'record_id') |>
  left_join(data_with_sepsis, by = 'record_id') |>
  mutate(
    sys_septic_shock_0 = calc_sys_septic_shock_0(
      sepsis_present = sepsis_present,
      sepsis_clinical_judgement = sepsis_clinical_judgement,

      daily_vasopressors_0___0 = daily_vasopressors_0___0,
      daily_sbp_8a_0 = daily_sbp_8a_0,
      daily_dbp_8a_0 = daily_dbp_8a_0,
      daily_ne_dose_8a_0_mcg = daily_ne_dose_8a_0_mcg,
      daily_ne_dose_8a_0_mcgkg = daily_ne_dose_8a_0_mcgkg,
      daily_epi_dose_8a_0_mcg = daily_epi_dose_8a_0_mcg,
      daily_epi_dose_8a_0_mcgkg = daily_epi_dose_8a_0_mcgkg,
      daily_phen_dose_8a_0_mcg = daily_phen_dose_8a_0_mcg,
      daily_phen_dos_8a_0_mcgkg = daily_phen_dos_8a_0_mcgkg,
      daily_vaso_dose_8a_0 = daily_vaso_dose_8a_0,
      daily_dopa_dose_8a_0_mcg = daily_dopa_dose_8a_0_mcg,
      daily_dopa_dos_8a_0_mcgkg = daily_dopa_dos_8a_0_mcgkg,
      daily_dobuta_8a_0_mcg = daily_dobuta_8a_0_mcg,
      daily_dobuta_8a_0_mcgkg = daily_dobuta_8a_0_mcgkg,
      daily_ang2_8a_0_mcg = daily_ang2_8a_0_mcg,
      daily_ang2_8a_0_mcgkg = daily_ang2_8a_0_mcgkg,
      daily_milr_8a_0_mcg = daily_milr_8a_0_mcg,
      daily_milr_8a_0_mcgkg = daily_milr_8a_0_mcgkg,

      m_weight_kg = m_weight_kg
    )
  )

data_with_sys_septic_shock |>
  count(sys_septic_shock_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because they have `sepsis_clinical_judgement == 'Unknown'` and are missing `sepsis_present`. They are all also recorded as Unknown in "Presence of Sepsis Syndrome Systematic DAG" (above). These should be queried.

```{r}
data_with_sys_septic_shock |>
  filter(sys_septic_shock_0 == 99) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement,
    daily_vasopressors_0___0,
    daily_sbp_8a_0,
    daily_dbp_8a_0,
    daily_ne_dose_8a_0_mcg,
    daily_ne_dose_8a_0_mcgkg,
    daily_epi_dose_8a_0_mcg,
    daily_epi_dose_8a_0_mcgkg,
    daily_phen_dose_8a_0_mcg,
    daily_phen_dos_8a_0_mcgkg,
    daily_vaso_dose_8a_0,
    daily_dopa_dose_8a_0_mcg,
    daily_dopa_dos_8a_0_mcgkg,
    daily_dobuta_8a_0_mcg,
    daily_dobuta_8a_0_mcgkg,
    daily_ang2_8a_0_mcg,
    daily_ang2_8a_0_mcgkg,
    daily_milr_8a_0_mcg,
    daily_milr_8a_0_mcgkg,
    m_weight_kg
  ) |>
  gt()
```

No missing records for this variable.

## (NEW) Septic Shock -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 = Septic shock not present on/before Day 0
- 1 = Septic shock present on/before Day 0 AND on vasopressor at 8am on Day 0
- 99 = Unknown

**Summary:**

```{r}
data_with_str_septic_shock <- data_with_vasopressors |>
  left_join(data_with_sepsis, by = 'record_id') |>
  mutate(
    str_septic_shock_0 = calc_str_septic_shock_0(
      sepsis_present = sepsis_present,
      sepsis_clinical_judgement = sepsis_clinical_judgement,
      daily_vasopressors_0___0 = daily_vasopressors_0___0
    )
  )

data_with_str_septic_shock |>
  count(str_septic_shock_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because they have `sepsis_clinical_judgement == 'Unknown'` and are missing `sepsis_present`. They are all also recorded as Unknown in "Presence of Sepsis Syndrome Systematic DAG" (above). These should be queried.

```{r}
data_with_str_septic_shock |>
  filter(str_septic_shock_0 == 99) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement,
    daily_vasopressors_0___0
  ) |>
  gt()
```

These record were missing (NA) because they are missing `sepsis_present` and `sepsis_clinical_judgement` and `daily_vasopressors_0___0` is unchecked (indicated patient is not on vasopressors).

```{r}
data_with_str_septic_shock |>
  filter(is.na(str_septic_shock_0)) |>
  select(
    record_id,
    sepsis_present,
    sepsis_clinical_judgement,
    daily_vasopressors_0___0
  ) |>
  gt()
```

## (NEW) Gastrointestinal Bleeding -- Streamlined DAG

**Variable Definition:**

Continuous variable summing total number of packed red blood cell units
transfused on study days -2 to 0.

**Summary:**

```{r}
data_with_gi_bleeding <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_gi_bleeding_0 = calc_str_gi_bleeding_0(
      blood_prbc_units_m2 = blood_prbc_units_m2,
      blood_prbc_units_m1 = blood_prbc_units_m1,
      blood_prbc_units_0 = blood_prbc_units_0,
      daily_blood_product_m2 = daily_blood_product_m2,
      daily_blood_product_m1 = daily_blood_product_m1,
      daily_blood_product_0 = daily_blood_product_0,
      blood_product_spec_m2___1 = blood_product_spec_m2___1,
      blood_product_spec_m1___1 = blood_product_spec_m1___1,
      blood_product_spec_0___1 = blood_product_spec_0___1
    )
  )

data_with_gi_bleeding |>
  select(str_gi_bleeding_0) |>
  filter(!is.na(str_gi_bleeding_0) & str_gi_bleeding_0 > -1) |>
  ggplot(aes(str_gi_bleeding_0)) +
    geom_histogram(bins = 40)
```



### Unknown/Missing Values

This many records are missing (NA):

```{r}
data_with_gi_bleeding |>
  filter(is.na(str_gi_bleeding_0)) |>
  count()
```

This is because of an invalid branching logic on one of the three days (typically Day -2), which causes the whole count to be NA.

```{r}
data_with_gi_bleeding |>
  filter(is.na(str_gi_bleeding_0)) |>
  select(
    record_id,

    trx_0,
    daily_blood_product_0,
    blood_product_spec_0___1,
    blood_prbc_units_0,

    trx_m1,
    daily_blood_product_m1,
    blood_product_spec_m1___1,
    blood_prbc_units_m1,

    trx_m2,
    daily_blood_product_m2,
    blood_product_spec_m2___1,
    blood_prbc_units_m2
  ) |>
  gt()
```

## Major Recent Surgery -- Streamlined DAG

**Variable Definition:**

Binary indicator variable:

- 0 = No surgery on Day -2, Day -1, AND Day 0
- 1 = Surgery on Day -2, Day -1, OR Day 0

**Note:** The surgery description fields aren't necessarily part of this variable, but they should be in the dataset, since they are defined in the dictionary. We will need to follow up to find out how we can get access to those fields. They may have been removed as part of de-identification.

**Summary:**

```{r}
data_with_major_surgery <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_major_surgery_0 = calc_str_major_surgery_0(
      daily_surgery_m2,
      daily_surgery_m1,
      daily_surgery_0
    )
  )

data_with_major_surgery |>
  count(str_major_surgery_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

No missing values for Major Recent Surgery.

## Dementia -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = No dementia history
- 1 = Dementia history
- 99 = Unknown

**Summary:**

```{r}
data_with_dementia <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_dementia_0 = calc_str_dementia_0(
      m_neurologic_conditions___1,
      m_neurologic
    )
  )

data_with_dementia |>
  count(str_dementia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because `m_neurologic == "Unknown"`:

```{r}
data_with_dementia |>
  filter(str_dementia_0 == 99) |>
  select(
    record_id,
    m_neurologic_conditions___1,
    m_neurologic
  ) |>
  gt()
```

One record was missing (NA) `m_neurologic`, but this is the same record missing from the N=500 dataset and does not need to be queried further.

## Acute Allergic Reaction -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = No suspected anaphylaxis if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected anaphylaxis if `organ_dysnfx_cause` = 2

**NOTE:** The variables "Acute Allergic Reaction", "Diffuse Alveolar Hemorrhage", "Acute Inflammatory Drug Toxicity", and "Acute Cryptogenic Organizing Pneumonia" are currently identical. This is because they require additional free-text information paired with `organ_dysnfx_cause == 2` to determine whether a patient meets criteria. These should be quick information gathered from physicians, but the team will need to determine how to best proceed.

**Summary:**

```{r}
data_with_allergic <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_acute_allergic_reaction_0 = calc_str_acute_allergic_reaction_0(
      organ_dysfnx_cause_code
    )
  )

data_with_allergic |>
  count(str_acute_allergic_reaction_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Diffuse Alveolar Hemorrhage -- Streamlined DAG

**Variable Definition:**

Binary variable (likely not used in primary analysis):

- 0 = No DAH if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected DAH if `organ_dysnfx_cause` = 2

**NOTE:** The variables "Acute Allergic Reaction", "Diffuse Alveolar Hemorrhage", "Acute Inflammatory Drug Toxicity", and "Acute Cryptogenic Organizing Pneumonia" are currently identical. This is because they require additional free-text information paired with `organ_dysnfx_cause == 2` to determine whether a patient meets criteria. These should be quick information gathered from physicians, but the team will need to determine how to best proceed.

**Summary:**

```{r}
data_with_dah <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_dah_0 = calc_str_dah_0(
      organ_dysfnx_cause_code
    )
  )

data_with_dah |>
  count(str_dah_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Acute Inflammatory Drug Toxicity -- Streamlined DAG

**Variable Definition:**

Binary variable (likely not used in primary analysis):

- 0 = No acute inflammatory drug reaction if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected acute inflammatory drug reaction if `organ_dysnfx_cause` = 2

**NOTE:** The variables "Acute Allergic Reaction", "Diffuse Alveolar Hemorrhage", "Acute Inflammatory Drug Toxicity", and "Acute Cryptogenic Organizing Pneumonia" are currently identical. This is because they require additional free-text information paired with `organ_dysnfx_cause == 2` to determine whether a patient meets criteria. These should be quick information gathered from physicians, but the team will need to determine how to best proceed.

**Summary:**

```{r}
data_with_drug_toxicity <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_drug_toxicity_0 = calc_str_drug_toxicity_0(
      organ_dysfnx_cause_code
    )
  )

data_with_drug_toxicity |>
  count(str_drug_toxicity_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## Acute Cryptogenic Organizing Pneumonia -- Streamlined DAG

**Variable Definition:**

Binary variable (likely not used in primary analysis):

- 0 = No acute COP if `organ_dysnfx_cause` = 1, 3, OR 99
- 1 = Suspected acute COP if `organ_dysnfx_cause` = 2

**NOTE:** The variables "Acute Allergic Reaction", "Diffuse Alveolar Hemorrhage", "Acute Inflammatory Drug Toxicity", and "Acute Cryptogenic Organizing Pneumonia" are currently identical. This is because they require additional free-text information paired with `organ_dysnfx_cause == 2` to determine whether a patient meets criteria. These should be quick information gathered from physicians, but the team will need to determine how to best proceed.

**Summary:**

```{r}
data_with_cop <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map('organ_dysfnx_cause', dictionary),
    by = 'organ_dysfnx_cause'
  ) |>
  mutate(
    str_cop_0 = calc_str_cop_0(
      organ_dysfnx_cause_code
    )
  )

data_with_cop |>
  count(str_cop_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable.

## SCAP Criterion Respiratory Rate -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 daily value. If that's not available, use last
value carried forward from Day -1 or Day -2.

- 0 = Respiratory rate ≤ 30
- 1 = Respiratory rate > 30

Respiratory rate is based on the respiratory support type. Check the support type for Day 0 and look for the associated respiratory rate variable. If missing, repeat for Day -1 then again for Day -2. If still missing after that, treat as missing (NA). For ECMO without IMV (2), No resp support at all (7), Unknown (99) use `highrr_vsorres` (for all days, even though only measured on Day 0).

**Summary:**

```{r}
data_with_highrr_vsorres <- data |>
  filter(event_label == 'Day 0') |>
  select(
    record_id,
    highrr_vsorres
  )

data_with_scap_rr <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  left_join(
    get_code_label_map("daily_resp_8a_0", dictionary),
    by = "daily_resp_8a_0"
  ) |>
  left_join(
    get_code_label_map("daily_resp_8a_m1", dictionary),
    by = "daily_resp_8a_m1"
  ) |>
  left_join(
    get_code_label_map("daily_resp_8a_m2", dictionary),
    by = "daily_resp_8a_m2"
  ) |>
  select(
    record_id,

    daily_resp_8a_0_code,
    daily_resp_8a_m1_code,
    daily_resp_8a_m2_code,

    daily_hfnc_rr_8a_0,
    daily_hfnc_rr_8a_m1,
    daily_hfnc_rr_8a_m2,

    daily_niv_rr_8a_0,
    daily_niv_rr_8a_m1,
    daily_niv_rr_8a_m2,

    daily_standard_rr_8a_0,
    daily_standard_rr_8a_m1,
    daily_standard_rr_8a_m2,

    daily_resp_rate_8a_0,
    daily_resp_rate_8a_m1,
    daily_resp_rate_8a_m2
  ) |>
  left_join(
    data_with_highrr_vsorres,
    by = "record_id"
  ) |>
  mutate(
    str_scap_rr_0 = calc_str_scap_rr_0(
      daily_resp_8a_0_code,
      daily_resp_8a_m1_code,
      daily_resp_8a_m2_code,

      daily_hfnc_rr_8a_0,
      daily_hfnc_rr_8a_m1,
      daily_hfnc_rr_8a_m2,

      daily_niv_rr_8a_0,
      daily_niv_rr_8a_m1,
      daily_niv_rr_8a_m2,

      daily_standard_rr_8a_0,
      daily_standard_rr_8a_m1,
      daily_standard_rr_8a_m2,

      daily_resp_rate_8a_0,
      daily_resp_rate_8a_m1,
      daily_resp_rate_8a_m2,

      highrr_vsorres
    )
  )

data_with_scap_rr |>
  count(str_scap_rr_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

There are 3 missing (NA) records for this variable:

```{r}
data_with_scap_rr |>
  filter(is.na(str_scap_rr_0)) |>
  select(record_id) |>
  gt()
```

These reasons for missingness are similar for the records `45-0011` and `45-0015`. Both records have missing values that should be queried.

- **Day 0:** Both missing a measurement for `daily_resp_rate_8a_0` in violation of the branching logic. Both have a `daily_resp_8a_0` (respiratory support type) of `3 (IMV without ECMO)`. According to the branching logic, this means they should both have a value for `daily_imv_mode_8a_0`. Record `45-0011` has a value, while `45-0015` does not. Record `45-0011` has `daily_imv_mode_8a_0 == 3 (PRVC/APV)`. According to the branching logic, this record should then have a `daily_resp_rate_8a_0` measurement, which it does not.
- **Day -1:** Record `45-0015` has `daily_resp_8a_0 == 3 (IMV without ECMO)`, but with the same problems as Day 0. However, record `45-0011` has `daily_resp_8a_0 == 6 (Standard flow)`. According to the branching logic, this record should then have a value for `daily_resp_8a_m1`, but it is missing.
- **Day -2:** Both records are missing `daily_resp_8a_m2` and everything that follows.


```{r}
data |>
  filter(record_id %in% c('45-0011', '45-0015')) |>
  left_join(
    get_code_label_map("daily_resp_8a_0", dictionary),
    by = "daily_resp_8a_0"
  ) |>
  left_join(
    get_code_label_map("daily_resp_8a_m1", dictionary),
    by = "daily_resp_8a_m1"
  ) |>
  left_join(
    get_code_label_map("daily_resp_8a_m2", dictionary),
    by = "daily_resp_8a_m2"
  ) |>
  filter(event_label %in% c("Daily In-Hospital Forms")) |>
  select(
    record_id,

    # Day 0
    daily_resp_8a_0_code,
    daily_resp_8a_0,
    daily_imv_mode_8a_0,
    daily_resp_rate_8a_0,

    # Day -1
    daily_resp_8a_m1_code,
    daily_resp_8a_m1,
    daily_resp_rate_8a_m1,
    daily_standard_rr_8a_m1,

    # Day -2
    daily_resp_8a_m2_code,
    daily_resp_8a_m2
  ) |>
  gt()
```

Record `63-0008` is different, in that it has `dailysofa_perf_* == 'Not Available'` for all three days. This technically satisfies the branching logic for having a missing `daily_resp_8a_0`. We either need to query this or adapt the variable definition to account for this. **Note:** If we choose to assign `dailysofa_perf_* == 'Not Available'` to `highrr_vsorres` (treating it like "no respiratory support"), then both of the other missing records (described above) will also be classified that way as they both have `dailysofa_perf_m2 == 'Not Available'`.

```{r}
data |>
  filter(record_id == '63-0008') |>
  filter(event_label %in% c("Daily In-Hospital Forms")) |>
  select(
    record_id,

    dailysofa_perf_0,
    daily_resp_8a_0,
    dailysofa_perf_m1,
    daily_resp_8a_m1,
    dailysofa_perf_m2,
    daily_resp_8a_m2
  ) |>
  gt()
```


```{r}
data_with_scap_rr |>
  filter(is.na(str_scap_rr_0)) |>
  filter(record_id == '63-0008') |>
  select(
    record_id,

    highrr_vsorres,

    daily_resp_8a_0_code,
    # daily_resp_8a_m1_code,
    # daily_resp_8a_m2_code,

    daily_hfnc_rr_8a_0,
    # daily_hfnc_rr_8a_m1,
    # daily_hfnc_rr_8a_m2,

    daily_niv_rr_8a_0,
    # daily_niv_rr_8a_m1,
    # daily_niv_rr_8a_m2,

    daily_standard_rr_8a_0,
    # daily_standard_rr_8a_m1,
    # daily_standard_rr_8a_m2,

    daily_resp_rate_8a_0,
    # daily_resp_rate_8a_m1,
    # daily_resp_rate_8a_m2
  ) |>
  gt()
```

## SCAP Criterion BUN Value -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 daily value. If that's not available, use last
value carried forward from Day -1 or Day -2:

- 0 = BUN <= 30 mg/dL
- 1 = BUN > 30 mg/dL

**Summary:**

```{r}
data_with_scap_bun <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_bun_0 = calc_str_scap_bun_0(
      daily_bun_8a_0,
      daily_bun_8a_m1,
      daily_bun_8a_m2
    )
  )

data_with_scap_bun |>
  count(str_scap_bun_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were missing (NA). Most of these are due to valid branching logic (daily_bun was 'Not Collected'), but a few records were missing all `daily_bun_nc_*`/`daily_bun_8a_*` pairs, which violates the branching logic (should be mutually exclusive). These should be queried.

```{r}
data_with_scap_bun |>
  filter(is.na(str_scap_bun_0)) |>
  select(
    record_id,

    daily_bun_nc_0,
    daily_bun_8a_0,

    daily_bun_nc_m1,
    daily_bun_8a_m1,

    daily_bun_nc_m2,
    daily_bun_8a_m2
  ) |>
  gt()
```

## SCAP Criterion Acidosis -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 daily lowest. If that's not available, use last
value carried forward from Day -1 or Day -2:

- 0 = pH ≥ 7.30
- 1 = pH < 7.30

**Summary:**

```{r}
data_with_scap_acidosis <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_acidosis_0 = calc_str_scap_acidosis_0(
      daily_ph_lowest_0,
      daily_ph_lowest_m1,
      daily_ph_lowest_m2
    )
  )

data_with_scap_acidosis |>
  count(str_scap_acidosis_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

After checking the branching logic, it appears there are no unknown or missing values for this variable. That is, in part, because we treat missing `daily_ph_lowest_*` value as `0 (no Acidosis)`.

## SCAP Criterion Bilateral Opacities -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = (all) `*_opacity != 2`
- 1 = (any) `*_opacity == 2`

**Summary:**

```{r}
data_with_scap_bilat_opac <- data |>
  filter(event_label == 'Syndrome Adjudication') |>
  left_join(
    get_code_label_map("cxr_dm2_opacity", dictionary),
    by = "cxr_dm2_opacity"
  ) |>
  left_join(
    get_code_label_map("ct_dm2_opacity", dictionary),
    by = "ct_dm2_opacity"
  ) |>
  left_join(
    get_code_label_map("cxr_dm1_opacity", dictionary),
    by = "cxr_dm1_opacity"
  ) |>
  left_join(
    get_code_label_map("ct_dm1_opacity", dictionary),
    by = "ct_dm1_opacity"
  ) |>
  left_join(
    get_code_label_map("cxr_d0_opacity", dictionary),
    by = "cxr_d0_opacity"
  ) |>
  left_join(
    get_code_label_map("ct_d0_opacity", dictionary),
    by = "ct_d0_opacity"
  ) |>
  mutate(
    str_scap_bilateral_opacities_0 = calc_str_scap_bilateral_opacities_0(
      cxr_dm2_available,
      cxr_dm2_opacity_code,
      ct_dm2_available,
      ct_dm2_opacity_code,
      cxr_dm1_available,
      cxr_dm1_opacity_code,
      ct_dm1_available,
      ct_dm1_opacity_code,
      cxr_d0_available,
      cxr_d0_opacity_code,
      ct_d0_available,
      ct_d0_opacity_code
    )
  )

data_with_scap_bilat_opac |>
  count(str_scap_bilateral_opacities_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were missing (NA) imaging data for one or more days and should be queried.

```{r}
data_with_scap_bilat_opac |>
  filter(is.na(str_scap_bilateral_opacities_0)) |>
  select(
    record_id,
    cxr_dm2_available,
    cxr_dm2_opacity,
    ct_dm2_available,
    ct_dm2_opacity,
    cxr_dm1_available,
    cxr_dm1_opacity,
    ct_dm1_available,
    ct_dm1_opacity,
    cxr_d0_available,
    cxr_d0_opacity,
    ct_d0_available,
    ct_d0_opacity
  ) |>
  gt()
```

## SCAP Criterion Leukopenia -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 value from daily assessment data. If that's not
available, use last value carried forward from Day -1 or Day -2:

- 0 = WBC >= 4
- 1 = WBC < 4

**Summary:**

```{r}
data_with_scap_leukopenia <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_leukopenia_0 = calc_str_scap_leukopenia_0(
      daily_wbc_8a_0,
      daily_wbc_8a_m1,
      daily_wbc_8a_m2
    )
  )

data_with_scap_leukopenia |>
  count(str_scap_leukopenia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were missing (NA) because they are missing all `daily_wbc_nc_*`/`daily_wbc_8a_*` pairs. This is invalid branching logic, because each pair is supposed to be mutually exclusive.

```{r}
data_with_scap_leukopenia |>
  filter(is.na(str_scap_leukopenia_0)) |>
  select(
    record_id,
    daily_wbc_nc_0,
    daily_wbc_8a_0,

    daily_wbc_nc_m1,
    daily_wbc_8a_m1,

    daily_wbc_nc_m2,
    daily_wbc_8a_m2
  ) |>
  gt()
```

## SCAP Criterion Thrombocytopenia -- Streamlined DAG

**Variable Definition:**

Binary variable using Day 0 value from daily assessment data. If that's not
available, use last value carried forward from Day -1 or Day -2:

- 0 = Platelets >= 100
- 1 = Platelets < 100

**Summary:**

```{r}
data_with_scap_thrombocyt <- data |>
  filter(event_label == 'Daily In-Hospital Forms') |>
  mutate(
    str_scap_thrombocytopenia_0 = calc_str_scap_thrombocytopenia_0(
      daily_platelet_8a_0,
      daily_platelet_8a_m1,
      daily_platelet_8a_m2
    )
  )

data_with_scap_thrombocyt |>
  count(str_scap_thrombocytopenia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were missing (NA) because they are missing all `daily_platelet_nc_*`/`daily_platelet_8a_*` pairs. This is invalid branching logic, because each pair is supposed to be mutually exclusive.

```{r}
data_with_scap_thrombocyt |>
  filter(is.na(str_scap_thrombocytopenia_0)) |>
  select(
    record_id,
    daily_platelet_nc_0,
    daily_platelet_8a_0,

    daily_platelet_nc_m1,
    daily_platelet_8a_m1,

    daily_platelet_nc_m2,
    daily_platelet_8a_m2
  ) |>
  gt()
```

## SCAP Criterion Hypothermia -- Streamlined DAG

**Variable Definition:**

Binary variable from the "Vital signs day 0" form. If that's not available,
use last value carried forward from Day -1 or Day -2:

- 0 = Temperature ≥ 35.0°C
- 1 = Temperature < 35.0°C

**Summary:**

```{r}
data_with_scap_hypothermia <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_scap_hypothermia_0 = calc_str_scap_hypothermia_0(
      lowtemp_vsorres
    )
  )

data_with_scap_hypothermia |>
  count(str_scap_hypothermia_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were missing (NA) `lowtemp_vsorres`. One record is the one missing from the N=500 dataset (`52-0023`) and doesn't need to be queried. The other has `vs_perf == 'No'` so the missing `lowtemp_vsorres` is valid branching logic, but since all patients should have their Day 0 vital signs, this should be queried.

```{r}
data_with_scap_hypothermia |>
  filter(is.na(str_scap_hypothermia_0)) |>
  select(
    record_id,
    vs_perf,
    lowtemp_vsorres
  ) |>
  gt()
```

## Chronic Neuromuscular Disease -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = No chronic neuromuscular disease history
- 1 = Chronic neuromuscular disease history
- 99 = Unknown

**Summary:**

```{r}
data_with_neuromuscular <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_neuromuscular_disease_0 = calc_str_neuromuscular_disease_0(
      m_neurologic_conditions___6,
      m_neurologic
    )
  )

data_with_neuromuscular |>
  count(str_neuromuscular_disease_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because `m_neurologic == 'Unknown'`:

```{r}
data_with_neuromuscular |>
  filter(str_neuromuscular_disease_0 == 99) |>
  select(
    record_id,
    m_neurologic_conditions___6,
    m_neurologic
  ) |>
  gt()
```

The only missing (NA) record is the same one missing from the N=500 dataset and doesn't need to be queried further.

## (WIP - STARTED) PSI Score -- Streamlined DAG

**Variable Definition:**

PSI score calculated per formula in the original reference
(https://pubmed.ncbi.nl.nih.gov/8995086/)

Inputs to PSI score:

- Age (age in years = points)
- Female sex (–10 points)
- Nursing home resident (+10 points)
- Congestive heart failure (+10 points)
- Cerebrovascular disease (+10 points)
- Neoplastic disease (+30 points)
- Renal disease (+10 points)
- Liver disease (+20 points)
- Altered mental status (+20 points)
- Pulse ≥ 125/min (+10 points)
- Respiratory rate ≥ 30/min (+20 points)
- Systolic blood pressure < 90 mm Hg (+20 points)
- Temperature < 35°C or ≥ 40°C (+15 points)
- Blood urea nitrogen ≥ 30 mg/dl (+20 points)
- Glucose ≥ 250 mg/dl (+10 points)
- Hematocrit < 30% (+10 points)
- Sodium < 130 mmol/liter (+20 points)
- PaO2 < 60 mm Hg (+10 points)
- Arterial pH < 7.35 (+30 points)
- Pleural effusion (+10 points)

**Summary:**

```{r}
data_with_psi <- data |>
  filter(event_label == 'PLACEHOLDER') |>
  mutate(
    str_psi_score_0 = calc_str_psi_score_0(
      age = age,
      sex = sex,
      prssrc = prssrc,
      m_cv_conditions = m_cv_conditions,
      m_neurologic_conditions = m_neurologic_conditions,
      m_cancer = m_cancer,
      m_kid_liver_conditions = m_kid_liver_conditions,
      cam_0 = cam_0,
      highhr_vsorres = highhr_vsorres,
      daily_resp_rate_8a_0 = daily_resp_rate_8a_0,
      lowsbp_vsorres = lowsbp_vsorres,
      lowtpr_vsorres = lowtpr_vsorres,
      daily_bun_8a_0 = daily_bun_8a_0,
      daily_glucose_8a_0 = daily_glucose_8a_0,
      daily_hct_8a_0 = daily_hct_8a_0,
      daily_sodium_8a_0 = daily_sodium_8a_0,
      daily_po2_8a_0 = daily_po2_8a_0,
      daily_ph_8a_0 = daily_ph_8a_0,
      daily_pleural_0 = daily_pleural_0
    )
  )

data_with_psi |>
  select(str_psi_score_0) |>
  filter(!is.na(str_psi_score_0) & str_psi_score_0 > -1) |>
  ggplot(aes(str_psi_score_0)) +
    geom_histogram(bins = 40)
```

### Unknown/Missing Values

These records have missing PSI scores because TODO

```{r}
data_with_psi |>
  filter(is.na(str_psi_score_0)) |>
  select(
    record_id,
    age,
    sex,
    prssrc,
    m_cv_conditions,
    m_neurologic_conditions,
    m_cancer,
    m_kid_liver_conditions,
    cam_0,
    highhr_vsorres,
    daily_resp_rate_8a_0,
    lowsbp_vsorres,
    lowtpr_vsorres,
    daily_bun_8a_0,
    daily_glucose_8a_0,
    daily_hct_8a_0,
    daily_sodium_8a_0,
    daily_po2_8a_0,
    daily_ph_8a_0,
    daily_pleural_0
  ) |>
  gt()
```



## Active Vasculitis -- Streamlined DAG

**Variable Definition:**

Binary variable:

- 0 = `m_rheum_conditions___8 == 'Unchecked'` OR (`m_immunosup_conditions___4 == 'Unchecked'` AND `mhccster == 'No'`)
- 1 = `m_rheum_conditions___8 == 'Checked'` AND (`m_immunosup_conditions___4 == 'Checked'` OR `mhccster == 'Yes'`)
- 99 = Unknown

**Summary:**

```{r}
data_with_vasculitis <- data |>
  filter(event_label == 'Day 0') |>
  mutate(
    str_vasculitis_0 = calc_str_vasculitis_0(
      mhrheumd,
      m_rheum_conditions___8,
      m_immunosuppression,
      m_immunosup_conditions___4,
      mhccster
    )
  )

data_with_vasculitis |>
  count(str_vasculitis_0) |>
  gt() |>
  grand_summary_rows(
    columns = n,
    fns = list(label = md("**TOTAL**"), id = "totals") ~ sum(.)
  )
```

### Unknown/Missing Values

These records were classified as `99 (Unknown)` because `mhrheumd`, `m_immunosuppression`, and/or `mhccster` are "Unknown".

```{r}
data_with_vasculitis |>
  filter(str_vasculitis_0 == 99) |>
  select(
    record_id,
    mhrheumd,
    m_rheum_conditions___8,
    m_immunosuppression,
    m_immunosup_conditions___4,
    mhccster
  ) |>
  gt()
```

The only missing (NA) record is the same one missing from the N=500 dataset and doesn't need to be queried further.
